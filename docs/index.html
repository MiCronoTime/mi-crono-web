<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono ‚Äî INICIO</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    :root{
      --bg:#121418;
      --card:#1b1f27;
      --card-2:#232a34;
      --text:#e8ecf1;
      --muted:#b5bdc9;
      --border:#2b3240;
      --accent:#5ea1ff;
      --accent-2:#7cc4ff;
      --danger:#ff5e7a;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #151924 0%, transparent 60%),
                  radial-gradient(1200px 800px at 120% 10%, #1a2030 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{color:var(--accent-2)}

    .wrap{max-width:980px;margin:0 auto;padding:20px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{font-size:24px;line-height:1}
    h1{margin:0;font-size:20px;letter-spacing:.06em}
    .uc{ text-transform: uppercase; letter-spacing:.04em }

    .grid{display:grid;gap:16px}
    .two{grid-template-columns:1fr}
    @media(min-width:940px){.two{grid-template-columns:1fr 1fr}}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      box-shadow:0 8px 30px rgba(0,0,0,.2);
    }
    .subcard{
      background:var(--card-2);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
    }

    h2{ margin:.3rem 0 12px 0; font-size:16px }
    label{display:block;margin:10px 0 6px;font-weight:600;color:var(--text)}

    input, textarea{
      width:100%;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#0f1217;
      color:var(--text);
      outline:none;
      transition:border-color .15s, box-shadow .15s;
      text-transform: uppercase;    /* visual may√∫sculas */
      letter-spacing:.02em;
    }
    input::placeholder, textarea::placeholder{ color:#80889a }
    input:focus, textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(94,161,255,.2);
    }
    textarea{ min-height:140px; resize:vertical }

    .row{display:flex;gap:10px;flex-wrap:wrap}

    /* Botones coherentes (uppercase + bold) */
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:11px 16px;border-radius:12px;
      border:1px solid var(--border);
      background:#0f1217;color:var(--text);
      cursor:pointer; user-select:none;
      transition:transform .05s ease, background .15s, border-color .15s, color .15s;
      text-transform: uppercase; font-weight:800; letter-spacing:.03em;
      font-size:14px; line-height:1;
      text-decoration:none;
    }
    .btn:hover{ background:#12161d }
    .btn:active{ transform:translateY(1px) }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#0b1220 }
    .btn.primary:hover{ background:var(--accent-2); border-color:var(--accent-2) }

    .muted{ color:var(--muted) }
    .ok{color:#7cffb6;font-weight:700}
    .warn{color:#ffd27e;font-weight:700}
    .err{color:var(--danger);font-weight:700}

    .help{font-size:12px;color:#9aa3b2;margin-top:6px}
    .links{margin-top:12px}
  </style>
</head>
<body class="wrap">
  <header class="top">
    <div class="brand">
      <div class="logo">‚è±Ô∏è</div>
      <h1 class="uc">Mi Crono Web</h1>
    </div>
    <a href="result.html" class="btn">üìÑ RESULTADOS</a>
  </header>

  <main class="grid two">
    <!-- CREAR / RESETEAR EVENTO -->
    <section class="card">
      <h2 class="uc">CREAR EVENTO</h2>

      <label for="code">C√≥digo del evento</label>
      <input id="code" placeholder="p.ej. TEST1" autocomplete="off"/>

      <label for="names">Participantes (uno por l√≠nea, en orden de salida)</label>
      <textarea id="names" placeholder="CORREDOR 1&#10;CORREDOR 2&#10;CORREDOR 3"></textarea>
      <div class="help">Si el evento ya existe, <b>se RESETEA por completo</b> (borra participantes y tiempos) y se crean estos nuevos.</div>

      <div class="row" style="margin-top:12px">
        <button id="btnCreate" class="btn primary">GUARDAR EVENTO</button>
      </div>

      <div id="createMsg" class="muted" style="margin-top:12px">‚Äî</div>

      <div id="links" class="links row" style="display:none">
        <a id="lnkStart"  class="btn">üö¶ SALIDA</a>
        <a id="lnkFinish" class="btn">üèÅ META</a>
        <a id="lnkResult" class="btn">üìÑ RESULTADOS</a>
      </div>
    </section>

    <!-- UNIRSE A UN EVENTO -->
    <section class="card">
      <h2 class="uc">UNIRSE A UN EVENTO</h2>

      <label for="joinCode">C√≥digo</label>
      <input id="joinCode" placeholder="TEST1" autocomplete="off"/>

      <div class="row" style="margin-top:12px">
        <a id="joinStart"  class="btn">üö¶ SALIDA</a>
        <a id="joinFinish" class="btn">üèÅ META</a>
        <a id="joinResult" class="btn">üìÑ RESULTADOS</a>
      </div>

      <div class="subcard" style="margin-top:12px">
        <div class="help">Abre <b>SALIDA</b> en la salida y <b>META</b> en la llegada. Ambos con el mismo <b>c√≥digo</b>.</div>
      </div>
    </section>
  </main>

  <!-- Firebase + l√≥gica -->
  <script type="module">
    const $ = (id)=>document.getElementById(id);
    const pid = (i)=> 'p'+String(i).padStart(3,'0');

    // Forzar MAY√öSCULAS tambi√©n a nivel de datos
    const toUpperLive = (el)=> el && el.addEventListener('input', ()=> el.value = el.value.toUpperCase());
    toUpperLive($('code'));
    toUpperLive($('joinCode'));
    if ($('names')) $('names').addEventListener('input', ()=> $('names').value = $('names').value.toUpperCase());

    // Firebase CDN
    const { initializeApp, getApp, getApps } =
      await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
    const {
      getFirestore, doc, setDoc, getDoc, collection, query, orderBy, getDocs, deleteDoc, serverTimestamp
    } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');

    const firebaseConfig = {
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    $('btnCreate').onclick = async ()=>{
      const code = (($('code').value||'').trim().toUpperCase());
      const lines = (($('names').value||'').toUpperCase())
        .split('\n').map(s=>s.trim()).filter(Boolean);

      if(!code){ $('createMsg').textContent='Escribe un C√ìDIGO.'; $('createMsg').className='err'; return; }
      if(!lines.length){ $('createMsg').textContent='A√±ade al menos un PARTICIPANTE.'; $('createMsg').className='err'; return; }

      try{
        const eventRef = doc(db,'events',code);
        const existsSnap = await getDoc(eventRef);
        const partsCol = collection(eventRef,'participants');

        if(existsSnap.exists()){
          // === RESETEO COMPLETO ===
          // 1) Borrar todos los participantes
          const snap = await getDocs(query(partsCol, orderBy('order','asc')));
          const deletions = snap.docs.map(d=> deleteDoc(d.ref));
          await Promise.all(deletions);

          // 2) Reiniciar el documento del evento (sin conservar datos previos)
          await setDoc(eventRef,{
            code,
            startTS:null, stopTS:null,
            createdAt: existsSnap.data()?.createdAt || serverTimestamp(), // por si quieres mantener createdAt
            resetAt: serverTimestamp()                                   // marca del reseteo
          }, {merge:true});

          $('createMsg').textContent = 'Evento existente ‚Äî RESETEADO por completo.';
          $('createMsg').className = 'warn';
        } else {
          // === CREACI√ìN NUEVA ===
          await setDoc(eventRef,{
            code,
            startTS:null, stopTS:null,
            createdAt: serverTimestamp()
          }, {merge:true});
          $('createMsg').textContent = 'Evento creado.';
          $('createMsg').className = 'ok';
        }

        // 3) Crear los nuevos participantes desde 1
        let order=1;
        const { doc:docRef, setDoc:setSub } =
          await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');
        const writes = lines.map(name=>{
          const ref = docRef(partsCol, pid(order));
          const data = { order, name, startTS:null, stopTS:null };
          order++; return setSub(ref, data, {merge:true});
        });
        await Promise.all(writes);

        // Mensaje final
        $('createMsg').textContent += ` A√±adidos: ${lines.length}.`;
        $('createMsg').className = 'ok';

        // Enlaces listos
        $('links').style.display='';
        $('lnkStart').href  = `camera.html?code=${encodeURIComponent(code)}&mode=start`;
        $('lnkFinish').href = `camera.html?code=${encodeURIComponent(code)}&mode=finish`;
        $('lnkResult').href = `result.html?code=${encodeURIComponent(code)}`;
      }catch(e){
        $('createMsg').textContent = 'Error: '+(e.message||e);
        $('createMsg').className='err';
      }
    };

    // Unirse
    const openWith = (mode)=>()=>{ 
      const c=(($('joinCode').value||'').trim().toUpperCase());
      if(!c) return alert('Escribe un C√ìDIGO');
      location.href=`camera.html?code=${encodeURIComponent(c)}&mode=${mode}`;
    };
    $('joinStart').onclick  = openWith('start');
    $('joinFinish').onclick = openWith('finish');
    $('joinResult').onclick = ()=>{ 
      const c=(($('joinCode').value||'').trim().toUpperCase());
      if(!c) return alert('Escribe un C√ìDIGO');
      location.href=`result.html?code=${encodeURIComponent(c)}`;
    };
  </script>
</body>
</html>
