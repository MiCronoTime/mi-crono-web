<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MI CRONO WEB</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    :root{
      --bg:#10141b; --panel:#161c24; --panel2:#1b2330;
      --text:#eaf0f8; --muted:#b5c0d1; --border:#2a3342;
      --accent:#6eb0ff; --accent-2:#8ec5ff; --danger:#ff6b82;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1300px 800px at 20% -10%, #131a27 0%, transparent 60%),
                  radial-gradient(1200px 900px at 120% 10%, #192134 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .h1{font-weight:900;letter-spacing:.06em;text-transform:uppercase;display:flex;align-items:center;gap:10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 12px 0;text-transform:uppercase;letter-spacing:.04em}
    label{display:block;margin:10px 0 6px;font-weight:800}
    input[type=text], textarea{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--border);
      background:#0f141c; color:var(--text); font-weight:800; letter-spacing:.02em; outline:none;
      text-transform:uppercase;
    }
    textarea{min-height:150px; resize:vertical}
    small.muted{color:var(--muted)}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 16px;border-radius:12px;border:1px solid var(--border);
      background:#0f141c;color:var(--text);cursor:pointer;text-decoration:none;
      text-transform:uppercase;font-weight:900;letter-spacing:.03em;min-height:44px;
      transition:background .15s,border-color .15s,transform .05s;
    }
    .btn:hover{background:#141a24}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#091320}
    .btn.primary:hover{background:var(--accent-2);border-color:var(--accent-2)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#220a12}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .foot{margin-top:8px;border-top:1px dashed var(--border);padding-top:8px;color:var(--muted);font-size:13px}

    /* ---------- Overlay de modo ---------- */
    .mode-overlay{position:fixed;inset:0;background:rgba(10,12,16,.75);backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;z-index:9999}
    .mode-box{max-width:760px;width:92%;display:flex;gap:24px;justify-content:space-between}
    .mode-btn{
      flex:1 1 0; display:flex; align-items:center; justify-content:center;
      height:74px; border-radius:14px; font-weight:900; letter-spacing:.06em; text-transform:uppercase;
      border:1px solid rgba(255,255,255,.15); color:#0b1220; cursor:pointer; user-select:none;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .mode-btn.primary{ background:#6eb0ff }
    .mode-btn.alt{ background:#ff798a }
    .mode-close{ position:fixed; top:18px; right:18px; color:#eaf0f8; cursor:pointer; font-weight:800; font-size:22px }
    @media (max-width:560px){ .mode-box{flex-direction:column} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="h1">üïë MI CRONO WEB</h1>

    <div class="grid">
      <!-- CREAR EVENTO -->
      <section class="card">
        <h2>CREAR EVENTO</h2>
        <label for="codeNew">C√≥digo del evento</label>
        <input id="codeNew" type="text" placeholder="P.EJ. TEST1" autocomplete="off"/>

        <label for="partsNew">Participantes (uno por l√≠nea, en orden de salida)</label>
        <textarea id="partsNew" placeholder="CORREDOR 1&#10;CORREDOR 2&#10;CORREDOR 3"></textarea>

        <div class="foot">
          Si el evento ya existe, se <b>RESETEA por completo</b> (borra participantes y tiempos) y se crean estos nuevos.
        </div>

        <div class="row" style="margin-top:12px">
          <button id="btnSave" class="btn primary">GUARDAR EVENTO</button>
        </div>
      </section>

      <!-- UNIRSE -->
      <section class="card">
        <h2>UNIRSE A UN EVENTO</h2>
        <label for="codeJoin">C√≥digo</label>
        <input id="codeJoin" type="text" value="TEST1" autocomplete="off"/>

        <div class="row" style="margin-top:10px">
          <a id="btnStart"  class="btn">üèÅ SALIDA</a>
          <a id="btnFinish" class="btn">üö© META</a>
          <a id="btnRes"    class="btn">üßæ RESULTADOS</a>
        </div>

        <div class="foot">
          Abre <b>SALIDA</b> en la salida y <b>META</b> en la llegada. Ambos con el mismo <b>c√≥digo</b>.
        </div>
      </section>
    </div>

    <!-- HERRAMIENTAS -->
    <section class="card" style="margin-top:18px">
      <h2>HERRAMIENTAS</h2>
      <p class="muted"><b>RESET EVENTOS</b> elimina <u>todos</u> los eventos y sus participantes de la base de datos. √ösalo solo si quieres limpiar por completo.</p>
      <button id="btnReset" class="btn danger">RESET EVENTOS</button>
    </section>
  </div>

  <!-- Overlay selecci√≥n de modo -->
  <div id="modeOverlay" class="mode-overlay" style="display:flex">
    <div class="mode-close" id="closeOverlay">√ó</div>
    <div class="mode-box">
      <button class="mode-btn primary" id="btnSingle">SINGLETRACK</button>
      <button class="mode-btn alt"     id="btnLap">CRONOLAP</button>
    </div>
  </div>

  <script type="module">
    // ===== Uppercase en tiempo real (inputs/textarea) =====
    const upperize = (el)=> el && el.addEventListener('input', ()=> el.value = el.value.toUpperCase());
    upperize(document.getElementById('codeNew'));
    upperize(document.getElementById('codeJoin'));
    // textarea: mantenemos saltos de l√≠nea, pero forzamos may√∫sculas
    const partsNew = document.getElementById('partsNew');
    partsNew.addEventListener('input', ()=> partsNew.value = partsNew.value.toUpperCase());

    // ===== Navegaci√≥n SALIDA / META / RESULTADOS =====
    const codeJoinEl = document.getElementById('codeJoin');
    const go = (page)=> {
      const code = (codeJoinEl.value||'').toUpperCase().trim();
      if(!code) { alert('Escribe el C√ìDIGO del evento'); return; }
      location.href = `${page}?code=${encodeURIComponent(code)}`;
    };
    document.getElementById('btnStart').onclick  = ()=> go('camera.html?mode=start');
    document.getElementById('btnFinish').onclick = ()=> go('camera.html?mode=finish');
    document.getElementById('btnRes').onclick    = ()=> go('result.html');

    // ===== Firebase (CDN) =====
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore, doc, setDoc, serverTimestamp, collection,
      getDocs, deleteDoc, addDoc
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== Crear / Resetear un evento =====
    document.getElementById('btnSave').onclick = async ()=>{
      const code = (document.getElementById('codeNew').value||'').toUpperCase().trim();
      const raw  = (partsNew.value||'').toUpperCase().split('\n').map(s=>s.trim()).filter(Boolean);
      if(!code){ alert('Escribe un C√ìDIGO para el evento'); return; }
      if(raw.length===0){ alert('A√±ade al menos 1 PARTICIPANTE (una l√≠nea)'); return; }

      try{
        const evRef = doc(db,'events',code);

        // 1) BORRAR participantes existentes del evento (reset completo)
        const partsCol = collection(evRef,'participants');
        const snapshot = await getDocs(partsCol);
        for (const d of snapshot.docs){ await deleteDoc(d.ref); }

        // 2) Guardar doc del evento (updatedAt cambia)
        await setDoc(evRef, { code, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }, { merge:true });

        // 3) Crear nuevos participantes con "order"
        let order=1;
        for (const name of raw){
          await addDoc(partsCol, { name, order, startTS:null, stopTS:null });
          order++;
        }

        alert('Evento guardado / reseteado correctamente.');
        // Rellenamos el c√≥digo tambi√©n en "unirse"
        document.getElementById('codeJoin').value = code;
      }catch(e){
        console.error(e);
        alert('Error guardando el evento: '+(e.message||e));
      }
    };

    // ===== Reset TODOS los eventos (con confirmaci√≥n) =====
    document.getElementById('btnReset').onclick = async ()=>{
      const ok = confirm('‚ö†Ô∏è Esto borrar√° TODOS los eventos y participantes de la base de datos.\n\n¬øSeguro que quieres continuar?');
      if(!ok) return;

      try{
        const eventsCol = collection(db,'events');
        const allEvents = await getDocs(eventsCol);
        for (const ev of allEvents.docs){
          // borra subcolecci√≥n participants
          const partsCol = collection(ev.ref,'participants');
          const ps = await getDocs(partsCol);
          for (const p of ps.docs){ await deleteDoc(p.ref); }
          // borra subcolecci√≥n sync (si existiera)
          const syncCol = collection(ev.ref,'sync');
          const ss = await getDocs(syncCol);
          for (const s of ss.docs){ await deleteDoc(s.ref); }
          // borra el evento
          await deleteDoc(ev.ref);
        }
        alert('Todos los eventos han sido eliminados.');
      }catch(e){
        console.error(e);
        alert('Error al resetear: '+(e.message||e));
      }
    };

    // ===== Overlay de MODO (SINGLETRACK / CRONOLAP) =====
    const ov = document.getElementById('modeOverlay');
    const seen = localStorage.getItem('mcw_mode_seen');
    if (seen === '1') ov.style.display = 'none';

    document.getElementById('closeOverlay').onclick = ()=>{
      ov.style.display='none';
      localStorage.setItem('mcw_mode_seen','1');
    };
    // SINGLETRACK ‚Üí cierra overlay (usas SALIDA/META normales)
    document.getElementById('btnSingle').onclick = ()=>{
      ov.style.display='none';
      localStorage.setItem('mcw_mode_seen','1');
    };
    // CRONOLAP ‚Üí pedir c√≥digo y abrir lap.html
    document.getElementById('btnLap').onclick = ()=>{
      const code = (prompt('C√≥digo del evento (CRONOLAP):','TEST1')||'').toUpperCase().trim();
      if(!code) return;
      localStorage.setItem('mcw_mode_seen','1');
      location.href = `lap.html?code=${encodeURIComponent(code)}`;
    };
  </script>
</body>
</html>
