<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MI CRONO WEB ‚Äî INICIO</title>
  <link rel="icon" href="favicon.ico" />
  <style>
    :root{
      --bg:#10141b; --bg2:#0c1117; --panel:#161c24; --panel2:#1b2330;
      --text:#eaf0f8; --muted:#b5c0d1; --border:#2a3342;
      --accent:#6eb0ff; --accent-2:#8ec5ff; --danger:#ff6b82;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1300px 800px at 20% -10%, #131a27 0%, transparent 60%),
                  radial-gradient(1200px 900px at 120% 10%, #192134 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;justify-content:center;gap:12px;margin:6px 0 10px}
    .clock{font-size:22px;line-height:1;filter:drop-shadow(0 1px 0 rgba(0,0,0,.25))}
    .title{font-weight:900;letter-spacing:.06em;text-transform:uppercase}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:18px}
    @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }

    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.28)}
    .card h2{margin:0 0 12px 0;text-transform:uppercase;letter-spacing:.05em}
    .hint{background:var(--panel2);border:1px solid var(--border);border-radius:10px;padding:10px;margin-top:12px}

    label{display:block;margin:8px 0 6px 0;font-weight:800;letter-spacing:.02em}
    input, textarea{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);
      background:var(--bg2);color:var(--text);outline:none;font-size:15px;
    }
    .uppercase{ text-transform: uppercase; letter-spacing:.03em; }
    textarea{min-height:170px;resize:vertical;white-space:pre}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 16px;border-radius:12px;border:1px solid var(--border);
      background:#0f141c;color:var(--text);cursor:pointer;text-decoration:none;
      text-transform:uppercase;font-weight:900;letter-spacing:.03em;min-height:44px;
      transition:background .15s,border-color .15s,transform .05s;
    }
    .btn:hover{background:#141a24}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#091320}
    .btn.primary:hover{background:var(--accent-2);border-color:var(--accent-2)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#210a12}
    .cluster{display:flex;gap:10px;flex-wrap:wrap}
    .cluster .btn{flex:1 1 120px}

    /* Selector de idioma (no cambia estilos generales) */
    .langbar{display:flex;justify-content:flex-end;gap:8px;margin-bottom:8px}
    .langbtn{
      background:transparent;border:1px solid var(--border);color:var(--muted);
      padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:900;letter-spacing:.03em;
      text-transform:uppercase
    }
    .langbtn.active{color:var(--text);border-color:var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Selector de idioma (CAT por defecto) -->
    <div class="langbar" aria-label="Idioma">
      <button class="langbtn" data-lang="ca">CAT</button>
      <button class="langbtn" data-lang="en">ENG</button>
      <button class="langbtn" data-lang="es">ESP</button>
    </div>

    <!-- CABECERA (con reloj) -->
    <div class="top">
      <span class="clock" aria-hidden="true">‚è±Ô∏è</span>
      <h1 class="title" id="t-app">MI CRONO WEB</h1>
    </div>

    <div class="grid">
      <!-- CREAR EVENTO -->
      <section class="card">
        <h2 id="t-create">Crear evento</h2>
        <label for="newCode" id="t-codeLbl">C√≥digo del evento</label>
        <input id="newCode" class="uppercase" placeholder="P.EJ. TEST1" />

        <label for="newList" id="t-partLbl">Participantes (uno por l√≠nea, en orden de salida)</label>
        <textarea id="newList" class="uppercase" placeholder="CORREDOR 1&#10;CORREDOR 2&#10;CORREDOR 3"></textarea>

        <div class="hint" id="t-resetWarn">
          Si el evento ya existe, se <b>RESETEA por completo</b> (borra participantes y
          tiempos) y se crean estos nuevos.
        </div>

        <div style="margin-top:14px">
          <button id="btnSave" class="btn primary"><span id="t-save">Guardar evento</span></button>
        </div>
      </section>

      <!-- UNIRSE A UN EVENTO -->
      <section class="card">
        <h2 id="t-join">Unirse a un evento</h2>
        <label for="joinCode" id="t-joinCode">C√≥digo</label>
        <input id="joinCode" class="uppercase" placeholder="TEST1" />

        <div class="cluster" style="margin-top:12px">
          <a id="goStart"  class="btn" href="#">üèÅ&nbsp;<span id="t-start">Salida</span></a>
          <a id="goFinish" class="btn" href="#">üö©&nbsp;<span id="t-finish">Meta</span></a>
          <a id="goResult" class="btn" href="#">‚¨ú&nbsp;<span id="t-results">Resultados</span></a>
        </div>

        <div class="hint" id="t-hintJoin">
          Abre <b>Salida</b> en la salida y <b>Meta</b> en la llegada. Ambos con el mismo <b>c√≥digo</b>.
        </div>
      </section>
    </div>

    <!-- HERRAMIENTAS -->
    <section class="card" style="margin-top:18px">
      <h2 id="t-tools">Herramientas</h2>
      <div class="hint" id="t-nukeHint">
        <b>Reset eventos</b> elimina <u>todos</u> los eventos y sus participantes de la base de datos.
        √ösalo solo si quieres limpiar por completo.
      </div>
      <div style="margin-top:10px">
        <button id="btnNuke" class="btn danger"><span id="t-nuke">Reset eventos</span></button>
      </div>
    </section>

    <p class="muted" style="text-align:center;margin-top:14px">‚Äî</p>
  </div>

  <!-- Firebase (CDN, m√≥dulos ES) + l√≥gica existente (intacta) -->
  <script type="module">
    // ===== i18n (solo textos) =====
    const L = (()=>({
      ca: {
        app:"MI CRONO WEB",
        create:"Crear esdeveniment",
        codeLbl:"Codi de l'esdeveniment",
        partLbl:"Participants (un per l√≠nia, en ordre de sortida)",
        resetWarn:"Si l'esdeveniment ja existeix, es <b>RESETEJA completament</b> (esborra participants i temps) i es creen aquests nous.",
        save:"GUARDAR ESDEVENIMENT",
        join:"Unir-se a un esdeveniment",
        joinCode:"Codi",
        start:"SORTIDA",
        finish:"META",
        results:"RESULTATS",
        hintJoin:"Obre <b>Sortida</b> a la sortida i <b>Meta</b> a l'arribada. Tots dos amb el mateix <b>codi</b>.",
        tools:"Eines",
        nukeHint:"<b>Reset esdeveniments</b> elimina <u>tots</u> els esdeveniments i participants de la base de dades. Fes-ho nom√©s si vols netejar-ho completament.",
        nuke:"RESET ESDEVENIMENTS",
        confirmNuke:"‚ö†Ô∏è Aix√≤ esborrar√† TOTS els esdeveniments i participants. Segur que vols continuar?"
      },
      en: {
        app:"MI CRONO WEB",
        create:"Create event",
        codeLbl:"Event code",
        partLbl:"Participants (one per line, start order)",
        resetWarn:"If the event already exists, it is <b>RESET completely</b> (removes participants and times) and these new ones are created.",
        save:"SAVE EVENT",
        join:"Join an event",
        joinCode:"Code",
        start:"START",
        finish:"FINISH",
        results:"RESULTS",
        hintJoin:"Open <b>Start</b> at the start and <b>Finish</b> at the finish. Both with the same <b>code</b>.",
        tools:"Tools",
        nukeHint:"<b>Reset events</b> deletes <u>all</u> events and participants from the database. Use only if you want a full clean up.",
        nuke:"RESET EVENTS",
        confirmNuke:"‚ö†Ô∏è This will delete ALL events and participants. Are you sure?"
      },
      es: {
        app:"MI CRONO WEB",
        create:"Crear evento",
        codeLbl:"C√≥digo del evento",
        partLbl:"Participantes (uno por l√≠nea, en orden de salida)",
        resetWarn:"Si el evento ya existe, se <b>RESETEA por completo</b> (borra participantes y tiempos) y se crean estos nuevos.",
        save:"GUARDAR EVENTO",
        join:"Unirse a un evento",
        joinCode:"C√≥digo",
        start:"SALIDA",
        finish:"META",
        results:"RESULTADOS",
        hintJoin:"Abre <b>Salida</b> en la salida y <b>Meta</b> en la llegada. Ambos con el mismo <b>c√≥digo</b>.",
        tools:"Herramientas",
        nukeHint:"<b>Reset eventos</b> elimina <u>todos</u> los eventos y sus participantes de la base de datos. √ösalo solo si quieres limpiar por completo.",
        nuke:"RESET EVENTOS",
        confirmNuke:"‚ö†Ô∏è Esto borrar√° TODOS los eventos y participantes. ¬øSeguro que quieres continuar?"
      }
    }))();

    const lang = localStorage.getItem('lang') || 'ca';
    const $$ = sel => document.querySelector(sel);
    function applyI18n(){
      const t=L[lang];
      $('#t-app').textContent=t.app;
      $('#t-create').textContent=t.create;
      $('#t-codeLbl').textContent=t.codeLbl;
      $('#t-partLbl').textContent=t.partLbl;
      $('#t-resetWarn').innerHTML=t.resetWarn;
      $('#t-save').textContent=t.save;
      $('#t-join').textContent=t.join;
      $('#t-joinCode').textContent=t.joinCode;
      $('#t-start').textContent=t.start;
      $('#t-finish').textContent=t.finish;
      $('#t-results').textContent=t.results;
      $('#t-hintJoin').innerHTML=t.hintJoin;
      $('#t-tools').textContent=t.tools;
      $('#t-nukeHint').innerHTML=t.nukeHint;
      $('#t-nuke').textContent=t.nuke;
      // Selector activo
      document.querySelectorAll('.langbtn').forEach(b=>{
        b.classList.toggle('active', b.dataset.lang===lang);
      });
    }
    function $(id){ return document.getElementById(id); }

    // Idioma: clicks
    document.querySelectorAll('.langbtn').forEach(b=>{
      b.onclick = ()=>{
        localStorage.setItem('lang', b.dataset.lang);
        location.reload();
      };
    });
    applyI18n();

    // ===== Helpers de UI ===== (existentes)
    const UP = (s)=> (s||'').trim().toUpperCase();
    function forceUpper(){
      ['newCode','joinCode'].forEach(id=>{
        const el=$(id); if(!el) return;
        el.addEventListener('input', e=>{
          const pos=e.target.selectionStart;
          e.target.value=e.target.value.toUpperCase();
          e.target.setSelectionRange(pos,pos);
        });
      });
      const ta=$('newList');
      if(ta){
        ta.addEventListener('input', e=>{
          const s=e.target.selectionStart, t=e.target.selectionEnd;
          e.target.value=e.target.value.toUpperCase();
          e.target.setSelectionRange(s,t);
        });
      }
    }
    function wireJoin(){
      const nav=(mode)=>{
        const code=UP($('joinCode').value);
        if(!code){ alert(lang==='en'?'Enter a code.':(lang==='ca'?'Escriu un codi.':'Escribe un c√≥digo.')); return; }
        if(mode==='result') location.href=`result.html?code=${encodeURIComponent(code)}`;
        else location.href=`camera.html?code=${encodeURIComponent(code)}&mode=${mode}`;
      };
      $('goStart').onclick =(e)=>{ e.preventDefault(); nav('start'); };
      $('goFinish').onclick=(e)=>{ e.preventDefault(); nav('finish'); };
      $('goResult').onclick=(e)=>{ e.preventDefault(); nav('result'); };
    }

    // ===== Firebase (CDN) =====
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore, doc, setDoc, collection, getDocs, deleteDoc, addDoc,
      serverTimestamp, writeBatch
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== Guardar / resetear evento =====
    $('btnSave').onclick = async ()=>{
      try{
        const code = UP($('newCode').value);
        if(!code){ alert(lang==='en'?'Enter an event code.':(lang==='ca'?'Escriu un codi d\'esdeveniment.':'Escribe un c√≥digo de evento.')); return; }

        // Crea/actualiza doc del evento
        const evRef = doc(db,'events',code);
        await setDoc(evRef, { code, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }, { merge:true });

        // Elimina participantes existentes (batch)
        const partsCol = collection(evRef,'participants');
        const existing = await getDocs(partsCol);
        try{
          const batch = writeBatch(db);
          existing.forEach(d=>batch.delete(d.ref));
          await batch.commit();
        }catch(errBatch){
          for(const d of existing.docs){
            try{ await deleteDoc(d.ref); }catch(e){ console.error('Error borrando', d.id, e); }
          }
        }

        // Inserta nuevos participantes
        const lines = UP($('newList').value).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        let order=1;
        for(const name of lines){
          await addDoc(partsCol, { name, order, startTS:null, stopTS:null, createdAt: serverTimestamp() });
          order++;
        }

        alert(lang==='en'?'Event saved.':(lang==='ca'?'Esdeveniment desat.':'Evento guardado.'));
        $('joinCode').value = code;
      }catch(e){
        alert((lang==='en'?'Error saving event: ':(lang==='ca'?'Error en desar l\'esdeveniment: ':'Error guardando evento: ')) + (e.message||e));
      }
    };

    // ===== Reset total (con confirmaci√≥n) =====
    $('btnNuke').onclick = async ()=>{
      const t = L[lang];
      const ok = confirm(t.confirmNuke);
      if(!ok) return;

      try{
        const evs = await getDocs(collection(db,'events'));
        for(const ev of evs.docs){
          const parts = await getDocs(collection(ev.ref,'participants'));
          for(const p of parts.docs){ try{ await deleteDoc(p.ref); }catch(e){ console.error('Del participant',p.id,e); } }
          try{ await deleteDoc(ev.ref); }catch(e){ console.error('Del event',ev.id,e); }
        }
        alert(lang==='en'?'Database cleaned.':(lang==='ca'?'Base de dades neta.':'Base de datos limpia.'));
      }catch(e){
        alert((lang==='en'?'Delete error: ':(lang==='ca'?'Error en eliminar: ':'Error al eliminar: ')) + (e.message||e));
      }
    };

    forceUpper();
    wireJoin();
  </script>
</body>
</html>
