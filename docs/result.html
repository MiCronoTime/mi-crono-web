<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono — RESULTADOS</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    :root{
      --bg:#121418; --panel:#1b1f27; --panel2:#232a34; --text:#e8ecf1; --muted:#b5bdc9;
      --border:#2b3240; --accent:#5ea1ff; --accent2:#7cc4ff;
    }
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(1200px 800px at 20% -10%, #151924 0%, transparent 60%),
                 radial-gradient(1200px 800px at 120% 10%, #1a2030 0%, transparent 55%),
                 var(--bg);
      color:var(--text)
    }
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    h1{margin:0;text-transform:uppercase;letter-spacing:.04em}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:12px}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#0f1217;color:var(--text);font-weight:800;text-transform:uppercase;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#0b1220}
    .btn.primary:hover{background:var(--accent2);border-color:var(--accent2)}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#0f1217;border:1px solid var(--border)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th, td{padding:10px 12px;text-align:left}
    thead th{font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:#cfd6e3}
    tbody tr{background:#0f1217;border:1px solid var(--border)}
    tbody td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px;text-align:right}
    .right{text-align:right}
    .ok{color:#7cffb6;font-weight:800}
    .err{color:#ff758d;font-weight:800}
    @media (max-width: 480px){
      th, td{padding:8px 10px;font-size:14px}
      .top{gap:10px;flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1 id="title">RESULTADOS</h1>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnPdf" class="btn primary">Descargar PDF</button>
        <a class="btn" href="singletrack_index.html">⇦ Inicio</a>
      </div>
    </div>

    <div class="card">
      <div id="headerInfo" class="muted">Cargando…</div>
    </div>

    <div class="card">
      <div class="muted" id="stateLine">Cargando…</div>
      <div style="overflow-x:auto;margin-top:8px">
        <table id="tbl">
          <thead>
            <tr>
              <th>#</th>
              <th>Participante</th>
              <th class="right">Tiempo</th>
              <th class="right">Δ respecto 1º</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="4" class="muted">Cargando…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- jsPDF para exportar -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- Auth + datos -->
  <script type="module">
    import { ensureAuthInit, requireAuth, currentCtx } from './js/auth.js';

    const params = new URL(location.href).searchParams;
    const code = (params.get('code')||'').toUpperCase();

    const $=id=>document.getElementById(id);
    const two=n=>String(n).padStart(2,'0');
    const three=n=>String(n).padStart(3,'0');
    const fmt=(ms)=>{ ms=Math.max(0,Math.floor(ms||0)); const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), ms3=ms%1000; return `${two(m)}:${two(s)}.${three(ms3)}`; };
    const tsToMillis=(ts)=> ts ? (ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6)) : null;

    (async function init(){
      await ensureAuthInit();
      await requireAuth('index.html');

      $('title').textContent = `RESULTADOS — ${code || '—'}`;

      // Firebase ESM
      const { initializeApp, getApps, getApp } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
      const {
        getFirestore, doc, getDoc, collection, onSnapshot, query, orderBy, addDoc, serverTimestamp
      } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');

      const firebaseConfig = {
        apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
        authDomain: "mi-crono-time-888b7.firebaseapp.com",
        projectId: "mi-crono-time-888b7",
        storageBucket: "mi-crono-time-888b7.appspot.com",
        messagingSenderId: "379025900327",
        appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
      };
      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const db  = getFirestore(app);

      const { uid } = currentCtx();
      if(!uid || !code){
        $('stateLine').textContent = 'Error: sesion o código no válidos';
        $('stateLine').className = 'err';
        return;
      }

      const eventRef = doc(db,'users',uid,'events',code);
      const partsCol = collection(eventRef,'participants');
      const syncCol  = collection(eventRef,'sync');

      // Fecha/hora del evento (si no existe createdAt, lo fijamos ahora)
      const evSnap = await getDoc(eventRef);
      if(!evSnap.exists()){
        // crea contenedor básico para evitar “cargando” eterno
        await (await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js'))
          .setDoc(eventRef,{ code, createdAt: serverTimestamp() },{ merge:true });
      }

      // Offset de reloj (una sola lectura)
      let serverOffsetMS = 0;
      try{
        const { id } = await (await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js'))
          .addDoc(syncCol,{ serverNow: serverTimestamp() });
        const pingRef = doc(syncCol, id);
        const pingSnap = await getDoc(pingRef);
        const serverNowMs = tsToMillis(pingSnap.data().serverNow);
        serverOffsetMS = (serverNowMs ?? Date.now()) - Date.now();
      }catch(_){ serverOffsetMS = 0; }

      // Render header (fecha y hora del evento)
      async function renderHeader(){
        const e = await getDoc(eventRef);
        const d = e.data()||{};
        let when = '—';
        if(d.createdAt){
          const ms = tsToMillis(d.createdAt);
          const dt = new Date(ms);
          when = dt.toLocaleString();
        }
        $('headerInfo').innerHTML = `
          <span class="badge">Evento</span> <b>${code}</b> &nbsp;•&nbsp;
          <span class="badge">Fecha</span> ${when}
        `;
      }
      await renderHeader();

      // Suscripción en tiempo real a los participantes
      let lastRows = [];
      const tbody = $('tbody');
      $('stateLine').textContent = 'Cargando…';
      $('stateLine').className = 'muted';

      onSnapshot(query(partsCol, orderBy('order','asc')), (snap)=>{
        // Construye lista con tiempos calculados
        const rows = snap.docs.map(d=>{
          const x = d.data();
          const start = tsToMillis(x.startTS);
          const stop  = tsToMillis(x.stopTS);
          const ms = (start!=null && stop!=null) ? (stop - start) : null;
          return {
            id:d.id, name:(x.name||'').toUpperCase(), order:x.order||0,
            startMS:start, stopMS:stop, timeMS:ms
          };
        });

        // Orden: por tiempo (los que no tienen tiempo van al final)
        rows.sort((a,b)=>{
          if(a.timeMS==null && b.timeMS==null) return a.order - b.order;
          if(a.timeMS==null) return 1;
          if(b.timeMS==null) return -1;
          return a.timeMS - b.timeMS;
        });

        // Δ respecto 1º
        const base = rows.find(r=>r.timeMS!=null)?.timeMS ?? null;
        // Render tabla
        if(rows.length===0){
          tbody.innerHTML = `<tr><td colspan="4" class="muted">Sin participantes</td></tr>`;
        }else{
          tbody.innerHTML = rows.map((r,i)=>{
            const t = r.timeMS!=null ? fmt(r.timeMS) : '—';
            const d = (base!=null && r.timeMS!=null) ? fmt(r.timeMS - base) : '—';
            return `<tr>
              <td style="width:60px">#${r.order}</td>
              <td>${r.name}</td>
              <td class="right">${t}</td>
              <td class="right">${d}</td>
            </tr>`;
          }).join('');
        }

        $('stateLine').textContent = 'Actualizado';
        $('stateLine').className = 'ok';
        lastRows = rows;
      }, (err)=>{
        $('stateLine').textContent = 'Error: '+(err.message||err); $('stateLine').className='err';
      });

      // -------- PDF sin cortes (autoTable) --------
      $('btnPdf').onclick = async ()=>{
        const { jsPDF } = window.jspdf;
        const docpdf = new jsPDF({ unit:'pt', format:'a4', compress:true });

        // Encabezado
        const pageW = docpdf.internal.pageSize.getWidth();
        docpdf.setFont('helvetica','bold'); docpdf.setFontSize(16);
        docpdf.text(`Resultados — ${code}`, 40, 48);
        const ev = await getDoc(eventRef);
        const when = ev.data()?.createdAt ? new Date(tsToMillis(ev.data().createdAt)).toLocaleString() : '';
        docpdf.setFont('helvetica','normal'); docpdf.setFontSize(11);
        docpdf.text(`Fecha: ${when}`, 40, 66);

        // Tabla
        const head = [['#','Participante','Tiempo','Δ respecto 1º']];
        const body = [];
        // Clona última vista ya ordenada
        const base = lastRows.find(r=>r.timeMS!=null)?.timeMS ?? null;
        lastRows.forEach(r=>{
          body.push([
            String(r.order),
            r.name || '',
            r.timeMS!=null ? fmt(r.timeMS) : '—',
            (base!=null && r.timeMS!=null) ? fmt(r.timeMS - base) : '—'
          ]);
        });

        docpdf.autoTable({
          head, body,
          startY: 88,
          styles: { fontSize: 11, cellPadding: 6, halign:'left', valign:'middle' },
          headStyles: { fillColor:[30,38,52], textColor:255, fontStyle:'bold' },
          bodyStyles: { fillColor:[18,20,24], textColor: [232,236,241] },
          alternateRowStyles: { fillColor:[23,25,31] },
          margin: { left: 40, right: 40 },
          tableWidth: pageW - 80,
          theme: 'striped',
          didDrawPage: (data)=>{
            // pie de página
            const str = 'Mi Crono Web';
            docpdf.setFontSize(9);
            docpdf.setTextColor(140);
            docpdf.text(str, 40, docpdf.internal.pageSize.getHeight()-24);
          }
        });

        docpdf.save(`resultados_${code}.pdf`);
      };
    })();
  </script>
</body>
</html>
