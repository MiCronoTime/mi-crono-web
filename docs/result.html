<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Resultados</title>
  <style>
    :root{
      --bg:#111416; --text:#e8ecf1; --muted:#b5bdc9; --accent:#5ea1ff;
      --border:#d8dde6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#0e1115; color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    h1{margin:0;font-size:20px;letter-spacing:.04em;text-transform:uppercase}
    .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;background:#1b2330;color:#cfe1ff;font-weight:700}
    .btn{
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
      padding:10px 14px;border-radius:10px;border:1px solid #2b3240;background:#131821;
      color:#e8ecf1;cursor:pointer;font-weight:800;letter-spacing:.02em;text-transform:uppercase;font-size:13px;
    }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#0b1220 }
    .card{background:#141922;border:1px solid #242b39;border-radius:14px;padding:14px}
    .muted{color:#aeb6c4}

    /* selector de tramos / añadir eventos */
    .addbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    select, input[type=text]{background:#0f141d;border:1px solid #263147;color:#e8ecf1;border-radius:10px;padding:10px 12px}
    .plus{width:42px; height:42px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; font-size:22px; line-height:1}

    /* tabla resultados (tema oscuro en pantalla) */
    .scroll{overflow:auto;border:1px solid #263147;border-radius:12px}
    table{width:100%; border-collapse:collapse; min-width:680px; background:#10151e}
    thead th{
      position:sticky; top:0; background:#0f131b; color:#cfe1ff; text-align:left;
      font-size:12px; letter-spacing:.06em; text-transform:uppercase; padding:10px; border-bottom:1px solid #263147;
    }
    tbody td{padding:10px;border-bottom:1px solid #1d2534}
    tbody tr:nth-child(odd){background:#0f141d}
    .name{font-weight:900}
    .time{font-variant-numeric:tabular-nums; font-feature-settings: "tnum" 1; font-weight:900}
    .delta{color:#cfd6e3; font-variant-numeric:tabular-nums}
    .total{font-weight:900}

    /* tira de info */
    .info{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;color:#c7d2e4}
    .info .item{background:#101723;border:1px solid #263147;border-radius:10px;padding:8px 10px;font-size:13px}

    /* versión de impresión/PDF (fondo blanco, tabla clara) */
    @media print {
      body{ background:#fff; color:#111 }
      .wrap{ padding:0 }
      header .pill, .card, .btn, .addbar, .info{ display:none !important }
      .scroll{ border:none }
      table{ background:#fff; border:1px solid #cfd4dd }
      thead th{ background:#f6f8fb; color:#111; border-bottom:1px solid #cfd4dd }
      tbody td{ border-bottom:1px solid #eceff4; color:#111 }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>RESULTADOS</h1>
      <div class="bar">
        <span class="pill" id="pillCode">Evento: —</span>
        <span class="pill" id="pillUser">Usuario: —</span>
        <button class="btn" id="btnPrint">Imprimir</button>
        <button class="btn primary" id="btnPDF">Descargar PDF</button>
        <a class="btn" href="singletrack_index.html">Inicio</a>
      </div>
    </header>

    <section class="card">
      <div class="addbar">
        <label class="muted">Añadir tramo (evento) al resultado:</label>
        <select id="selEvents"></select>
        <button class="btn plus" id="btnAdd">+</button>
        <span class="muted">Puedes añadir varios (TC1, TC2, TC3…).</span>
      </div>

      <div class="scroll">
        <table id="tbl">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="info">
        <div class="item" id="when">Fecha/hora: —</div>
        <div class="item" id="eventsJoined">Eventos incluidos: —</div>
      </div>
    </section>
  </div>

  <!-- Auth / Firebase / PDF -->
  <script type="module">
    import { ensureAuthInit, requireAuth, currentCtx } from './js/auth.js';

    const $ = (id)=>document.getElementById(id);
    const two = (n)=>String(n).padStart(2,'0');
    const three=(n)=>String(n).padStart(3,'0');
    const fmt = (ms)=>{ ms=Math.max(0,Math.floor(ms||0));
      const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), ms3=ms%1000;
      return `${two(m)}:${two(s)}.${three(ms3)}`; };
    const tsToMillis = (ts)=> ts ? (ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6)) : null;

    // ====== Auth ======
    await ensureAuthInit();
    await requireAuth('index.html');
    const { uid, email } = currentCtx();

    // ====== Firebase ======
    const { initializeApp, getApps, getApp } =
      await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
    const {
      getFirestore, doc, getDoc, collection, getDocs, query, orderBy
    } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');

    const firebaseConfig = {
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ====== Base: evento en la URL + selección de más eventos ======
    const p = new URL(location.href).searchParams;
    const baseCode = (p.get('code')||'').toUpperCase();
    $('pillCode').textContent = 'Evento: ' + (baseCode||'—');
    $('pillUser').textContent = 'Usuario: ' + (email||uid);
    $('when').textContent = 'Fecha/hora: ' + new Date().toLocaleString();

    // eventos seleccionados para combinar (primer elemento = base)
    const selectedCodes = [];
    if (baseCode) selectedCodes.push(baseCode);

    // Rellena selector con TODOS los eventos del usuario (ordenados por fecha desc)
    const eventsCol = collection(doc(db,'users',uid),'events');
    const evSnap = await getDocs(query(eventsCol, orderBy('createdAt','desc')));
    const allCodes = evSnap.docs.map(d => d.id);
    const sel = $('selEvents');
    sel.innerHTML = allCodes.map(c => `<option value="${c}">${c}</option>`).join('');
    if (baseCode) {
      // Por comodidad, si el base está, selecciónalo siguiente
      const idx = allCodes.indexOf(baseCode);
      if (idx >= 0 && allCodes.length>1) sel.selectedIndex = (idx===0?1:0);
    }

    // Añadir evento al conjunto (+)
    $('btnAdd').onclick = ()=>{
      const code = sel.value.toUpperCase();
      if (!code) return;
      if (!selectedCodes.includes(code)) selectedCodes.push(code);
      renderCombined();
    };

    // Botón imprimir
    $('btnPrint').onclick = ()=> window.print();

    // Botón PDF (limpio)
    $('btnPDF').onclick = async ()=>{
      const { jsPDF } = await import('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
      await import('https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js');

      const docx = new jsPDF({orientation:'p', unit:'pt', format:'a4'});
      const marginX = 28, marginY = 32;

      // Título
      docx.setFont('helvetica','bold'); docx.setFontSize(14);
      docx.text('RESULTADOS', marginX, marginY);
      docx.setFont('helvetica','normal'); docx.setFontSize(10);
      docx.text(`Usuario: ${email||uid}`, marginX, marginY+14);
      docx.text(`Fecha/hora: ${new Date().toLocaleString()}`, marginX, marginY+28);
      docx.text(`Eventos: ${selectedCodes.join(' + ')}`, marginX, marginY+42);

      // Tabla a partir del modelo actual (cabeceras y body ya calculados)
      const { head, body } = lastTableModel;
      docx.autoTable({
        startY: marginY + 56,
        head: [head],
        body,
        styles: { font: 'helvetica', fontSize: 10, halign: 'left', valign: 'middle' },
        headStyles: { fillColor: [246,248,251], textColor: [0,0,0], lineWidth: 0.4, lineColor: [207,212,221] },
        bodyStyles: { fillColor: [255,255,255], textColor: [0,0,0], lineWidth: 0.25, lineColor: [230,234,241] },
        alternateRowStyles: { fillColor: [248,250,253] },
        columnStyles: {
          0: { cellWidth: 150 }, // participante
          // dinámicas para tramos se ajustan automático
        },
        theme: 'grid',
        margin: { left: marginX, right: marginX }
      });

      docx.save(`resultados_${selectedCodes.join('+')}.pdf`);
    };

    // ====== Carga y combinación de resultados ======
    // Estructura final (por nombre):
    // rows[name] = { name, tiempos: {EV1:ms, EV2:ms,...}, total:ms }
    let lastTableModel = { head: [], body: [] };

    async function loadEventResults(code){
      // Lee participantes de un evento → devuelve { nameUpper: msFinal|null }
      const partsCol = collection(doc(db,'users',uid,'events',code),'participants');
      const snap = await getDocs(query(partsCol, orderBy('order','asc')));
      const out = {};
      snap.docs.forEach(d=>{
        const x = d.data();
        const start = tsToMillis(x.startTS), stop = tsToMillis(x.stopTS);
        const name = (x.name||'').toUpperCase();
        const ms = (start && stop) ? (stop - start) : null;
        if (name) out[name] = ms;
      });
      return out;
    }

    function sumMs(values){
      return values.reduce((acc,v)=> acc + (typeof v==='number' ? v : 0), 0);
    }

    function renderTable(model){
      const thead = $('thead'), tbody=$('tbody');
      // head = ["Participante", ...eventCodes..., "TOTAL", ""(delta)]
      const head = ['Participante', ...model.events, 'TOTAL', ''];
      thead.innerHTML = `<tr>${
        head.map((h,i)=> `<th${i===head.length-1?' style="width:90px"':''}>${i===head.length-1?'':h}</th>`).join('')
      }</tr>`;

      tbody.innerHTML = model.rows.map(r=>{
        const cells = [
          `<td class="name">${r.name}</td>`,
          ...model.events.map(ev=>{
            const ms = r.tiempos[ev];
            return `<td class="time">${typeof ms==='number'? fmt(ms) : '—'}</td>`;
          }),
          `<td class="total time">${fmt(r.total)}</td>`,
          `<td class="delta">${r.delta==null?'': ('+'+fmt(r.delta))}</td>`
        ];
        return `<tr>${cells.join('')}</tr>`;
      }).join('');

      $('eventsJoined').textContent = 'Eventos incluidos: ' + model.events.join(' + ');
      lastTableModel = { head, body: model.rows.map(r=>[
        r.name,
        ...model.events.map(ev=> typeof r.tiempos[ev]==='number' ? fmt(r.tiempos[ev]) : '—' ),
        fmt(r.total),
        r.delta==null?'':('+'+fmt(r.delta))
      ]) };
    }

    async function renderCombined(){
      if (selectedCodes.length===0) return;

      // Carga todos los eventos seleccionados
      const perEvent = {};
      for (const code of selectedCodes){
        perEvent[code] = await loadEventResults(code);
      }

      // Unión por nombre
      const names = new Set();
      Object.values(perEvent).forEach(map=>{
        Object.keys(map).forEach(n => names.add(n));
      });

      // Construye filas con tiempos por tramo y total
      const rows = [];
      names.forEach(name=>{
        const tiempos = {};
        selectedCodes.forEach(code=>{
          tiempos[code] = perEvent[code][name] ?? null;
        });
        const total = sumMs(Object.values(tiempos));
        rows.push({ name, tiempos, total, delta:null });
      });

      // Ordena por total asc (quien no tiene tiempos contará como 0; si no te gusta, pon gran valor)
      rows.sort((a,b)=> (a.total||Number.MAX_SAFE_INTEGER) - (b.total||Number.MAX_SAFE_INTEGER));

      // Delta respecto 1º (total del líder)
      const leader = rows.find(r=> typeof r.total==='number' );
      const leaderMs = leader ? leader.total : null;
      rows.forEach(r=>{
        r.delta = (leaderMs!=null && typeof r.total==='number') ? (r.total - leaderMs) : null;
      });

      renderTable({ events: selectedCodes.slice(), rows });
    }

    // Render inicial (solo base) y listo para añadir más con "+"
    await renderCombined();
  </script>
</body>
</html>
