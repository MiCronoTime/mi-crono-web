<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Resultados</title>
  <style>
    :root{
      --text:#e8ecf1; --accent:#5ea1ff; --b1:#263147; --b2:#1d2534; --b3:#0f141d;
      --ink:#111; --paper:#fff; --thead:#f6f8fb; --grid:#cfd4dd; --alt:#f8fafd;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#0e1115; color:var(--text); }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}

    /* Header responsive */
    header{margin-bottom:10px}
    .topgrid{
      display:grid; gap:8px;
      grid-template-columns: 1fr; /* móvil por defecto */
    }
    .title{display:flex;align-items:center;justify-content:space-between;gap:8px}
    h1{margin:0;font-size:20px;letter-spacing:.04em;text-transform:uppercase}
    .actions{
      display:grid; gap:8px;
      grid-template-columns: 1fr 1fr; /* dos columnas en móvil */
    }
    .pills{
      display:grid; gap:8px;
      grid-template-columns: 1fr; /* se apilan en móvil */
    }
    @media (min-width: 640px){
      .topgrid{
        grid-template-columns: 1fr auto; /* título a la izq, acciones a la dcha */
        align-items:end;
      }
      .actions{ grid-template-columns: auto auto; justify-self:end }
      .pills{ grid-template-columns: auto auto auto; justify-self:start }
    }

    .pill{padding:6px 10px;border-radius:999px;background:#1b2330;color:#cfe1ff;font-weight:700; width:100%; text-align:center}
    .btn{
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
      padding:10px 14px;border-radius:10px;border:1px solid #2b3240;background:#131821;
      color:#e8ecf1;cursor:pointer;font-weight:800;letter-spacing:.02em;text-transform:uppercase;font-size:13px; width:100%;
    }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#0b1220 }
    .btn:disabled{ opacity:.6; cursor:not-allowed }

    .card{background:#141922;border:1px solid #242b39;border-radius:14px;padding:14px;margin-top:12px}
    .muted{color:#aeb6c4}

    /* selector de tramos / añadir/quitar eventos */
    .addbar{
      display:grid; gap:8px; align-items:center; margin-bottom:10px;
      grid-template-columns: 1fr auto auto; /* select, +, - */
    }
    @media (min-width: 520px){
      .addbar{ grid-template-columns: 1fr auto auto auto } /* sitio para texto */
    }
    select{background:#0f141d;border:1px solid var(--b1);color:#e8ecf1;border-radius:10px;padding:10px 12px; width:100%}
    .iconbtn{width:42px; height:42px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; font-size:22px; line-height:1}
    .minus{ border:1px solid #374151; background:#0f141d }

    /* tabla resultados (tema oscuro en pantalla) */
    .scroll{overflow:auto;border:1px solid var(--b1);border-radius:12px}
    table{width:100%; border-collapse:collapse; min-width:760px; background:#10151e}
    thead th{
      position:sticky; top:0; background:#0f131b; color:#cfe1ff; text-align:left;
      font-size:12px; letter-spacing:.06em; text-transform:uppercase; padding:10px; border-bottom:1px solid var(--b1);
      user-select:none; cursor:pointer;
    }
    thead th.nosort{ cursor:default }
    tbody td{padding:10px;border-bottom:1px solid var(--b2)}
    tbody tr:nth-child(odd){background:var(--b3)}
    .name{font-weight:900}
    .time{font-variant-numeric:tabular-nums; font-feature-settings: "tnum" 1; font-weight:900}
    .delta{color:#cfd6e3; font-variant-numeric:tabular-nums}
    .total{font-weight:900}
    .bib{font-weight:900; text-align:right; width:64px; min-width:64px}

    /* tira de info */
    .info{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;color:#c7d2e4}
    .info .item{background:#101723;border:1px solid var(--b1);border-radius:10px;padding:8px 10px;font-size:13px}

    /* versión impresión (PDF limpio fondo blanco) */
    @media print {
      body{ background:var(--paper); color:var(--ink) }
      .wrap{ padding:0 }
      .card{ border:none }
      .topgrid{ grid-template-columns: 1fr; }
      .actions, .pills, .addbar{ display:none !important }
      .scroll{ border:none }
      table{ background:var(--paper); border:1px solid var(--grid) }
      thead th{ background:var(--thead); color:var(--ink); border-bottom:1px solid var(--grid) }
      tbody td{ border-bottom:1px solid #eceff4; color:var(--ink) }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="topgrid">
        <div class="title">
          <h1>RESULTADOS</h1>
        </div>
        <div class="actions">
          <button class="btn primary" id="btnPDF">Descargar PDF</button>
          <a class="btn" id="btnHome" href="singletrack_index.html">Inicio</a>
        </div>
        <div class="pills">
          <span class="pill" id="pillCode">Evento: —</span>
          <span class="pill" id="pillUser">Usuario: —</span>
          <span class="pill" id="when">Fecha/hora: —</span>
        </div>
      </div>
    </header>

    <section class="card">
      <div class="addbar">
        <select id="selEvents"></select>
        <button class="btn iconbtn" id="btnAdd">+</button>
        <button class="btn iconbtn minus" id="btnRemove">−</button>
        <span class="muted" style="display:none" id="hintTxt">Puedes añadir varios (TC1, TC2, TC3…)</span>
      </div>

      <div class="scroll">
        <table id="tbl">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="info">
        <div class="item" id="eventsJoined">Eventos incluidos: —</div>
      </div>
    </section>
  </div>

  <script type="module">
    import { ensureAuthInit, requireAuth, currentCtx } from './js/auth.js';

    const $ = (id)=>document.getElementById(id);
    const two = (n)=>String(n).padStart(2,'0');
    const three=(n)=>String(n).padStart(3,'0');
    const fmt = (ms)=>{ ms=Math.max(0,Math.floor(ms||0));
      const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), ms3=ms%1000;
      return `${two(m)}:${two(s)}.${three(ms3)}`; };
    const tsToMillis = (ts)=> ts ? (ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6)) : null;

    // ====== Auth ======
    await ensureAuthInit();
    await requireAuth('index.html');
    const { uid, email } = currentCtx();

    // ====== Firebase ======
    const { initializeApp, getApps, getApp } =
      await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
    const {
      getFirestore, doc, getDoc, collection, getDocs, query, orderBy
    } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');

    const firebaseConfig = {
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ====== Base: evento en la URL + selección de más eventos ======
    const p = new URL(location.href).searchParams;
    const baseCode = (p.get('code')||'').toUpperCase();
    $('pillCode').textContent = 'Evento: ' + (baseCode||'—');
    $('pillUser').textContent = 'Usuario: ' + (email||uid);
    $('when').textContent     = 'Fecha/hora: ' + new Date().toLocaleString();
    if (document.referrer.includes('cronolap')) $('btnHome').href = 'cronolap_index.html';

    // eventos seleccionados (primer elemento = base)
    const selectedCodes = [];
    if (baseCode) selectedCodes.push(baseCode);

    // Rellena selector con TODOS los eventos del usuario (ordenados por fecha desc)
    const eventsCol = collection(doc(db,'users',uid),'events');
    const evSnap = await getDocs(query(eventsCol, orderBy('createdAt','desc')));
    const allCodes = evSnap.docs.map(d => d.id);
    const sel = $('selEvents');
    sel.innerHTML = allCodes.map(c => `<option value="${c}">${c}</option>`).join('');
    if (baseCode) {
      const idx = allCodes.indexOf(baseCode);
      if (idx >= 0 && allCodes.length>1) sel.selectedIndex = (idx===0?1:0);
    }

    // Añadir evento al conjunto (+)
    $('btnAdd').onclick = ()=>{
      const code = (sel.value||'').toUpperCase();
      if (!code) return;
      if (!selectedCodes.includes(code)) selectedCodes.push(code);
      renderCombined();
    };

    // Quitar evento del conjunto (−)
    $('btnRemove').onclick = ()=>{
      const code = (sel.value||'').toUpperCase();
      if (!code) return;
      if (!selectedCodes.includes(code)) return;
      if (selectedCodes.length===1 && selectedCodes[0]===baseCode) return;
      const next = selectedCodes.filter(c => c !== code);
      if (next.length===0 && baseCode) next.push(baseCode);
      selectedCodes.splice(0, selectedCodes.length, ...next);
      renderCombined();
    };

    // ====== Ordenación interactiva ======
    let sortKey = 'total';   // 'bib' | 'name' | 'delta' | 'total'
    let sortDir = 'asc';     // 'asc' | 'desc'

    function toggleSort(newKey){
      if (sortKey === newKey){
        sortDir = (sortDir==='asc' ? 'desc' : 'asc');
      } else {
        sortKey = newKey;
        sortDir = 'asc';
      }
      renderTable(lastModel); // re-render con mismo modelo
    }

    // ====== Botón PDF ======
    $('btnPDF').onclick = exportPDF;

    // ====== Carga y combinación de resultados ======
    let lastModel = { events: [], rows: [] };
    let lastTableModel = { head: [], body: [] };

    async function loadEventResults(code){
      // Devuelve array de { name, dorsal, ms }
      const partsCol = collection(doc(db,'users',uid,'events',code),'participants');
      const snap = await getDocs(query(partsCol, orderBy('order','asc')));
      const out = [];
      snap.docs.forEach(d=>{
        const x = d.data();
        const start = tsToMillis(x.startTS), stop = tsToMillis(x.stopTS);
        const name = (x.name||'').toUpperCase();
        const ms = (start && stop) ? (stop - start) : null;
        const dorsal = (x.dorsal!=null && x.dorsal!=='') ? String(x.dorsal).trim() : '';
        if (name) out.push({ name, dorsal, ms });
      });
      return out;
    }

    function sumMs(values){ return values.reduce((acc,v)=> acc + (typeof v==='number' ? v : 0), 0); }

    async function renderCombined(){
      if (selectedCodes.length===0) return;

      // Carga por evento
      const perEvent = {};
      for (const code of selectedCodes){
        perEvent[code] = await loadEventResults(code); // array
      }

      // Conjunto de nombres
      const names = new Set();
      Object.values(perEvent).forEach(list=>{
        list.forEach(it => names.add(it.name));
      });

      // dorsal preferente: tomarlo del PRIMER evento de selectedCodes que lo tenga (normalmente el base)
      function pickDorsalFor(name){
        for(const code of selectedCodes){
          const found = perEvent[code].find(p=>p.name===name);
          if(found && found.dorsal) return found.dorsal;
        }
        return '';
      }

      // Construir filas
      const rows = [];
      names.forEach(name=>{
        const tiempos = {};
        selectedCodes.forEach(code=>{
          const found = perEvent[code].find(p=>p.name===name);
          tiempos[code] = found ? found.ms : null;
        });
        const total = sumMs(Object.values(tiempos));
        const bib = pickDorsalFor(name);
        rows.push({ name, bib, tiempos, total, delta:null });
      });

      // Orden base por TOTAL asc
      rows.sort((a,b)=> (a.total||Number.MAX_SAFE_INTEGER) - (b.total||Number.MAX_SAFE_INTEGER));

      // Δ respecto al primero
      const leader = rows.find(r=> typeof r.total==='number' );
      const leaderMs = leader ? leader.total : null;
      rows.forEach(r=>{
        r.delta = (leaderMs!=null && typeof r.total==='number') ? (r.total - leaderMs) : null;
      });

      lastModel = { events: selectedCodes.slice(), rows };
      renderTable(lastModel);
    }

    function renderTable(model){
      const thead = $('thead'), tbody=$('tbody');

      // Cabecera: Dorsal | Participante | ...events... | TOTAL | (Δ sin título)
      const headCells = [
        { label:'Dorsal', key:'bib' },
        { label:'Participante', key:'name' },
        ...model.events.map(ev=>({ label: ev, key: null })),
        { label:'TOTAL', key: null },
        { label:'', key:'delta' } // clickable aunque sin texto
      ];

      thead.innerHTML = `<tr>${
        headCells.map((h,i)=>{
          const cls = (h.key ? '' : 'nosort');
          const attrs = h.key ? ` data-sort="${h.key}"` : '';
          const title = h.key==='delta' ? 'Ordenar por diferencia' :
                        h.key==='bib'   ? 'Ordenar por dorsal' :
                        h.key==='name'  ? 'Ordenar por nombre' : '';
          const wStyle = (i===0?' style="width:72px"':'');
          return `<th${attrs} class="${cls}"${wStyle} title="${title}">${h.label}</th>`;
        }).join('')
      }</tr>`;

      // Ordenación según sortKey/sortDir
      const rows = model.rows.slice();
      const cmp = (a,b)=>{
        const dir = (sortDir==='asc'? 1 : -1);
        if (sortKey==='bib'){
          const aval = a.bib===''? Number.POSITIVE_INFINITY : Number.isNaN(+a.bib)? a.bib : +a.bib;
          const bval = b.bib===''? Number.POSITIVE_INFINITY : Number.isNaN(+b.bib)? b.bib : +b.bib;
          if (typeof aval==='number' && typeof bval==='number') return (aval-bval)*dir;
          return String(aval).localeCompare(String(bval),'es',{numeric:true,sensitivity:'base'})*dir;
        }else if (sortKey==='name'){
          return a.name.localeCompare(b.name,'es',{sensitivity:'base'})*dir;
        }else if (sortKey==='delta'){
          const av = (typeof a.delta==='number')? a.delta : Number.POSITIVE_INFINITY;
          const bv = (typeof b.delta==='number')? b.delta : Number.POSITIVE_INFINITY;
          if (av===bv) return 0; return (av<bv?-1:1)*dir;
        }else{ // total (fallback)
          const av = (typeof a.total==='number')? a.total : Number.POSITIVE_INFINITY;
          const bv = (typeof b.total==='number')? b.total : Number.POSITIVE_INFINITY;
          if (av===bv) return 0; return (av<bv?-1:1)*dir;
        }
      };
      rows.sort(cmp);

      // Cuerpo
      tbody.innerHTML = rows.map(r=>{
        const cells = [
          `<td class="bib">${r.bib||'—'}</td>`,
          `<td class="name">${r.name}</td>`,
          ...model.events.map(ev=>{
            const ms = r.tiempos[ev];
            return `<td class="time">${typeof ms==='number'? fmt(ms) : '—'}</td>`;
          }),
          `<td class="total time">${fmt(r.total)}</td>`,
          `<td class="delta">${r.delta==null?'': ('+'+fmt(r.delta))}</td>`
        ];
        return `<tr>${cells.join('')}</tr>`;
      }).join('');

      // Eventos incluidos + modelo para PDF
      $('eventsJoined').textContent = 'Eventos incluidos: ' + (model.events.length? model.events.join(' + ') : '—');
      lastTableModel = {
        head: ['Dorsal','Participante', ...model.events, 'TOTAL', ''],
        body: rows.map(r=>[
          r.bib||'',
          r.name,
          ...model.events.map(ev=> typeof r.tiempos[ev]==='number' ? fmt(r.tiempos[ev]) : '—' ),
          fmt(r.total),
          r.delta==null?'':('+'+fmt(r.delta))
        ])
      };

      // Listeners de ordenación
      thead.querySelectorAll('th[data-sort]').forEach(th=>{
        th.onclick = ()=> toggleSort(th.getAttribute('data-sort'));
      });
    }

    await renderCombined();

    // ====== PDF (UMD) ======
    async function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src=src; s.async=true; s.onload=()=>resolve(); s.onerror=()=>reject(new Error('No se pudo cargar '+src));
        document.head.appendChild(s);
      });
    }
    async function ensureJsPDF(){
      if(window.jspdf && window.jspdf.jsPDF && window.jspdf.autoTable) return;
      if(!(window.jspdf && window.jspdf.jsPDF)){
        await loadScript('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
      }
      if(!window.jspdf?.autoTable){
        await loadScript('https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js');
      }
    }

    async function exportPDF(){
      try{
        const btn = $('btnPDF'); btn.disabled=true;
        await ensureJsPDF();
        const docx = new window.jspdf.jsPDF({orientation:'p', unit:'pt', format:'a4'});
        const marginX = 28, marginY = 32;

        // Cabecera limpia
        docx.setFont('helvetica','bold'); docx.setFontSize(14);
        docx.text('RESULTADOS', marginX, marginY);
        docx.setFont('helvetica','normal'); docx.setFontSize(10);
        docx.text(`Usuario: ${ (currentCtx().email||uid) }`, marginX, marginY+14);
        docx.text(`Fecha/hora: ${ new Date().toLocaleString() }`, marginX, marginY+28);
        docx.text(`Eventos: ${ selectedCodes.join(' + ') }`, marginX, marginY+42);

        const { head, body } = lastTableModel;
        docx.autoTable({
          startY: marginY + 56,
          head: [head],
          body,
          styles: { font: 'helvetica', fontSize: 10, halign: 'left', valign: 'middle' },
          headStyles: { fillColor: [246,248,251], textColor: [0,0,0], lineWidth: 0.4, lineColor: [207,212,221] },
          bodyStyles: { fillColor: [255,255,255], textColor: [0,0,0], lineWidth: 0.25, lineColor: [230,234,241] },
          alternateRowStyles: { fillColor: [248,250,253] },
          columnStyles: {
            0: { cellWidth: 60 },  // Dorsal
            1: { cellWidth: 150 }  // Participante
          },
          theme: 'grid',
          margin: { left: marginX, right: marginX }
        });

        docx.save(`resultados_${selectedCodes.join('+')}.pdf`);
      }catch(err){
        alert('No se pudo generar el PDF: '+(err?.message||err));
      }finally{
        $('btnPDF').disabled=false;
      }
    }
  </script>
</body>
</html>
