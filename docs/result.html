<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono — RESULTADOS</title>
  <style>
    :root{
      --bg:#10141b; --panel:#161c24; --panel2:#1b2330;
      --text:#eaf0f8; --muted:#b5c0d1; --border:#2a3342;
      --accent:#6eb0ff; --accent-2:#8ec5ff; --ok:#7cffb6; --err:#ff7a8a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1300px 800px at 20% -10%, #131a27 0%, transparent 60%),
                  radial-gradient(1200px 900px at 120% 10%, #192134 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 14px}
    .title{font-weight:900;letter-spacing:.06em;text-transform:uppercase}
    .muted{color:var(--muted)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:12px;border:1px solid var(--border);
      background:#0f141c;color:var(--text);cursor:pointer;text-decoration:none;
      text-transform:uppercase;font-weight:900;letter-spacing:.03em;min-height:42px;
      transition:background .15s,border-color .15s,transform .05s;
    }
    .btn:hover{background:#141a24}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#091320}
    .btn.primary:hover{background:var(--accent-2);border-color:var(--accent-2)}

    .table-wrap{width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch}
    table{width:100%; border-collapse:separate; border-spacing:0 8px; min-width: 520px;}
    thead th{
      text-align:left;padding:10px 12px;font-weight:800;text-transform:uppercase;letter-spacing:.04em;color:var(--muted);
      white-space:nowrap;
    }
    tbody tr{background:var(--panel2);border:1px solid var(--border)}
    tbody td{padding:12px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);vertical-align:middle}
    tbody tr td:first-child{border-left:1px solid var(--border);border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-right:1px solid var(--border);border-top-right-radius:10px;border-bottom-right-radius:10px}
    .pos{width:64px;text-align:center;font-weight:900;white-space:nowrap}
    .name{font-weight:900;text-transform:uppercase;max-width: 44vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .time{font-weight:900;letter-spacing:.4px; white-space:nowrap}
    .delta{font-weight:800;letter-spacing:.3px;color:var(--muted); white-space:nowrap; text-align:right}
    .ok{color:var(--ok)} .err{color:var(--err)}

    @media (max-width: 430px){
      .wrap{padding:12px}
      .card{padding:12px}
      thead th{padding:8px 10px; font-size:12px}
      tbody td{padding:8px 10px; font-size:13px}
      .pos{width:44px}
      .name{max-width: 46vw}
      .time{font-size:13px}
      .delta{font-size:12px}
      table{min-width:480px}
    }
    @media (max-width: 360px){
      thead th{font-size:11px}
      tbody td{font-size:12px}
      .name{max-width: 42vw}
      .delta{font-size:11px}
      table{min-width:460px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1 class="title" id="r-title">RESULTADOS</h1>
      <div class="actions">
        <button id="btnRefresh" class="btn"><span id="r-refresh">Refrescar</span></button>
        <button id="btnPDF" class="btn primary"><span id="r-pdf">Descargar PDF</span></button>
      </div>
    </div>

    <div class="card" style="margin-bottom:12px">
      <div><span id="r-event">Evento</span>: <b id="evCode">—</b></div>
      <div><span id="r-date">Fecha</span>: <b id="evDate">—</b></div>
      <div class="muted" id="meta">—</div>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th id="r-part">Participante</th>
              <th id="r-time">Tiempo</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="4" class="muted" style="padding:20px;text-align:center">Cargando…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    // ===== i18n (solo textos) =====
    const L = {
      ca:{ title:'RESULTATS', refresh:'Actualitzar', pdf:'Descarregar PDF', event:'Esdeveniment', date:'Data',
           participant:'Participant', time:'Temps',
           missing:'Falta el paràmetre ?code=ESDEVENIMENT',
           none:'Sense participants',
           stats:(t,f)=>`${t} participants • ${f} finalitzats`,
           pdfTitle:(code)=>`RESULTATS — ${code||'ESDEVENIMENT'}` },
      en:{ title:'RESULTS', refresh:'Refresh', pdf:'Download PDF', event:'Event', date:'Date',
           participant:'Participant', time:'Time',
           missing:'Missing ?code=EVENT',
           none:'No participants',
           stats:(t,f)=>`${t} participants • ${f} finished`,
           pdfTitle:(code)=>`RESULTS — ${code||'EVENT'}` },
      es:{ title:'RESULTADOS', refresh:'Refrescar', pdf:'Descargar PDF', event:'Evento', date:'Fecha',
           participant:'Participante', time:'Tiempo',
           missing:'Falta el parámetro ?code=EVENTO',
           none:'Sin participantes',
           stats:(t,f)=>`${t} participantes • ${f} finalizados`,
           pdfTitle:(code)=>`RESULTADOS — ${code||'EVENTO'}` }
    };
    const lang = localStorage.getItem('lang') || 'ca';
    function applyI18n(){
      const T=L[lang];
      document.getElementById('r-title').textContent=T.title;
      document.getElementById('r-refresh').textContent=T.refresh;
      document.getElementById('r-pdf').textContent=T.pdf;
      document.getElementById('r-event').textContent=T.event;
      document.getElementById('r-date').textContent=T.date;
      document.getElementById('r-part').textContent=T.participant;
      document.getElementById('r-time').textContent=T.time;
    }
    applyI18n();

    // ===== Utils & estado =====
    const $=(id)=>document.getElementById(id);
    const two=(n)=>String(n).padStart(2,'0');
    const three=(n)=>String(n).padStart(3,'0');
    const fmt=(ms)=>{ ms=Math.max(0,Math.floor(ms||0));
      const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), ms3=ms%1000;
      return `${two(m)}:${two(s)}.${three(ms3)}`; };
    const tsMs=(ts)=> ts ? (ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6)) : null;
    const qp=new URL(location.href).searchParams;
    const code=(qp.get('code')||'').toUpperCase();
    $('evCode').textContent = code || '—';

    let evDateStr = '—';
    let orderedRows = [];

    // ===== Firebase (CDN) =====
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore, doc, collection, getDocs, query, orderBy, getDoc
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    async function load(){
      const T=L[lang];
      if(!code){
        $('tbody').innerHTML = `<tr><td colspan="4" class="err" style="padding:20px;text-align:center">${T.missing}</td></tr>`;
        return;
      }

      // Evento (fecha)
      const evRef = doc(db,'events',code);
      const evSnap = await getDoc(evRef);
      if (evSnap.exists()) {
        const d = evSnap.data();
        const baseTS = d.updatedAt || d.createdAt || null;
        const ms = tsMs(baseTS);
        if (ms) {
          evDateStr = new Date(ms).toLocaleString(lang==='en'?'en-GB':(lang==='ca'?'ca-ES':'es-ES'));
          $('evDate').textContent = evDateStr;
        } else {
          evDateStr = '—';
          $('evDate').textContent = '—';
        }
      } else {
        $('evDate').textContent = '—';
      }

      // Participantes
      const partsCol = collection(evRef,'participants');
      const snap = await getDocs(query(partsCol, orderBy('order','asc')));

      const rows = snap.docs.map(d=>{
        const x=d.data();
        const startMS=tsMs(x.startTS), stopMS=tsMs(x.stopTS);
        const dur = (startMS!=null && stopMS!=null) ? (stopMS-startMS) : null;
        return {
          id:d.id,
          name:(x.name||'').toUpperCase(),
          order:x.order||0,
          startMS, stopMS, dur
        };
      });

      const finished   = rows.filter(r=>r.dur!=null).sort((a,b)=> a.dur - b.dur);
      const unfinished = rows.filter(r=>r.dur==null);
      orderedRows = [...finished, ...unfinished];

      const leaderDur = finished.length ? finished[0].dur : null;

      const tbody = $('tbody');
      if(orderedRows.length===0){
        tbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:20px;text-align:center">${T.none}</td></tr>`;
        $('meta').textContent = T.stats(0,0);
        return;
      }

      tbody.innerHTML = orderedRows.map((r)=>{
        const t = r.dur!=null ? fmt(r.dur) : '—';
        const pos = (r.dur!=null) ? (finished.indexOf(r)+1) : '—';
        let delta = '—';
        if (leaderDur!=null && r.dur!=null) {
          const diff = r.dur - leaderDur;
          delta = diff===0 ? '+00:00.000' : ('+' + fmt(diff));
        }
        return `
          <tr>
            <td class="pos">${pos}</td>
            <td class="name">${r.name}</td>
            <td class="time">${t}</td>
            <td class="delta">${delta}</td>
          </tr>`;
      }).join('');

      const total = rows.length;
      const fin   = finished.length;
      $('meta').textContent = T.stats(total, fin);
    }

    function downloadPDF(){
      const T=L[lang];
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });

      const title = T.pdfTitle(code);
      doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text(title, 30, 40);
      doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.text(`${T.date}: ${evDateStr}`, 30, 58);

      const head = [['#',T.participant,T.time,'']];

      const finishedOnly = orderedRows.filter(r => r.dur!=null);
      const leaderDur = finishedOnly.length ? finishedOnly[0].dur : null;

      const body = orderedRows.map((r)=>{
        const rank = (r.dur!=null) ? (finishedOnly.indexOf(r)+1) : '—';
        const time = (r.dur!=null) ? fmt(r.dur) : '—';
        let delta = '—';
        if (leaderDur!=null && r.dur!=null) {
          const diff = r.dur - leaderDur;
          delta = diff===0 ? '+00:00.000' : ('+' + fmt(diff));
        }
        return [String(rank), r.name, time, delta];
      });

      doc.autoTable({
        head, body,
        startY: 74,
        margin: { left: 30, right: 30 },
        styles: { font: 'helvetica', fontSize: 11, lineColor: [210,210,210], lineWidth: 0.5 },
        headStyles: { fillColor: [110,176,255], textColor: 20, halign: 'left' },
        bodyStyles: { fillColor: [250,250,250] },
        alternateRowStyles: { fillColor: [240,240,240] },
        columnStyles: {
          0: { cellWidth: 40,  halign:'center', fontStyle:'bold' },
          1: { cellWidth: 240, fontStyle:'bold' },
          2: { cellWidth: 110, halign:'right', fontStyle:'bold' },
          3: { cellWidth: 100, halign:'right' }
        },
        tableWidth: 'wrap'
      });

      doc.save(`resultados_${(code||'EVENTO')}.pdf`);
    }

    $('btnRefresh').onclick = ()=>load();
    $('btnPDF').onclick = ()=>downloadPDF();

    load();
  </script>
</body>
</html>
