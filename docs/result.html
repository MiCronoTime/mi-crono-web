<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono — RESULTADOS</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    :root{
      --bg:#121418;
      --card:#1b1f27;
      --card-2:#232a34;
      --text:#e8ecf1;
      --muted:#b5bdc9;
      --border:#2b3240;
      --accent:#5ea1ff;
      --accent-2:#7cc4ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #151924 0%, transparent 60%),
                  radial-gradient(1200px 800px at 120% 10%, #1a2030 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{color:var(--accent-2)}

    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .tag{opacity:.9}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap}

    /* Botones coherentes con el resto (uppercase + bold) */
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:11px 16px;border-radius:12px;
      border:1px solid var(--border);
      background:#0f1217;color:var(--text);
      cursor:pointer; user-select:none;
      transition:transform .05s ease, background .15s, border-color .15s, color .15s;
      text-transform: uppercase; font-weight:800; letter-spacing:.03em;
      font-size:14px; line-height:1;
      text-decoration:none;
    }
    .btn:hover{ background:#12161d }
    .btn:active{ transform:translateY(1px) }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#0b1220 }
    .btn.primary:hover{ background:var(--accent-2); border-color:var(--accent-2) }

    .big{font-size:38px;font-weight:900;letter-spacing:.5px}
    .muted{color:var(--muted)}

    table{width:100%;border-collapse:collapse;margin-top:10px;background:var(--card-2);border-radius:12px;overflow:hidden}
    th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left}
    th{background:#202633;font-weight:800;text-transform:uppercase;color:#eaf2ff}
    td{color:#e8ecf1}
    tr:last-child td{border-bottom:none}
    .num{width:60px}
    .name{text-transform:uppercase} /* nombres en mayúsculas al presentar */
    .time{font-weight:800}

    .sectionTitle{margin:12px 0 8px 0;text-transform:uppercase;letter-spacing:.04em}
  </style>

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body class="wrap">
  <header class="top">
    <h1 class="sectionTitle">RESULTADOS</h1>
    <p class="tag" id="subtitle">—</p>
  </header>

  <main class="grid one">
    <section class="card">
      <div class="big" id="overall">—</div>
      <p class="muted" id="details">—</p>
      <div class="row" style="margin-top:6px">
        <button id="btnPDF" class="btn primary">DESCARGAR PDF</button>
        <a class="btn" href="index.html">NUEVO EVENTO</a>
      </div>

      <h2 class="sectionTitle">Participantes</h2>
      <table>
        <thead><tr><th class="num">#</th><th>Nombre</th><th>Tiempo</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
  </main>

  <script type="module">
    const getParam=(k)=> new URL(location.href).searchParams.get(k);
    const code=(getParam('code')||'').toUpperCase();
    document.getElementById('subtitle').textContent = code ? `Evento ${code}` : 'Sin código';

    const two = (n)=> String(n).padStart(2,'0');
    const three = (n)=> String(n).padStart(3,'0');
    const fmt = (ms)=>{ ms=Math.max(0, Math.floor(ms||0));
      const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), ms3=ms%1000;
      return `${two(m)}:${two(s)}.${three(ms3)}`; };
    const tsToMillis = (ts)=> ts ? (ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6)) : null;

    try{
      const { initializeApp, getApp, getApps } = await import("https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js");
      const { getFirestore, doc, collection, query, orderBy, getDocs } =
        await import("https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js");

      const firebaseConfig = {
        apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
        authDomain: "mi-crono-time-888b7.firebaseapp.com",
        projectId: "mi-crono-time-888b7",
        storageBucket: "mi-crono-time-888b7.appspot.com",
        messagingSenderId: "379025900327",
        appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
      };

      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const db  = getFirestore(app);

      const eventRef = doc(db,"events",code);
      const partsCol = collection(eventRef,"participants");

      async function loadParticipants(){
        const snap = await getDocs(query(partsCol, orderBy('order','asc')));
        return snap.docs.map(d=>{
          const x=d.data();
          const start = tsToMillis(x.startTS) ?? null;
          const stop  = tsToMillis(x.stopTS)  ?? null;
          const dur   = (start && stop) ? (stop - start) : null;
          return { order:x.order||0, name:(x.name||'').toUpperCase(), start, stop, dur };
        });
      }

      async function render(){
        const rows = await loadParticipants();

        // Tabla
        const tbody=document.getElementById('tbody');
        tbody.innerHTML='';
        rows.forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td class="num">${r.order}</td><td class="name">${r.name}</td><td class="time">${r.dur!=null?fmt(r.dur):'—'}</td>`;
          tbody.appendChild(tr);
        });

        // Resumen general (solo serverTS)
        const starts = rows.map(r=>r.start).filter(Boolean);
        const stops  = rows.map(r=>r.stop).filter(Boolean);
        const minStart = starts.length? Math.min(...starts) : null;
        const maxStop  = stops.length?  Math.max(...stops)  : null;
        const overall  = (minStart && maxStop) ? fmt(maxStop-minStart) : '—';
        document.getElementById('overall').textContent = overall;
        document.getElementById('details').textContent =
          `Inicio: ${minStart?new Date(minStart).toLocaleTimeString():'—'} | Fin: ${maxStop?new Date(maxStop).toLocaleTimeString():'—'} | Duración: ${overall}`;
      }

      await render();

      // PDF
      document.getElementById('btnPDF').onclick = async ()=>{
        const rows = await loadParticipants();
        const { jsPDF } = window.jspdf;
        const docPdf = new jsPDF({unit:'pt', format:'a4'});

        let y=50;
        docPdf.setFontSize(16);
        docPdf.text(`Mi Crono — Resultados (${code})`, 40, y); y+=24;
        docPdf.setFontSize(10);
        docPdf.text(`Generado: ${new Date().toLocaleString()}`, 40, y); y+=10;

        const starts = rows.map(r=>r.start).filter(Boolean);
        const stops  = rows.map(r=>r.stop).filter(Boolean);
        const minStart = starts.length? Math.min(...starts) : null;
        const maxStop  = stops.length?  Math.max(...stops)  : null;
        const overallText = (minStart&&maxStop)? ( (maxStop-minStart) ) : null;
        y+=18; docPdf.setFontSize(12); docPdf.text(`Tiempo total: ${overallText!=null?fmt(overallText):'—'}`, 40, y); y+=16;

        const colX=[40, 80, 360];
        docPdf.setFontSize(12);
        docPdf.text('#', colX[0], y);
        docPdf.text('Nombre', colX[1], y);
        docPdf.text('Tiempo', colX[2], y);
        y+=12; docPdf.line(40,y, 550,y); y+=10;

        docPdf.setFontSize(12);
        rows.forEach(r=>{
          docPdf.text(String(r.order||''), colX[0], y);
          docPdf.text(String((r.name||'').toUpperCase()),  colX[1], y);
          docPdf.text(String(r.dur!=null?fmt(r.dur):'—'), colX[2], y);
          y+=20; if(y>780){ docPdf.addPage(); y=50; }
        });

        docPdf.save(`resultado_${code}.pdf`);
      };

    }catch(e){
      alert('Error cargando resultados: '+(e.message||e));
    }
  </script>
</body>
</html>
