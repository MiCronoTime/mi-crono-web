<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono — Resultado</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .big{font-size:38px;font-weight:800;letter-spacing:.5px}
    .debug{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#f6f6f6;border-radius:8px;padding:8px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left}
    th{background:#fafafa}
    .ok{color:#0a7a0a;font-weight:600}
    .err{color:#b00020;font-weight:600}
  </style>
  <!-- jsPDF para generar PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body class="wrap">
  <header class="top"><h1>Resultados</h1><p class="tag" id="subtitle"></p></header>

  <main class="grid one">
    <section class="card">
      <div>Firebase: <span id="fbState">—</span></div>
      <div class="big" id="overall">—</div>
      <p class="muted" id="details">—</p>
      <div class="row" style="margin-top:6px">
        <button id="btnPDF" class="btn">Descargar PDF</button>
        <a class="btn" href="index.html">Nuevo evento</a>
      </div>

      <h2 style="margin-top:14px">Participantes</h2>
      <table id="tbl">
        <thead><tr><th>#</th><th>Nombre</th><th>Tiempo</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <section class="card">
      <h2>Depuración</h2>
      <div class="debug" id="lastError">—</div>
    </section>
  </main>

  <script type="module">
    window.__firebaseReady=false; window.__firebaseError=null;

    const getParam=(k)=> new URL(location.href).searchParams.get(k);
    const code=(getParam('code')||'').toUpperCase();
    document.getElementById('subtitle').textContent = code ? `Evento ${code}` : 'Sin código';

    const fbStateEl=document.getElementById('fbState');
    const lastErrorEl=document.getElementById('lastError');
    const tbody=document.getElementById('tbody');
    const overall=document.getElementById('overall');
    const details=document.getElementById('details');

    const two = (n)=> String(n).padStart(2,'0');
    const three = (n)=> String(n).padStart(3,'0');
    const fmt = (ms)=>{ ms=Math.max(0, Math.floor(ms||0));
      const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), ms3=ms%1000;
      return `${two(m)}:${two(s)}.${three(ms3)}`; };
    const tsToMillis = (ts)=> ts ? (typeof ts==='number'?ts:(ts.seconds*1000+Math.floor((ts.nanoseconds||0)/1e6))) : null;

    function paintFirebase(){
      fbStateEl.textContent = window.__firebaseReady ? "OK" : "ERROR";
      fbStateEl.className   = window.__firebaseReady ? "ok" : "err";
      if(!window.__firebaseReady){
        const msg  = window.__firebaseError && (window.__firebaseError.message || String(window.__firebaseError)) || 'sin detalle';
        lastErrorEl.textContent = `Init Firebase error: ${msg}`;
      } else lastErrorEl.textContent='—';
    }

    try{
      const { initializeApp, getApp, getApps } = await import("https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js");
      const { getFirestore, doc, collection, query, orderBy, getDocs } =
        await import("https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js");

      const firebaseConfig = {
        apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
        authDomain: "mi-crono-time-888b7.firebaseapp.com",
        projectId: "mi-crono-time-888b7",
        storageBucket: "mi-crono-time-888b7.appspot.com",
        messagingSenderId: "379025900327",
        appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
      };

      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const db  = getFirestore(app);
      window.__firebaseReady=true; paintFirebase();

      const eventRef = doc(db,"events",code);
      const partsCol = collection(eventRef,"participants");

      async function loadParticipants(){
        const snap = await getDocs(query(partsCol, orderBy('order','asc')));
        const rows = snap.docs.map(d=>{
          const x=d.data();
          const start = tsToMillis(x.startTS) ?? x.startClientMS ?? null;
          const stop  = tsToMillis(x.stopTS)  ?? x.stopClientMS  ?? null;
          const dur   = (start && stop) ? (stop - start) : null;
          return { order:x.order||0, name:x.name||'', start, stop, dur };
        });
        return rows;
      }

      async function render(){
        const rows = await loadParticipants();

        // Tabla
        tbody.innerHTML='';
        rows.forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${r.order}</td><td>${r.name}</td><td>${r.dur!=null?fmt(r.dur):'—'}</td>`;
          tbody.appendChild(tr);
        });

        // "Overall": desde el primer start hasta el último stop (si existen)
        const starts = rows.map(r=>r.start).filter(Boolean);
        const stops  = rows.map(r=>r.stop).filter(Boolean);
        const minStart = starts.length? Math.min(...starts) : null;
        const maxStop  = stops.length?  Math.max(...stops)  : null;

        overall.textContent = (minStart && maxStop) ? fmt(maxStop-minStart) : '—';
        details.textContent =
          `Inicio: ${minStart?new Date(minStart).toLocaleTimeString():'—'} | Fin: ${maxStop?new Date(maxStop).toLocaleTimeString():'—'} | Duración: ${(minStart&&maxStop)?fmt(maxStop-minStart):'—'}`;
      }

      await render();

      // PDF
      document.getElementById('btnPDF').onclick = async ()=>{
        const rows = await loadParticipants();
        const { jsPDF } = window.jspdf;
        const docPdf = new jsPDF({unit:'pt', format:'a4'});

        let y=50;
        docPdf.setFontSize(16);
        docPdf.text(`Mi Crono — Resultados (${code})`, 40, y); y+=24;
        docPdf.setFontSize(10);
        docPdf.text(`Generado: ${new Date().toLocaleString()}`, 40, y); y+=10;

        // Overall
        const starts = rows.map(r=>r.start).filter(Boolean);
        const stops  = rows.map(r=>r.stop).filter(Boolean);
        const minStart = starts.length? Math.min(...starts) : null;
        const maxStop  = stops.length?  Math.max(...stops)  : null;
        const overallText = (minStart&&maxStop)? fmt(maxStop-minStart) : '—';
        y+=18; docPdf.setFontSize(12); docPdf.text(`Tiempo total: ${overallText}`, 40, y); y+=16;

        // Cabecera tabla
        const colX=[40, 80, 360]; // #, Nombre, Tiempo
        docPdf.setFontSize(12);
        docPdf.text('#', colX[0], y);
        docPdf.text('Nombre', colX[1], y);
        docPdf.text('Tiempo', colX[2], y);
        y+=12; docPdf.line(40,y, 550,y); y+=10;

        // Filas
        docPdf.setFontSize(12);
        rows.forEach(r=>{
          docPdf.text(String(r.order||''), colX[0], y);
          docPdf.text(String(r.name||''),  colX[1], y);
          docPdf.text(String(r.dur!=null?fmt(r.dur):'—'), colX[2], y);
          y+=20;
          if(y>780){ docPdf.addPage(); y=50; }
        });

        docPdf.save(`resultado_${code}.pdf`);
      };

    }catch(e){
      window.__firebaseError=e; window.__firebaseReady=false; paintFirebase();
    }

    paintFirebase();
  </script>
</body>
</html>
