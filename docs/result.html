<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono — RESULTADOS</title>
  <style>
    :root{
      --bg:#10141b; --panel:#161c24; --panel2:#1b2330;
      --text:#eaf0f8; --muted:#b5c0d1; --border:#2a3342;
      --accent:#6eb0ff; --accent-2:#8ec5ff; --ok:#7cffb6; --err:#ff7a8a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1300px 800px at 20% -10%, #131a27 0%, transparent 60%),
                  radial-gradient(1200px 900px at 120% 10%, #192134 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 14px}
    .title{font-weight:900;letter-spacing:.06em;text-transform:uppercase}
    .muted{color:var(--muted)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:12px;border:1px solid var(--border);
      background:#0f141c;color:var(--text);cursor:pointer;text-decoration:none;
      text-transform:uppercase;font-weight:900;letter-spacing:.03em;min-height:42px;
      transition:background .15s,border-color .15s,transform .05s;
    }
    .btn:hover{background:#141a24}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#091320}
    .btn.primary:hover{background:var(--accent-2);border-color:var(--accent-2)}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{
      text-align:left;padding:10px 12px;font-weight:800;text-transform:uppercase;letter-spacing:.04em;color:var(--muted)
    }
    tbody tr{background:var(--panel2);border:1px solid var(--border)}
    tbody td{padding:12px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    tbody tr td:first-child{border-left:1px solid var(--border);border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-right:1px solid var(--border);border-top-right-radius:10px;border-bottom-right-radius:10px}
    .pos{width:64px;text-align:center;font-weight:900}
    .name{font-weight:900;text-transform:uppercase}
    .time{font-weight:900;letter-spacing:.4px}
    .ok{color:var(--ok)} .err{color:var(--err)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1 class="title">RESULTADOS</h1>
      <div class="actions">
        <button id="btnRefresh" class="btn">Refrescar</button>
        <button id="btnPDF" class="btn primary">Descargar PDF</button>
      </div>
    </div>

    <!-- Tarjeta de cabecera con código y FECHA/HORA del evento -->
    <div class="card" style="margin-bottom:12px">
      <div>Evento: <b id="evCode">—</b></div>
      <div>Fecha: <b id="evDate">—</b></div>
      <div class="muted" id="meta">—</div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Participante</th>
            <th>Tiempo</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="3" class="muted" style="padding:20px;text-align:center">Cargando…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- jsPDF + AutoTable (CDN) para exportar a PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    // ===== Utils =====
    const $=(id)=>document.getElementById(id);
    const two=(n)=>String(n).padStart(2,'0');
    const three=(n)=>String(n).padStart(3,'0');
    const fmt=(ms)=>{ ms=Math.max(0,Math.floor(ms||0));
      const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), ms3=ms%1000;
      return `${two(m)}:${two(s)}.${three(ms3)}`; };
    const tsMs=(ts)=> ts ? (ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6)) : null;
    const qp=new URL(location.href).searchParams;
    const code=(qp.get('code')||'').toUpperCase();
    $('evCode').textContent = code || '—';

    // Guardamos fecha para PDF
    let evDateStr = '—';

    // ===== Firebase (CDN) =====
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore, doc, collection, getDocs, query, orderBy, getDoc
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Estado global de filas ordenadas para reutilizar en PDF
    let orderedRows = [];

    async function load(){
      if(!code){
        $('tbody').innerHTML = `<tr><td colspan="3" class="err" style="padding:20px;text-align:center">Falta el parámetro ?code=EVENTO</td></tr>`;
        return;
      }

      // === 1) Leer FECHA/HORA del evento (updatedAt || createdAt)
      const evRef = doc(db,'events',code);
      const evSnap = await getDoc(evRef);
      if (evSnap.exists()) {
        const d = evSnap.data();
        const baseTS = d.updatedAt || d.createdAt || null;
        const ms = tsMs(baseTS);
        if (ms) {
          evDateStr = new Date(ms).toLocaleString('es-ES');
          $('evDate').textContent = evDateStr;
        } else {
          evDateStr = '—';
          $('evDate').textContent = '—';
        }
      } else {
        $('evDate').textContent = '—';
      }

      // === 2) Participantes y ordenación por tiempo (mejor→peor)
      const partsCol = collection(evRef,'participants');
      const snap = await getDocs(query(partsCol, orderBy('order','asc')));

      const rows = snap.docs.map(d=>{
        const x=d.data();
        const startMS=tsMs(x.startTS), stopMS=tsMs(x.stopTS);
        const dur = (startMS!=null && stopMS!=null) ? (stopMS-startMS) : null;
        return {
          id:d.id,
          name:(x.name||'').toUpperCase(),
          order:x.order||0,
          startMS, stopMS, dur
        };
      });

      const finished   = rows.filter(r=>r.dur!=null).sort((a,b)=> a.dur - b.dur);
      const unfinished = rows.filter(r=>r.dur==null);
      orderedRows = [...finished, ...unfinished];

      // Pintar tabla
      const tbody = $('tbody');
      if(orderedRows.length===0){
        tbody.innerHTML = `<tr><td colspan="3" class="muted" style="padding:20px;text-align:center">Sin participantes</td></tr>`;
        $('meta').textContent = '0 participantes';
        return;
      }

      tbody.innerHTML = orderedRows.map((r)=>{
        const t = r.dur!=null ? fmt(r.dur) : '—';
        const pos = (r.dur!=null) ? (finished.indexOf(r)+1) : '—';
        return `
          <tr>
            <td class="pos">${pos}</td>
            <td class="name">${r.name}</td>
            <td class="time">${t}</td>
          </tr>`;
      }).join('');

      const total = rows.length;
      const fin   = finished.length;
      $('meta').textContent = `${total} participantes • ${fin} finalizados`;
    }

    // ===== PDF (orden como en pantalla) =====
    function downloadPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' }); // 72pt = 1in

      // Título + Fecha
      const title = `RESULTADOS — ${code || 'EVENTO'}`;
      doc.setFont('helvetica','bold');
      doc.setFontSize(16);
      doc.text(title, 40, 40);

      doc.setFont('helvetica','normal');
      doc.setFontSize(11);
      doc.text(`Fecha: ${evDateStr}`, 40, 58);

      // Datos
      const head = [['#','PARTICIPANTE','TIEMPO']];
      const onlyFinished = orderedRows.filter(r => r.dur != null);
      const body = orderedRows.map((r)=>{
        const rank = (r.dur!=null) ? (onlyFinished.indexOf(r)+1) : '—';
        const time = (r.dur!=null) ? fmt(r.dur) : '—';
        return [String(rank), r.name, time];
      });

      doc.autoTable({
        head,
        body,
        startY: 74,
        styles: { font: 'helvetica', fontSize: 11, lineColor: [210,210,210], lineWidth: 0.5 },
        headStyles: { fillColor: [110,176,255], textColor: 20, halign: 'left' },
        bodyStyles: { fillColor: [250,250,250] },
        alternateRowStyles: { fillColor: [240,240,240] },
        columnStyles: {
          0: { cellWidth: 50, halign:'center', fontStyle:'bold' },
          1: { cellWidth: 320, fontStyle:'bold' },
          2: { cellWidth: 100, halign:'right', fontStyle:'bold' }
        },
        margin: { left: 40, right: 40 }
      });

      doc.save(`resultados_${(code||'EVENTO')}.pdf`);
    }

    $('btnRefresh').onclick = ()=>load();
    $('btnPDF').onclick = ()=>downloadPDF();

    load();
  </script>
</body>
</html>
