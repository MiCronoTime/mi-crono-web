<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono — RESULTADOS</title>
  <style>
    :root{
      --bg:#10141b; --panel:#161c24; --panel2:#1b2330;
      --text:#eaf0f8; --muted:#b5c0d1; --border:#2a3342;
      --accent:#6eb0ff; --accent-2:#8ec5ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#10141b;color:#eaf0f8}
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 14px}
    .title{font-weight:900;letter-spacing:.06em;text-transform:uppercase}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#0f141c;color:#eaf0f8;text-decoration:none;text-transform:uppercase;font-weight:900}
    .btn.primary{background:var(--accent);color:#091320;border-color:var(--accent)}

    .table-wrap{width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch}
    table{width:100%; border-collapse:separate; border-spacing:0 8px; min-width: 620px;}
    thead th{ text-align:left;padding:10px 12px;font-weight:800;text-transform:uppercase;letter-spacing:.04em;color:var(--muted); white-space:nowrap;}
    tbody tr{background:#1b2330;border:1px solid var(--border)}
    tbody td{padding:12px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);vertical-align:middle}
    tbody tr td:first-child{border-left:1px solid var(--border);border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-right:1px solid var(--border);border-top-right-radius:10px;border-bottom-right-radius:10px}
    .pos{width:56px;text-align:center;font-weight:900;white-space:nowrap}
    .name{font-weight:900;text-transform:uppercase;max-width:36vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .time{font-weight:900;letter-spacing:.4px;white-space:nowrap}
    .delta{font-weight:800;letter-spacing:.3px;color:#b5c0d1;white-space:nowrap;text-align:right}

    @media (max-width: 430px){
      .wrap{padding:12px}
      .card{padding:12px}
      thead th{padding:8px 10px;font-size:12px}
      tbody td{padding:8px 10px;font-size:13px}
      .pos{width:44px}
      .name{max-width: 42vw}
      .delta{font-size:12px}
      table{min-width:580px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1 class="title">RESULTADOS</h1>
      <div class="actions">
        <button id="btnRefresh" class="btn">Refrescar</button>
        <button id="btnPDF" class="btn primary">Descargar PDF</button>
      </div>
    </div>

    <div class="card" style="margin-bottom:12px">
      <div>Evento: <b id="evCode">—</b></div>
      <div>Fecha: <b id="evDate">—</b></div>
      <div id="meta" style="opacity:.8">—</div>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Participante</th>
              <th>Split</th>
              <th>Tiempo</th>
              <th></th> <!-- Δ sin título -->
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="5" style="padding:20px;text-align:center;opacity:.8">Cargando…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    const $=(id)=>document.getElementById(id);
    const two=(n)=>String(n).padStart(2,'0');
    const three=(n)=>String(n).padStart(3,'0');
    const fmt=(ms)=>{ ms=Math.max(0,Math.floor(ms||0));
      const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), ms3=ms%1000;
      return `${two(m)}:${two(s)}.${three(ms3)}`; };
    const tsMs=(ts)=> ts ? (ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6)) : null;
    const qp=new URL(location.href).searchParams;
    const code=(qp.get('code')||'').toUpperCase();
    $('evCode').textContent = code || '—';

    let evDateStr = '—';
    let orderedRows = [];

    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore, doc, collection, getDocs, query, orderBy, getDoc
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    async function load(){
      if(!code){
        $('tbody').innerHTML = `<tr><td colspan="5" style="padding:20px;text-align:center">Falta ?code=EVENTO</td></tr>`;
        return;
      }

      const evRef = doc(db,'events',code);
      const evSnap = await getDoc(evRef);
      if (evSnap.exists()) {
        const d = evSnap.data();
        const baseTS = d.updatedAt || d.createdAt || null;
        const ms = tsMs(baseTS);
        if (ms) { evDateStr = new Date(ms).toLocaleString('es-ES'); $('evDate').textContent = evDateStr; }
      }

      const partsCol = collection(evRef,'participants');
      const snap = await getDocs(query(partsCol, orderBy('order','asc')));

      const rows = snap.docs.map(d=>{
        const x=d.data();
        const sMS=tsMs(x.startTS), spMS=tsMs(x.splitTS), eMS=tsMs(x.stopTS);
        const splitDur = (sMS!=null && spMS!=null) ? (spMS - sMS) : null;
        const totalDur = (sMS!=null && eMS!=null) ? (eMS - sMS) : null;
        return { id:d.id, name:(x.name||'').toUpperCase(), splitDur, totalDur };
      });

      const finished   = rows.filter(r=>r.totalDur!=null).sort((a,b)=> a.totalDur - b.totalDur);
      const unfinished = rows.filter(r=>r.totalDur==null);
      orderedRows = [...finished, ...unfinished];

      const leaderDur = finished.length ? finished[0].totalDur : null;

      const tbody = $('tbody');
      if(orderedRows.length===0){
        tbody.innerHTML = `<tr><td colspan="5" style="padding:20px;text-align:center;opacity:.8">Sin participantes</td></tr>`;
        $('meta').textContent = '0 participantes';
        return;
      }

      tbody.innerHTML = orderedRows.map((r)=>{
        const pos = (r.totalDur!=null) ? (finished.indexOf(r)+1) : '—';
        const splitTxt = r.splitDur!=null ? fmt(r.splitDur) : '—';
        const totalTxt = r.totalDur!=null ? fmt(r.totalDur) : '—';
        let delta = '—';
        if (leaderDur!=null && r.totalDur!=null) {
          const diff = r.totalDur - leaderDur;
          delta = diff===0 ? '+00:00.000' : ('+' + fmt(diff));
        }
        return `
          <tr>
            <td class="pos">${pos}</td>
            <td class="name">${r.name}</td>
            <td class="time">${splitTxt}</td>
            <td class="time">${totalTxt}</td>
            <td class="delta">${delta}</td>
          </tr>`;
      }).join('');

      $('meta').textContent = `${rows.length} participantes • ${finished.length} finalizados`;
    }

    function downloadPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });

      const title = `RESULTADOS — ${code || 'EVENTO'}`;
      doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text(title, 40, 40);
      doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.text(`Fecha: ${evDateStr}`, 40, 58);

      const head = [['#','PARTICIPANTE','SPLIT','TIEMPO','']];

      const finishedOnly = orderedRows.filter(r=>r.totalDur!=null);
      const leaderDur = finishedOnly.length ? finishedOnly[0].totalDur : null;

      const body = orderedRows.map((r)=>{
        const rank = (r.totalDur!=null) ? (finishedOnly.indexOf(r)+1) : '—';
        const splitTxt = r.splitDur!=null ? fmt(r.splitDur) : '—';
        const totalTxt = r.totalDur!=null ? fmt(r.totalDur) : '—';
        let delta = '—';
        if (leaderDur!=null && r.totalDur!=null) {
          const diff = r.totalDur - leaderDur;
          delta = diff===0 ? '+00:00.000' : ('+' + fmt(diff));
        }
        return [String(rank), r.name, splitTxt, totalTxt, delta];
      });

      doc.autoTable({
        head, body,
        startY: 74,
        margin: { left: 28, right: 28 },
        styles: { font: 'helvetica', fontSize: 11, lineColor: [210,210,210], lineWidth: 0.5 },
        headStyles: { fillColor: [110,176,255], textColor: 20, halign: 'left' },
        bodyStyles: { fillColor: [250,250,250] },
        alternateRowStyles: { fillColor: [240,240,240] },
        columnStyles: {
          0: { cellWidth: 36,  halign:'center', fontStyle:'bold' },
          1: { cellWidth: 240, fontStyle:'bold' },
          2: { cellWidth: 100, halign:'right' },
          3: { cellWidth: 110, halign:'right', fontStyle:'bold' },
          4: { cellWidth: 90,  halign:'right' }
        },
        tableWidth: 'wrap'
      });

      doc.save(`resultados_${(code||'EVENTO')}.pdf`);
    }

    $('btnRefresh').onclick = ()=>load();
    $('btnPDF').onclick = ()=>downloadPDF();
    load();
  </script>
</body>
</html>
