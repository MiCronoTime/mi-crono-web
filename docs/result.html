<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono ‚Äî RESULTADOS</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    :root{
      --bg:#10141b; --panel:#161c24; --panel2:#1b2330;
      --text:#eaf0f8; --muted:#b5c0d1; --border:#2a3342;
      --accent:#6eb0ff; --accent-2:#8ec5ff; --ok:#7cffb6; --err:#ff7a8a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #131a27 0%, transparent 60%),
                  radial-gradient(1200px 900px at 120% 10%, #192134 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--accent);text-decoration:none} a:hover{color:var(--accent-2)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .title{font-weight:900;letter-spacing:.06em;text-transform:uppercase}
    .tag{opacity:.9}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.28);margin-bottom:14px}
    h2{margin:0 0 10px 0;text-transform:uppercase;letter-spacing:.05em}
    .muted{color:var(--muted)}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:12px;border:1px solid var(--border);
      background:#0f141c;color:var(--text);text-decoration:none;
      text-transform:uppercase;font-weight:900;letter-spacing:.03em;min-height:40px;
      transition:background .15s,border-color .15s,transform .05s;
    }
    .btn:hover{background:#141a24}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#091320}
    .btn.primary:hover{background:var(--accent-2);border-color:var(--accent-2)}
    .row{display:grid;grid-template-columns:auto 1fr auto auto;align-items:center;gap:10px;
         border:1px solid var(--border);border-radius:12px;background:#0f141c;padding:10px 12px;margin-bottom:8px}
    .pos{width:42px;height:28px;border-radius:999px;background:var(--panel2);display:flex;align-items:center;justify-content:center;font-weight:900}
    .name{font-weight:900;text-transform:uppercase}
    .time{font-weight:900;letter-spacing:.4px}
    .sub{font-size:12px;color:var(--muted)}
    .ok{color:var(--ok);font-weight:800} .err{color:var(--err);font-weight:800}
    .two{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){ .two{grid-template-columns:1fr 1fr} }

    /* √Årea a exportar a PDF */
    #exportArea{padding:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 class="title">RESULTADOS</h1>
      <div class="tag" id="ev">Evento ‚Äî</div>
    </header>

    <!-- Herramientas (incluye PDF y navegaci√≥n) -->
    <section class="card" id="tools">
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="index.html">‚á¶ Inicio</a>
        <a id="openStart" class="btn" href="#">üèÅ Salida</a>
        <a id="openFinish" class="btn" href="#">üö© Meta</a>
        <button id="btnPdf" class="btn primary">‚¨áÔ∏è Descargar PDF</button>
      </div>
      <div class="muted" style="margin-top:8px">Orden de clasificaci√≥n: <b>mejor tiempo primero</b>.</div>
    </section>

    <div class="two" id="exportArea">
      <section class="card" id="cardDone">
        <h2>Clasificaci√≥n</h2>
        <div id="listDone"><div class="muted">‚Äî A√∫n no hay llegadas ‚Äî</div></div>
      </section>

      <section class="card" id="cardLive">
        <h2>En curso</h2>
        <div id="listLive"><div class="muted">‚Äî Ning√∫n participante en pista ‚Äî</div></div>
      </section>
    </div>

    <section class="card">
      <h2>Estado</h2>
      <div>Firebase: <span id="fb">‚Äî</span></div>
      <div>Participantes: <span id="cnt">‚Äî</span></div>
    </section>
  </div>

  <!-- Firebase + Firestore (CDN, ES Modules) -->
  <script type="module">
    // Utils
    const $=(id)=>document.getElementById(id);
    const two=(n)=>String(n).padStart(2,'0');
    const three=(n)=>String(n).padStart(3,'0');
    const fmt=(ms)=>{ ms=Math.max(0,Math.floor(ms||0));
      const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), ms3=ms%1000;
      return `${two(m)}:${two(s)}.${three(ms3)}`; };
    const tsToMillis=(ts)=> ts ? (ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6)) : null;
    const getParam=(k)=> new URL(location.href).searchParams.get(k);
    const code=(getParam('code')||'').toUpperCase();

    $('ev').textContent = 'Evento ' + (code||'‚Äî');
    $('openStart').onclick =(e)=>{ e.preventDefault(); if(!code) return alert('Sin c√≥digo'); location.href = `camera.html?code=${encodeURIComponent(code)}&mode=start`; };
    $('openFinish').onclick=(e)=>{ e.preventDefault(); if(!code) return alert('Sin c√≥digo'); location.href = `camera.html?code=${encodeURIComponent(code)}&mode=finish`; };

    // Firebase (CDN)
    try{
      const { initializeApp, getApp, getApps } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
      const { getFirestore, doc, collection, query, orderBy, onSnapshot } =
        await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');

      const firebaseConfig = {
        apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
        authDomain: "mi-crono-time-888b7.firebaseapp.com",
        projectId: "mi-crono-time-888b7",
        storageBucket: "mi-crono-time-888b7.appspot.com",
        messagingSenderId: "379025900327",
        appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
      };
      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const db  = getFirestore(app);
      $('fb').textContent='OK'; $('fb').className='ok';

      const eventRef = doc(db,'events',code||'__NO_CODE__');
      const partsCol = collection(eventRef,'participants');

      // Datos en vivo
      onSnapshot(query(partsCol, orderBy('order','asc')), (qs)=>{
        const rows = qs.docs.map(d=> ({ id:d.id, ...d.data() }));
        $('cnt').textContent = rows.length;

        // ---- CLASIFICACI√ìN: ordenar por mejor tiempo (ASC) ----
        const done = rows
          .filter(r=> r.startTS && r.stopTS)
          .map(r=>{
            const start = tsToMillis(r.startTS);
            const stop  = tsToMillis(r.stopTS);
            return {
              name: (r.name||'').toUpperCase(),
              order: r.order||0,
              startMS: start,
              stopMS:  stop,
              durMS:   (stop!=null && start!=null) ? (stop - start) : null
            };
          })
          .filter(r=> r.durMS!=null)
          .sort((a,b)=>{
            if(a.durMS!==b.durMS) return a.durMS - b.durMS;       // mejor tiempo primero
            if(a.stopMS!==b.stopMS) return a.stopMS - b.stopMS;   // desempate por llegada
            return a.order - b.order;                             // 2¬∫ desempate por dorsal
          });

        // En curso: quien sali√≥ pero no ha llegado (orden por salida)
        const live = rows
          .filter(r=> r.startTS && !r.stopTS)
          .map(r=>({
            name:(r.name||'').toUpperCase(),
            order:r.order||0,
            startMS: tsToMillis(r.startTS)
          }))
          .sort((a,b)=> (a.startMS||0)-(b.startMS||0));

        renderDone(done);
        renderLive(live);
      });

      function renderDone(arr){
        const box = $('listDone');
        if(!arr.length){ box.innerHTML = `<div class="muted">‚Äî A√∫n no hay llegadas ‚Äî</div>`; return; }
        box.innerHTML = arr.map((r,i)=> rowDone(i+1, r.name, r.durMS, r.startMS, r.stopMS)).join('');
      }

      function rowDone(pos, name, durMS, startMS, stopMS){
        const startStr = new Date(startMS).toLocaleTimeString();
        const stopStr  = new Date(stopMS).toLocaleTimeString();
        return `
          <div class="row">
            <div class="pos">${pos}</div>
            <div class="name">${name}</div>
            <div class="time">${fmt(durMS)}</div>
            <div class="sub">${startStr} ‚Üí ${stopStr}</div>
          </div>
        `;
      }

      // Vivo (‚ÄúEn curso‚Äù): mostramos contador cliente (no afecta a PDF)
      let liveCache=[];
      function renderLive(arr){
        liveCache = arr.slice();
        if(!arr.length){ $('listLive').innerHTML = `<div class="muted">‚Äî Ning√∫n participante en pista ‚Äî</div>`; return; }
        $('listLive').innerHTML = arr.map(r=> rowLive(r.order, r.name, 0)).join('');
      }

      function rowLive(order, name, ms){
        return `
          <div class="row">
            <div class="pos">#${order}</div>
            <div class="name">${name}</div>
            <div class="time" data-live="${order}">${fmt(ms)}</div>
            <div class="sub">En curso‚Ä¶</div>
          </div>
        `;
      }

      // Actualizaci√≥n de ‚ÄúEn curso‚Äù cada 100 ms (est√©tico)
      setInterval(()=>{
        if(!liveCache.length) return;
        const now = Date.now();
        liveCache.forEach(r=>{
          const el = document.querySelector(`.time[data-live="${r.order}"]`);
          if(!el) return;
          const t = now - (r.startMS||now);
          el.textContent = fmt(t);
        });
      }, 100);

    }catch(e){
      $('fb').textContent='ERROR'; $('fb').className='err';
      console.error('Firebase error:', e);
      alert('Firebase ERROR: ' + (e.message || e));
    }

    // ====== PDF (manteniendo la opci√≥n de la versi√≥n anterior) ======
    // Usamos html2canvas + jsPDF v√≠a CDN para capturar la tarjeta de clasificaci√≥n.
    // Nota: El PDF captura el aspecto actual (tema oscuro incluido).
  </script>

  <!-- html2canvas + jsPDF desde CDN (cargar fuera del m√≥dulo) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    (function(){
      const btn = document.getElementById('btnPdf');
      if(!btn) return;

      btn.addEventListener('click', async ()=>{
        try{
          // Capturamos solo el √°rea de resultados (clasificaci√≥n + en curso)
          const target = document.getElementById('exportArea');
          const canvas = await html2canvas(target, { scale: 2, backgroundColor: null, useCORS: true });

          const imgData = canvas.toDataURL('image/png');
          const { jsPDF } = window.jspdf;

          // Hoja A4 vertical
          const pdf = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
          const pageW = pdf.internal.pageSize.getWidth();
          const pageH = pdf.internal.pageSize.getHeight();

          // Ajuste manteniendo proporci√≥n y m√°rgenes
          const margin = 24;
          const maxW = pageW - margin*2;
          const maxH = pageH - margin*2;

          let imgW = canvas.width, imgH = canvas.height;
          const ratio = Math.min(maxW/imgW, maxH/imgH);
          const w = imgW * ratio, h = imgH * ratio;
          const x = (pageW - w)/2;
          const y = (pageH - h)/2;

          pdf.setProperties({ title: 'Resultados ‚Äî Mi Crono Web' });
          pdf.addImage(imgData, 'PNG', x, y, w, h);
          pdf.save('resultados_mi_crono_web.pdf');
        }catch(e){
          alert('No se pudo generar el PDF: ' + (e.message||e));
          console.error(e);
        }
      });
    })();
  </script>
</body>
</html>
