<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono — RESULTADOS</title>
  <style>
    :root{
      --bg:#10141b; --panel:#161c24; --panel2:#1b2330;
      --text:#eaf0f8; --muted:#b5c0d1; --border:#2a3342;
      --accent:#6eb0ff; --accent-2:#8ec5ff; --ok:#7cffb6; --err:#ff7a8a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1300px 800px at 20% -10%, #131a27 0%, transparent 60%),
                  radial-gradient(1200px 900px at 120% 10%, #192134 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 14px}
    .title{font-weight:900;letter-spacing:.06em;text-transform:uppercase}
    .muted{color:var(--muted)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:12px;border:1px solid var(--border);
      background:#0f141c;color:var(--text);cursor:pointer;text-decoration:none;
      text-transform:uppercase;font-weight:900;letter-spacing:.03em;min-height:42px;
      transition:background .15s,border-color .15s,transform .05s;
    }
    .btn:hover{background:#141a24}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#091320}
    .btn.primary:hover{background:var(--accent-2);border-color:var(--accent-2)}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{
      text-align:left;padding:10px 12px;font-weight:800;text-transform:uppercase;letter-spacing:.04em;color:var(--muted)
    }
    tbody tr{background:var(--panel2);border:1px solid var(--border)}
    tbody td{padding:12px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    tbody tr td:first-child{border-left:1px solid var(--border);border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-right:1px solid var(--border);border-top-right-radius:10px;border-bottom-right-radius:10px}
    .pos{width:64px;text-align:center;font-weight:900}
    .name{font-weight:900;text-transform:uppercase}
    .time{font-weight:900;letter-spacing:.4px}
    .sep{height:8px}
    .ok{color:var(--ok)} .err{color:var(--err)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1 class="title">RESULTADOS</h1>
      <div class="actions">
        <a href="index.html" class="btn">⇦&nbsp;Inicio</a>
        <button id="btnRefresh" class="btn">Refrescar</button>
        <button id="btnCSV" class="btn primary">Descargar CSV</button>
      </div>
    </div>

    <div class="card" style="margin-bottom:12px">
      <div>Evento: <b id="evCode">—</b></div>
      <div class="muted" id="meta">—</div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Participante</th>
            <th>Inicio</th>
            <th>Fin</th>
            <th>Tiempo</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="muted" style="padding:20px;text-align:center">Cargando…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script type="module">
    // ===== Utils =====
    const $=(id)=>document.getElementById(id);
    const two=(n)=>String(n).padStart(2,'0');
    const three=(n)=>String(n).padStart(3,'0');
    const fmt=(ms)=>{ ms=Math.max(0,Math.floor(ms||0));
      const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), ms3=ms%1000;
      return `${two(m)}:${two(s)}.${three(ms3)}`; };
    const tsMs=(ts)=> ts ? (ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6)) : null;
    const qp=new URL(location.href).searchParams;
    const code=(qp.get('code')||'').toUpperCase();
    $('evCode').textContent = code || '—';

    // ===== Firebase (CDN) =====
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore, doc, collection, getDocs, query, orderBy
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    async function load(){
      if(!code){ $('tbody').innerHTML = `<tr><td colspan="5" class="err" style="padding:20px;text-align:center">Falta el parámetro ?code=EVENTO</td></tr>`; return; }

      const evRef = doc(db,'events',code);
      const partsCol = collection(evRef,'participants');
      const snap = await getDocs(query(partsCol, orderBy('order','asc')));

      const rows = snap.docs.map(d=>{
        const x=d.data();
        const startMS=tsMs(x.startTS), stopMS=tsMs(x.stopTS);
        const dur = (startMS!=null && stopMS!=null) ? (stopMS-startMS) : null;
        return {
          id:d.id,
          name:(x.name||'').toUpperCase(),
          order:x.order||0,
          startMS, stopMS, dur
        };
      });

      // === Ordenación por tiempo (mejor → peor)
      const finished   = rows.filter(r=>r.dur!=null).sort((a,b)=> a.dur - b.dur);
      const unfinished = rows.filter(r=>r.dur==null); // sin tiempo -> abajo

      const all = [...finished, ...unfinished];

      // Rellenar tabla
      const tbody = $('tbody');
      if(all.length===0){
        tbody.innerHTML = `<tr><td colspan="5" class="muted" style="padding:20px;text-align:center">Sin participantes</td></tr>`;
        $('meta').textContent = '0 participantes';
        return;
      }

      tbody.innerHTML = all.map((r,idx)=>{
        const s = r.startMS!=null ? new Date(r.startMS).toLocaleTimeString() : '—';
        const e = r.stopMS !=null ? new Date(r.stopMS ).toLocaleTimeString() : '—';
        const t = r.dur!=null ? fmt(r.dur) : '—';
        const pos = (r.dur!=null) ? (finished.indexOf(r)+1) : '—';
        return `
          <tr>
            <td class="pos">${pos}</td>
            <td class="name">${r.name}</td>
            <td>${s}</td>
            <td>${e}</td>
            <td class="time">${t}</td>
          </tr>`;
      }).join('');

      const total = rows.length;
      const fin   = finished.length;
      $('meta').textContent = `${total} participantes • ${fin} finalizados`;
    }

    // CSV (ordenado como se muestra)
    function downloadCSV(){
      const rows = Array.from(document.querySelectorAll('#tbody tr'))
        .map(tr => Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim()))
        .filter(cols => cols.length===5 && cols[1] !== 'Sin participantes');
      const head = ['POS','PARTICIPANTE','INICIO','FIN','TIEMPO'];
      const csv = [head, ...rows].map(r=>r.map(v=>`"${v.replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `resultados_${(code||'EVENTO')}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    $('btnRefresh').onclick = ()=>load();
    $('btnCSV').onclick = ()=>downloadCSV();

    load();
  </script>
</body>
</html>
