<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono — Resultado (Smoke)</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .big{font-size:42px;font-weight:700;letter-spacing:.5px}
    .ok{color:#0a7a0a;font-weight:600}
    .err{color:#b00020;font-weight:600}
    .debug{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#f6f6f6;border-radius:8px;padding:8px}
  </style>
</head>
<body class="wrap">
  <header class="top"><h1>Resultado</h1><p class="tag" id="subtitle"></p></header>

  <main class="grid one">
    <section class="card">
      <div>Firebase: <span id="fbState">—</span></div>
      <div class="big" id="time">--:--.--</div>
      <p id="details" class="muted"></p>
    </section>
    <section class="card">
      <h2>Depuración</h2>
      <div class="debug" id="lastError">—</div>
    </section>
  </main>

  <script type="module">
    window.__firebaseReady=false; window.__firebaseError=null;

    const getParam = (k)=> new URL(location.href).searchParams.get(k);
    const code=(getParam('code')||'').toUpperCase();
    document.getElementById('subtitle').textContent = code ? `Evento ${code}` : 'Sin código';
    const fbStateEl=document.getElementById('fbState'), lastErrorEl=document.getElementById('lastError');

    const two = (n)=> String(n).padStart(2,'0');
    const formatDuration = (ms)=>{ const t=Math.max(0, Math.floor(ms||0));
      const m=Math.floor(t/60000), s=Math.floor((t%60000)/1000), cs=Math.floor((t%1000)/10);
      return `${two(m)}:${two(s)}.${two(cs)}`; };
    const tsToMillis = (ts)=> ts ? (typeof ts==='number'?ts:(ts.seconds*1000+Math.floor((ts.nanoseconds||0)/1e6))) : null;

    function paintFirebase(){
      fbStateEl.textContent = window.__firebaseReady ? "OK" : "ERROR";
      fbStateEl.className   = window.__firebaseReady ? "ok" : "err";
      if(!window.__firebaseReady){
        const msg  = window.__firebaseError && (window.__firebaseError.message || String(window.__firebaseError)) || 'sin detalle';
        lastErrorEl.textContent = `Init Firebase error: ${msg}`;
      } else {
        lastErrorEl.textContent = '—';
      }
    }

    try{
      const { initializeApp, getApp, getApps } = await import("https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js");
      const { getFirestore, doc, getDoc, onSnapshot } =
        await import("https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js");

      const firebaseConfig = {
        apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
        authDomain: "mi-crono-time-888b7.firebaseapp.com",
        projectId: "mi-crono-time-888b7",
        storageBucket: "mi-crono-time-888b7.appspot.com",
        messagingSenderId: "379025900327",
        appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
      };

      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const db  = getFirestore(app);
      window.__firebaseReady=true; paintFirebase();

      const eventRef = doc(db, "events", code);
      onSnapshot(eventRef, (snap)=>{
        const d = snap.data() || {};
        const start = tsToMillis(d.startTS) ?? d.startClientMS ?? null;
        const stop  = tsToMillis(d.stopTS)  ?? d.stopClientMS  ?? null;
        const dur   = (start && stop) ? (stop - start) : null;
        document.getElementById('time').textContent = dur!=null ? formatDuration(dur) : '--:--.--';
        document.getElementById('details').textContent =
          `Inicio: ${start?new Date(start).toLocaleTimeString(): '—'} | Fin: ${stop?new Date(stop).toLocaleTimeString():'—'} | Duración: ${dur!=null?formatDuration(dur):'—'}`;
      }, (err)=>{ lastErrorEl.textContent = 'Error snapshot: ' + (err && (err.code || err.message || err)); });

    }catch(e){
      window.__firebaseError=e; window.__firebaseReady=false; paintFirebase();
    }

    paintFirebase();
  </script>
</body>
</html>
