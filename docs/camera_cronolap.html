<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono — CRONOLAP</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    :root{
      --bg:#121418; --panel:#1b1f27; --panel-2:#232a34; --text:#e8ecf1;
      --muted:#b5bdc9; --border:#2b3240; --accent:#5ea1ff; --accent-2:#7cc4ff; --hud: rgba(0,0,0,.55);
      --ok:#7cffb6; --okRing:rgba(127,255,182,.35);
      --danger:#e44848; --go:#38d66b; --orange:#ffae3a;
      --hold:#ff9c3a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #151924 0%, transparent 60%),
                  radial-gradient(1200px 800px at 120% 10%, #1a2030 0%, transparent 55%), var(--bg);
      color:var(--text);
    }
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .grid.one{display:grid;gap:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .controls .btn{flex:1 1 0; min-height:44px; justify-content:center; white-space:nowrap}
    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:11px 16px;border-radius:12px;border:1px solid var(--border);
      background:#0f1217;color:var(--text);cursor:pointer;user-select:none;transition:transform .05s, background .15s, border-color .15s, color .15s;
      text-transform:uppercase;font-weight:800;letter-spacing:.03em;font-size:14px;line-height:1;text-decoration:none;
    }
    .btn:hover{ background:#12161d } .btn:active{ transform:translateY(1px) }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#0b1220 }
    .btn.primary:hover{ background:var(--accent-2); border-color:var(--accent-2) }

    .stage{position:relative;margin-top:10px;border-radius:16px;overflow:hidden;height:60vh;background:#000;display:flex;align-items:center;justify-content:center;border:1px solid var(--border)}
    video{width:100%;height:100%;object-fit:cover;background:#000;display:block}
    canvas.overlay{position:absolute;inset:0;pointer-events:auto}

    .hud{position:absolute;left:12px;right:12px;top:12px;background:var(--hud);color:#fff;border-radius:18px;padding:12px 16px;font-weight:800;backdrop-filter:blur(4px)}
    .pill{display:inline-block;padding:6px 14px;border-radius:999px;background:#1f2430;color:#e8ecf1}

    .sub{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:12px}
    label{display:block;margin-bottom:6px;font-weight:700}
    input[type=range]{width:100%}

    .list{margin-top:12px}
    .runner{
      position:relative; overflow:hidden;
      display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#0f1217;margin-bottom:6px;cursor:pointer;
    }
    .runner > *{position:relative; z-index:1;}
    .runner.selected{ border-color:var(--ok); box-shadow:0 0 0 3px var(--okRing) inset; }
    .runner.hold{ border-color:var(--hold); box-shadow:0 0 0 3px rgba(255,156,58,.35) inset; }
    .badge{font-weight:800;color:#cfe1ff;opacity:.9}
    .rname{
      display:grid; grid-template-columns: 56px 1fr; gap:8px; align-items:center;
      font-weight:800; text-transform:uppercase;
    }
    .rname .bib{opacity:.95; font-weight:900; text-align:right;}
    .rname .nm{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .rtime{font-weight:900;letter-spacing:.4px}
    .muted{color:var(--muted)}

    .runner-actions{position:absolute;inset:0;display:flex; z-index:2;}
    .runner-actions .half{
      flex:1; display:flex; align-items:center; justify-content:center; font-weight:900; text-transform:uppercase;
      letter-spacing:.02em; color:#fff;
    }
    .runner-actions .half.back{ background:var(--danger); }
    .runner-actions .half.go{ background:var(--go); color:#052013; }
    .runner-actions .half.stay{ background:var(--go); color:#052013; }
    .runner-actions .half.finish{ background:var(--danger); }
  </style>
</head>
<body class="wrap">
  <header class="top">
    <h1 style="text-transform:uppercase;letter-spacing:.04em">CRONOLAP</h1>
    <p id="tag">Conectando…</p>
  </header>

  <main class="grid one">
    <section class="card warn" id="noCodeBox" style="display:none">
      <b>Falta el código de evento.</b> Vuelve a <a href="cronolap_index.html">Inicio</a>.
    </section>

    <section class="card">
      <div class="controls">
        <button id="btnEnableCam" class="btn primary">ACTIVAR CÁMARA</button>
        <a id="btnResult" class="btn" href="#">VER RESULTADO</a>
      </div>
      <small class="muted">iOS: Safari + HTTPS + permitir Cámara.</small>

      <div class="stage" id="stage">
        <video id="video" playsinline muted></video>
        <canvas id="overlay" class="overlay"></canvas>

        <div class="hud" id="hudTop">
          <span id="hudStatus">Listo</span>
          • <span id="hudNext" class="pill">Siguiente: —</span>
        </div>
      </div>

      <div class="sub">
        <label>Sensibilidad detector (franja roja) <span id="sensValTxt" class="muted">(20%)</span></label>
        <input id="sens" type="range" min="0" max="100" value="50"/>
        <small class="muted">Mueve el control hacia la derecha para aumentar la sensibilidad.</small>
      </div>

      <div class="sub list">
        <h2 style="margin:0 0 8px 0;text-transform:uppercase;letter-spacing:.04em">En curso</h2>
        <div id="runningList">—</div>
      </div>
    </section>

    <section class="card">
      <h2 style="text-transform:uppercase;letter-spacing:.04em;margin:0 0 8px 0">Estado</h2>
      <div>Firebase: <span id="fbState">—</span></div>
      <div>Evento: <span id="evState">—</span></div>
      <div>Última acción: <span id="lastAction">—</span></div>
      <div>Modo: <b id="lapMode">SALIDA</b></div>
    </section>
  </main>

  <footer style="margin-top:10px"><a class="muted" href="cronolap_index.html">⇦ Volver a Inicio</a></footer>

  <script type="module">
    import { ensureAuthInit, requireAuth, currentCtx } from './js/auth.js';

    /* ===== Utils ===== */
    const $  = (id)=>document.getElementById(id);
    const two=(n)=>String(n).padStart(2,'0');
    const three=(n)=>String(n).padStart(3,'0');
    const fmt=(ms)=>{
      ms=Math.max(0,Math.floor(ms||0));
      const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), ms3=ms%1000;
      return `${two(m)}:${two(s)}.${three(ms3)}`;
    };
    const tsToMillis=(ts)=> ts ? (ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6)) : null;

    await ensureAuthInit();
    await requireAuth('index.html');

    /* ===== Parámetros ===== */
    const p = new URL(location.href).searchParams;
    const code = (p.get('code')||'').toUpperCase();

    $('tag').textContent     = code ? `Evento ${code}` : 'SIN CÓDIGO';
    $('evState').textContent = code || '—';
    $('evState').className   = code ? 'ok' : 'err';
    $('btnResult').onclick=(e)=>{ e.preventDefault(); location.href=`result.html?code=${encodeURIComponent(code)}`; };
    if(!code){ $('noCodeBox').style.display=''; throw new Error('No code'); }

    /* ===== Firebase ===== */
    const { initializeApp, getApps, getApp } =
      await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
    const {
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot,
      serverTimestamp, collection, query, orderBy, getDocs, addDoc, deleteDoc, deleteField
    } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');

    const firebaseConfig = {
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    $('fbState').textContent='OK'; $('fbState').className='ok';

    const { uid } = currentCtx();
    const eventRef = doc(db,'users',uid,'events',code);
    const partsCol = collection(eventRef,'participants');
    const syncCol  = collection(eventRef,'sync');

    const s=await getDoc(eventRef);
    if(!s.exists()) await setDoc(eventRef,{code,createdAt:serverTimestamp()},{merge:true});

    /* ===== Reloj sync ===== */
    let serverOffsetMS = 0;
    try{
      const pingRef = await addDoc(syncCol,{ serverNow: serverTimestamp() });
      const pingSnap = await getDoc(pingRef);
      const serverNowMs = tsToMillis(pingSnap.data().serverNow);
      serverOffsetMS = (serverNowMs ?? Date.now()) - Date.now();
      await deleteDoc(pingRef);
    }catch(_){ serverOffsetMS=0; }

    /* ===== Participantes / estado CRONOLAP ===== */
    let participants=[];
    async function reload(){
      const snap=await getDocs(query(partsCol, orderBy('order','asc')));
      participants = snap.docs.map(d=>({ id:d.id, ref:d.ref, ...d.data() }));
    }
    const nextToStart = ()=> participants.find(p=>!p.startTS);
    const runningOnTrack = ()=> participants.filter(p=>p.startTS && !p.stopTS);

    let phase = 'start'; // 'start' | 'finish'
    function setPhase(ph){
      phase=ph;
      $('lapMode').textContent = ph==='start' ? 'SALIDA' : 'META';
    }

    /* ===== Congelados (META visual, ON TRACK/FINISH) ===== */
    const FINISH_ORANGE_MS = 5000;  // 5s naranja fijo
    const FINISH_FREEZE_MS = 9000;  // total 9s congelado
    const BLINK_PERIOD_MS  = 150;

    let currentLive = [];     // corredores realmente en pista [{id,order,name,dorsal,startMS}]
    let frozenFinishes = [];  // [{id,order,name,dorsal,startMS,frozenMs,createdAt,showActions,pos,frozen:true}]
    let goBackId = null;      // SALIDA: corredor con overlay RESTART/CONTINUE

    function frozenVisualState(createdAt){
      const elapsed = Date.now() - createdAt;
      if (elapsed < FINISH_ORANGE_MS){
        return { color:'orange', show:true };
      }
      if (elapsed < FINISH_FREEZE_MS){
        const phaseIdx = Math.floor((elapsed - FINISH_ORANGE_MS) / BLINK_PERIOD_MS);
        return { color:'orange', show:(phaseIdx % 2) === 0 };
      }
      return { color:'none', show:false };
    }

    function createFrozenFromParticipant(p, pos=0){
      const startMS = tsToMillis(p.startTS);
      const nowSync = Date.now() + serverOffsetMS;
      const frozenMs = Math.max(0, (nowSync - (startMS || nowSync)));
      frozenFinishes.push({
        id: p.id,
        order: p.order || 0,
        name: (p.name||'').toUpperCase(),
        dorsal: (p.dorsal||'').toString().trim(),
        startMS,
        frozenMs,
        createdAt: Date.now(),
        showActions: false,
        pos,
        frozen: true
      });
    }

    async function revertStart(id){
      try{
        await updateDoc(doc(partsCol,id),{ startTS: deleteField(), stopTS: deleteField() });
        goBackId = null;
        $('lastAction').textContent='RESTART aplicado';
        await reload();
      }catch(e){ alert('No se pudo aplicar RESTART: '+(e.message||e)); }
    }

    async function revertStop(id){
      try{
        await updateDoc(doc(partsCol,id),{ stopTS: deleteField() });
        frozenFinishes = frozenFinishes.filter(f=>f.id!==id);
        $('lastAction').textContent='ON TRACK (stop revertido)';
        await reload();
      }catch(e){ alert('No se pudo revertir llegada: '+(e.message||e)); }
    }

    function confirmFinishLocal(id){
      frozenFinishes = frozenFinishes.filter(f=>f.id!==id);
      $('lastAction').textContent='FINISH confirmado';
    }

    /* ===== UI en vivo ===== */
    function ensureStatus(){
      const nxt = nextToStart();
      $('hudNext').textContent = 'Siguiente: ' + (nxt ? (nxt.name||'—').toUpperCase() : '—');
      $('tag').textContent = `Evento ${code}`;
    }

    function renderListNow(){
      const nowSync = Date.now() + serverOffsetMS;
      const list = $('runningList');

      const running = currentLive
        .slice()
        .sort((a,b)=> (b.startMS||0)-(a.startMS||0));

      const rows = [
        ...frozenFinishes,
        ...running
      ];

      if(!rows.length){
        list.innerHTML='—';
        return;
      }

      list.innerHTML = rows.map(r=>{
        const isFrozen = !!r.frozen;
        const bib = (r.dorsal||'').toString().trim();
        const nm  = (r.name||'').toUpperCase();
        const elapsed = isFrozen
          ? r.frozenMs
          : (nowSync - (r.startMS||nowSync));
        const baseCls = 'runner' + (isFrozen ? ' hold' : '');
        const actionsStart  = (!isFrozen && phase==='start' && goBackId===r.id);
        const actionsFinish = (isFrozen && r.showActions);

        return `<div class="${baseCls}" data-id="${r.id}">
          ${actionsStart ? `
            <div class="runner-actions">
              <div class="half back" data-action="back" data-id="${r.id}">RESTART</div>
              <div class="half go"   data-action="go"   data-id="${r.id}">CONTINUE</div>
            </div>` : ''}
          ${actionsFinish ? `
            <div class="runner-actions">
              <div class="half stay"   data-action="stay"   data-id="${r.id}">ON TRACK</div>
              <div class="half finish" data-action="finish" data-id="${r.id}">FINISH</div>
            </div>` : ''}
          <div class="badge">#${r.order||0}</div>
          <div class="rname"><span class="bib">${bib}</span><span class="nm">${nm}</span></div>
          <div class="rtime">${fmt(elapsed)}</div>
        </div>`;
      }).join('');
    }
    (function tickList(){ renderListNow(); setTimeout(tickList, 100); })();

    // Clicks en lista EN CURSO
    $('runningList').addEventListener('click', async (e)=>{
      const act = e.target.closest('[data-action]');
      const row = e.target.closest('.runner');
      if(!row?.dataset.id) return;
      const id = row.dataset.id;

      if (act){
        const action = act.dataset.action;
        if (action === 'back'){ await revertStart(id); return; }
        if (action === 'go'){ goBackId=null; renderListNow(); $('lastAction').textContent='CONTINUE'; return; }
        if (action === 'stay'){ await revertStop(id); return; }
        if (action === 'finish'){ confirmFinishLocal(id); return; }
      }

      const isFrozen = !!frozenFinishes.find(f=>f.id===id);
      if (isFrozen){
        const f = frozenFinishes.find(f=>f.id===id);
        if (f){ f.showActions = !f.showActions; }
      } else {
        if(phase==='start'){
          goBackId = (goBackId===id ? null : id);
        }
      }
    });

    onSnapshot(partsCol, async ()=>{
      await reload();
      const running = runningOnTrack();
      currentLive = running.map(p=>({
        id: p.id,
        order: p.order||0,
        name: (p.name||'').toUpperCase(),
        dorsal: (p.dorsal||'').toString().trim(),
        startMS: tsToMillis(p.startTS)
      }));
      if(goBackId && !currentLive.some(r=>r.id===goBackId)) goBackId=null;
      ensureStatus();
      setPhase( running.length ? 'finish' : 'start' );
    });

    /* ===== Cámara + Detección ===== */
    const stage=$('stage'), video=$('video'), overlay=$('overlay'), sens=$('sens'), sensValTxt=$('sensValTxt');
    const octx=overlay.getContext('2d',{willReadFrequently:true});
    let overlayRowHitboxes=[];

    function fitCanvas(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const w = Math.floor(stage.clientWidth);
      const h = Math.floor(stage.clientHeight);
      overlay.width  = Math.max(1, Math.floor(w * dpr));
      overlay.height = Math.max(1, Math.floor(h * dpr));
      overlay.style.width  = w+'px';
      overlay.style.height = h+'px';
      octx.setTransform(dpr,0,0,dpr,0,0);
      return {w,h,dpr};
    }

    const uiToPercent = (ui)=>{
      const v = Math.max(0, Math.min(100, Number(ui)||50));
      return v<=50 ? 5+(v/50)*(20-5) : 20+((v-50)/50)*(60-20);
    };
    const updateSensLabel = ()=>{ sensValTxt.textContent = `(${uiToPercent(sens.value).toFixed(0)}%)`; };
    updateSensLabel(); sens.oninput = updateSensLabel;

    const btnEnable = $('btnEnableCam');
    btnEnable.onclick = async (e)=>{
      const btn = e.currentTarget;
      try{
        if(!navigator.mediaDevices?.getUserMedia){ alert('Navegador sin cámara'); return; }
        const tries=[
          {video:{facingMode:{ideal:'environment'}},audio:false},
          {video:{facingMode:'environment'},audio:false},
          {video:true,audio:false}
        ];
        let stream=null,lastErr=null;
        for(const c of tries){
          try{
            stream=await navigator.mediaDevices.getUserMedia(c);
            if(stream) break;
          }catch(err){ lastErr=err; }
        }
        if(!stream){
          alert('No se pudo abrir la cámara.\n'+(lastErr?.name+': '+lastErr?.message));
          return;
        }
        video.setAttribute('playsinline','true');
        video.muted=true;
        video.srcObject=stream;
        await new Promise(res=>{ if(video.readyState>=2) res(); else video.onloadedmetadata=()=>res(); });
        await video.play().catch(()=>{});
        btn.textContent='CÁMARA ACTIVADA';
        btn.disabled=true;

        detectionEnabled=false;
        armingEndsAt=performance.now()+ARMING_DELAY_MS;
        $('hudStatus').textContent='Calibrando… 2.0s';
        requestAnimationFrame(loop);
      }catch(err){
        alert('Error cámara: '+(err?.message||err));
      }
    };

    const COOLDOWN_START_MS  = 2400;
    const COOLDOWN_FINISH_MS = 1800;
    const EMA_ALPHA          = 0.35;
    const MIN_PIXELS         = 28;
    const HOLD_MS            = 140;
    const ARMING_DELAY_MS    = 2000;
    let prevFrame=null, armed=true, cooldownTimer=null;
    let detectionEnabled=false, armingEndsAt=0;
    let actEma=0, above=false, aboveSince=0;

    function thresholdsFromSens(effPercent){
      const frac = effPercent/100;
      const up = 0.095 - frac*0.055;
      const down = up * 0.6;
      return { up: Math.max(0.02, up), down: Math.max(0.01, down) };
    }
    const armAfter=(ms)=>{ clearTimeout(cooldownTimer); cooldownTimer=setTimeout(()=>{ armed=true; },ms); };

    async function trigger(){
      if(!armed || !detectionEnabled) return;
      armed=false; above=false; aboveSince=0;

      await reload();

      if(phase==='start'){
        const nxt = nextToStart();
        if(!nxt){
          $('lastAction').textContent='Sin siguiente participante';
          armAfter(COOLDOWN_START_MS);
          return;
        }
        await updateDoc(nxt.ref,{ startTS:serverTimestamp(), stopTS:null });
        setPhase('finish');
        armAfter(COOLDOWN_START_MS);
        $('lastAction').textContent='Inicio (Cronolap)';
      }else{
        const running = runningOnTrack();
        if(!running.length){
          setPhase('start');
          armAfter(COOLDOWN_FINISH_MS);
          return;
        }
        const displayRows = running
          .slice()
          .sort((a,b)=> tsToMillis(b.startTS)-tsToMillis(a.startTS));
        const p = displayRows[0];
        const pos = displayRows.findIndex(x=>x.id===p.id);
        await updateDoc(p.ref,{ stopTS:serverTimestamp() });
        createFrozenFromParticipant(p, Math.max(0,pos));
        setPhase('start');
        armAfter(COOLDOWN_FINISH_MS);
        $('lastAction').textContent='Fin (Cronolap)';
      }
    }

    /* ==== Clicks sobre overlay (RESTART / CONTINUE / ON TRACK / FINISH) ==== */
    overlay.addEventListener('click', async (e)=>{
      const rect = overlay.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const btn = overlayRowHitboxes.find(h => h.kind==='btn' && x>=h.x && x<=h.x+h.w && y>=h.y && y<=h.y+h.h);
      if(btn){
        const id = btn.baseId;
        if(btn.btn==='RESTART'){ await revertStart(id); return; }
        if(btn.btn==='CONTINUE'){ goBackId=null; $('lastAction').textContent='CONTINUE'; return; }
        if(btn.btn==='STAY'){ await revertStop(id); return; }   // ON TRACK
        if(btn.btn==='FINISH'){ confirmFinishLocal(id); return; }
      }

      const row = overlayRowHitboxes.find(h => h.kind==='row' && x>=h.x && x<=h.x+h.w && y>=h.y && y<=h.y+h.h);
      if(!row) return;

      if(row.frozen){
        const f = frozenFinishes.find(f=>f.id===row.baseId);
        if(f){ f.showActions = !f.showActions; }
      }else{
        if(phase==='start'){
          goBackId = (goBackId===row.baseId ? null : row.baseId);
        }
      }
    });

    function loop(){
      const {w,h} = fitCanvas();

      // limpiar congelados antiguos (>9s)
      const nowMs = Date.now();
      frozenFinishes = frozenFinishes.filter(f => (nowMs - f.createdAt) < FINISH_FREEZE_MS);

      const nowPerf = performance.now();
      if(!detectionEnabled){
        const left = Math.max(0, Math.ceil((armingEndsAt - nowPerf)/100)/10);
        if(nowPerf >= armingEndsAt){
          detectionEnabled = true;
          $('hudStatus').textContent = 'Listo';
        } else {
          $('hudStatus').textContent = `Calibrando… ${left.toFixed(1)}s`;
        }
      }

      const roiWidth=Math.max(12, Math.round(w*0.08));
      const cx=Math.round(w*0.5), x1=cx-Math.round(roiWidth/2), x2=cx+Math.round(roiWidth/2);
      octx.clearRect(0,0,w,h);
      octx.fillStyle='rgba(255,0,0,.35)'; octx.fillRect(x1,0,2,h); octx.fillRect(x2-2,0,2,h);
      octx.fillStyle='rgba(255,0,0,.18)'; octx.fillRect(x1,0,roiWidth,h);

      drawOverlayTimes(w,h,currentLive,frozenFinishes);

      const vw=video.videoWidth, vh=video.videoHeight;
      if(vw && vh){
        const scaleX = vw / stage.clientWidth;
        const sx=Math.max(0, Math.min(vw-1, Math.round(x1*scaleX)));
        const sw=Math.max(1, Math.min(vw-sx, Math.round(roiWidth*scaleX)));
        const sy=0, sh=vh;
        const dw = Math.max(50, Math.floor(sw * 0.35));
        const dh = Math.max(50, Math.floor(sh * 0.35));
        const tmp=document.createElement('canvas'); tmp.width=dw; tmp.height=dh;
        const tctx=tmp.getContext('2d',{willReadFrequently:true}); tctx.drawImage(video,sx,sy,sw,sh,0,0,dw,dh);
        const frame=tctx.getImageData(0,0,dw,dh);
        if(prevFrame && prevFrame.width===dw && prevFrame.height===dh){
          const eff = uiToPercent(sens.value);
          const thrPix = 18 + Math.round((100 - eff) * 0.6);
          let diffPix=0,total=0;
          for(let i=0;i<frame.data.length;i+=4){
            const d = Math.abs(frame.data[i]-prevFrame.data[i]) +
                      Math.abs(frame.data[i+1]-prevFrame.data[i+1]) +
                      Math.abs(frame.data[i+2]-prevFrame.data[i+2]);
            if(d>thrPix) diffPix++; total++;
          }
          if(diffPix<MIN_PIXELS) diffPix=0;
          const activity = diffPix/Math.max(1,total);
          actEma = actEma*(1-EMA_ALPHA) + activity*EMA_ALPHA;
          const {up,down} = thresholdsFromSens(eff);
          if(!above){
            if(actEma>=up){ above=true; aboveSince=nowPerf; }
          }else{
            if(actEma<=down){ above=false; aboveSince=0; }
            else if(detectionEnabled && (nowPerf-aboveSince)>=HOLD_MS){ trigger(); }
          }
        }
        prevFrame=frame;
      }
      requestAnimationFrame(loop);
    }

    /* ===== Helpers overlay ===== */
    function roundRect(ctx,x,y,w,h,r){
      const rr = Math.min(r, h/2, w/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y,   x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x,   y+h, rr);
      ctx.arcTo(x,   y+h, x,   y,   rr);
      ctx.arcTo(x,   y,   x+w, y,   rr);
      ctx.closePath();
    }
    function fitText(ctx, text, maxW, basePx){
      let size = Math.floor(basePx);
      ctx.font = `900 ${size}px system-ui,-apple-system,Segoe UI,Roboto,Arial`;
      while(size>12 && ctx.measureText(text).width > maxW){
        size -= 1;
        ctx.font = `900 ${size}px system-ui,-apple-system,Segoe UI,Roboto,Arial`;
      }
      return size;
    }
    function elideText(ctx, text, maxW){
      if(ctx.measureText(text).width <= maxW) return text;
      const ell = '…';
      const ellW = ctx.measureText(ell).width;
      let lo=0, hi=text.length;
      while(lo<hi){
        const mid = Math.floor((lo+hi+1)/2);
        const s = text.slice(0, mid);
        if(ctx.measureText(s).width + ellW <= maxW) lo=mid; else hi=mid-1;
      }
      return text.slice(0, lo) + ell;
    }

    function drawOverlayTimes(w,h,rowsRunning, rowsFrozen){
      overlayRowHitboxes = [];
      const nowSync = Date.now() + serverOffsetMS;

      const running = (rowsRunning||[])
        .slice()
        .sort((a,b)=> (b.startMS||0)-(a.startMS||0));

      const frozen = (rowsFrozen||[]).slice().sort((a,b)=> (a.pos||0)-(b.pos||0));
      const merged = running.slice();
      for(const f of frozen){
        const pos = Math.max(0, Math.min((f.pos||0), merged.length));
        const idx = merged.findIndex(x=>x.id===f.id);
        const rowObj = { ...f, frozen:true };
        if (idx>=0) merged.splice(idx,1,rowObj); else merged.splice(pos,0,rowObj);
      }

      if(!merged.length) return;

      const base = Math.max(18, Math.floor(h*0.026));
      const gapBase  = Math.max(5, Math.floor(h*0.011));
      const gap  = gapBase * 2.4;
      const leftPad = Math.floor(w*0.065);
      const rightPad= Math.floor(w*0.065);
      const topPad = Math.floor(h*0.20);
      const rowH = base*1.45;
      const radius = rowH/1.9;

      octx.globalAlpha = 1;
      octx.textBaseline='middle';
      octx.fillStyle = '#FFFFFF';

      const maxRows = Math.min(merged.length, Math.floor((h-topPad)/((rowH+10)+gap)));
      let y = topPad;

      for(let i=0;i<maxRows;i++){
        const r = merged[i];
        const isFrozen = !!r.frozen;
        const elapsed = isFrozen ? r.frozenMs : (nowSync - (r.startMS||nowSync));
        const tText = fmt(elapsed);
        const nameFull = ((r.dorsal ? r.dorsal+' ' : '') + (r.name||'—'));

        const pillX = leftPad-10, pillW = (w - leftPad - rightPad) + 20, pillY = y-6, pillH = rowH+12;
        const grad = octx.createLinearGradient(0, pillY, 0, pillY+pillH);
        grad.addColorStop(0, 'rgba(45,50,60,.42)');
        grad.addColorStop(1, 'rgba(30,34,42,.42)');
        roundRect(octx, pillX, pillY, pillW, pillH, radius);
        octx.fillStyle = grad; octx.fill();

        octx.save();
        octx.lineWidth = 2;
        octx.strokeStyle = 'rgba(255,255,255,.12)';
        roundRect(octx, pillX+1, pillY+1, pillW-2, pillH-2, radius-1.5);
        octx.stroke();
        octx.restore();

        // Marco naranja (con parpadeo) cuando está congelado
        if (isFrozen){
          const vis = frozenVisualState(r.createdAt);
          if (vis.show){
            octx.save();
            octx.lineWidth = 2;
            octx.strokeStyle = 'rgba(255,156,58,.95)';
            roundRect(octx, pillX-1, pillY-1, pillW+2, pillH+2, radius+1);
            octx.stroke();
            octx.restore();
          }
        }

        const nameX = leftPad + 8;
        const nameY = y + rowH/2;
        const timeX = w - rightPad - 18;

        octx.font = `900 ${base}px system-ui,-apple-system,Segoe UI,Roboto,Arial`;
        const timeStrokeW = Math.max(2, Math.floor(base*0.16));
        const timeW = Math.max(octx.measureText(tText).width + timeStrokeW*2, 80);
        const minGap = 18;
        const maxNameW = Math.max(60, (timeX - minGap) - nameX - timeW);

        const nameText = elideText(octx, nameFull, maxNameW);
        octx.textAlign='left';
        octx.fillStyle='#FFFFFF';
        octx.fillText(nameText, nameX, nameY);

        octx.textAlign='right';
        octx.strokeStyle = 'rgba(0,0,0,.55)';
        octx.lineWidth = timeStrokeW;
        octx.strokeText(tText, timeX, nameY);
        octx.fillStyle='#FFFFFF';
        octx.fillText  (tText, timeX, nameY);

        // SALIDA: RESTART / CONTINUE
        if(!isFrozen && phase==='start' && goBackId===r.id){
          const mid = pillX + pillW/2;
          roundRect(octx, pillX+2, pillY+2, pillW/2-3, pillH-4, radius-3);
          octx.fillStyle = 'rgba(229,72,72,.92)'; octx.fill();
          roundRect(octx, mid+1,  pillY+2, pillW/2-3, pillH-4, radius-3);
          octx.fillStyle = 'rgba(56,214,107,.92)'; octx.fill();

          octx.textAlign='center'; octx.fillStyle='#fff';
          octx.strokeStyle='rgba(0,0,0,.55)';
          const ty = nameY, pad = 20, halfW = pillW/2 - 3 - pad*2;

          let fs = fitText(octx, 'RESTART', halfW, base*1.05);
          octx.lineWidth = Math.max(3, Math.floor(fs*0.22));
          octx.font = `900 ${fs}px system-ui,-apple-system,Segoe UI,Roboto,Arial`;
          octx.strokeText('RESTART', pillX + pillW/4,  ty); octx.fillText('RESTART', pillX + pillW/4,  ty);

          fs = fitText(octx, 'CONTINUE', halfW, base*1.05);
          octx.lineWidth = Math.max(3, Math.floor(fs*0.22));
          octx.font = `900 ${fs}px system-ui,-apple-system,Segoe UI,Roboto,Arial`;
          octx.strokeText('CONTINUE', mid + pillW/4, ty); octx.fillText('CONTINUE', mid + pillW/4, ty);

          overlayRowHitboxes.push({ kind:'btn', btn:'RESTART',  baseId:r.id, x:pillX+2, y:pillY+2, w:pillW/2-3, h:pillH-4 });
          overlayRowHitboxes.push({ kind:'btn', btn:'CONTINUE', baseId:r.id, x:mid+1,  y:pillY+2, w:pillW/2-3, h:pillH-4 });
        }

        // META: ON TRACK / FINISH (si showActions)
        if (isFrozen && r.showActions){
          const mid = pillX + pillW/2;
          roundRect(octx, pillX+2, pillY+2, pillW/2-3, pillH-4, radius-3);
          octx.fillStyle = 'rgba(56,214,107,.92)'; octx.fill();
          roundRect(octx, mid+1,  pillY+2, pillW/2-3, pillH-4, radius-3);
          octx.fillStyle = 'rgba(229,72,72,.92)'; octx.fill();

          octx.textAlign='center'; octx.fillStyle='#fff';
          octx.strokeStyle='rgba(0,0,0,.55)';
          const ty = nameY, pad = 20, halfW = pillW/2 - 3 - pad*2;

          let fs = fitText(octx, 'ON TRACK', halfW, base*1.05);
          octx.lineWidth = Math.max(3, Math.floor(fs*0.22));
          octx.font = `900 ${fs}px system-ui,-apple-system,Segoe UI,Roboto,Arial`;
          octx.strokeText('ON TRACK', pillX + pillW/4,  ty); octx.fillText('ON TRACK', pillX + pillW/4,  ty);

          fs = fitText(octx, 'FINISH', halfW, base*1.05);
          octx.lineWidth = Math.max(3, Math.floor(fs*0.22));
          octx.font = `900 ${fs}px system-ui,-apple-system,Segoe UI,Roboto,Arial`;
          octx.strokeText('FINISH', mid + pillW/4, ty); octx.fillText('FINISH', mid + pillW/4, ty);

          overlayRowHitboxes.push({ kind:'btn', btn:'STAY',   baseId:r.id, x:pillX+2, y:pillY+2, w:pillW/2-3, h:pillH-4 });
          overlayRowHitboxes.push({ kind:'btn', btn:'FINISH', baseId:r.id, x:mid+1,  y:pillY+2, w:pillW/2-3, h:pillH-4 });
        }

        overlayRowHitboxes.push({ kind:'row', baseId:r.id, x:pillX, y:pillY, w:pillW, h:pillH, frozen:isFrozen });

        y += (rowH+10) + gap;
      }
    }
  </script>
</body>
</html>
