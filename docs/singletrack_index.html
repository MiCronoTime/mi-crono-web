<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SINGLETRACK ‚Äî Inicio</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    :root{ --bg:#121418; --panel:#1b1f27; --panel2:#232a34; --text:#e8ecf1; --muted:#b5bdc9; --border:#2b3240; --accent:#5ea1ff; --accent2:#7cc4ff; --danger:#ff7b8c; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 800px at 20% -10%, #151924 0%, transparent 60%),radial-gradient(1200px 800px at 120% 10%, #1a2030 0%, transparent 55%),var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .titleTop{display:flex;align-items:center;gap:12px;font-size:32px;font-weight:900;letter-spacing:.02em;margin:6px 0 10px 0;text-transform:uppercase}
    .connected{background:var(--panel2);border:1px solid var(--border);border-radius:10px;padding:6px 10px;margin-bottom:10px;color:var(--muted);max-width:560px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .h2{font-size:24px;font-weight:900;text-transform:uppercase;margin:0 0 12px 0}
    label{display:block;margin:10px 0 6px 0;font-weight:800}
    input,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0f1217;color:var(--text)}

    /* Cabecera tabla fake */
    .colsHead{display:grid;grid-template-columns:140px 1fr;gap:6px;margin:8px 0}
    .chip{background:#0f1217;border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-weight:900;color:#cfe1ff;text-transform:uppercase}

    /* Textarea con look de dos columnas */
    textarea#evList{
      min-height:190px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      line-height:1.65;
      /* raya vertical a 140px para simular la separaci√≥n de columnas */
      background:
        linear-gradient(to right, transparent 0, transparent 138px, rgba(255,255,255,.08) 138px, rgba(255,255,255,.08) 140px, transparent 140px) no-repeat,
        #0f1217;
      background-size: 100% 100%;
      tab-size: 12; /* que el tab encaje m√°s o menos con la columna */
      white-space: pre;
    }

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:14px;border:1px solid var(--border);background:#0f1217;color:var(--text);cursor:pointer;font-weight:800;letter-spacing:.02em;text-transform:uppercase}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#0b1220}
    .btn.primary:hover{background:var(--accent2);border-color:var(--accent2)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#111}
    .rowBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .muted{color:var(--muted)}
    .caps{text-transform:uppercase}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} .connected{max-width:100%} }

    /* Modal selector de eventos */
    .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(92vw,560px);max-height:80vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 70px rgba(0,0,0,.5);padding:14px}
    .modal h3{margin:4px 0 10px 0;font-size:20px;text-transform:uppercase}
    .evItem{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0f1217;cursor:pointer;margin-bottom:8px}
    .evItem:hover{background:#111720}
    .smallMuted{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="titleTop">‚è±Ô∏è SINGLETRACK</div>
    <div id="who" class="connected">Conectado: ‚Äî</div>

    <div class="grid">
      <!-- CREAR -->
      <section class="panel">
        <div class="h2">Crear evento</div>
        <label class="caps">C√≥digo del evento</label>
        <input id="evCode" type="text" placeholder="P.EJ. TEST1" autocomplete="off"/>

        <label class="caps" style="margin-top:12px">Participantes (uno por l√≠nea, en orden de salida)</label>
        <div class="colsHead">
          <div class="chip">Dorsal</div>
          <div class="chip">Nombre</div>
        </div>
        <textarea id="evList" placeholder="101    CORREDOR 1&#10;102    CORREDOR 2&#10;103    CORREDOR 3"></textarea>
        <div class="muted" style="margin-top:6px">
          El dorsal es opcional. Puedes escribir <b>solo el nombre</b> o bien <b>DORSAL + TAB/espacios + NOMBRE</b>.
        </div>

        <div class="rowBtns">
          <button id="btnLoadList" class="btn">Cargar lista</button>
          <button id="btnSave" class="btn primary">Guardar evento</button>
        </div>

        <div class="muted" style="margin-top:10px">
          Si el evento ya existe, se <b>RESETEA por completo</b> (borra participantes y tiempos) y se crean estos nuevos.
        </div>
      </section>

      <!-- UNIRSE -->
      <section class="panel">
        <div class="h2">Unirse a un evento</div>
        <label class="caps">C√≥digo</label>
        <input id="joinCode" type="text" placeholder="TEST1" autocomplete="off"/>

        <div class="rowBtns">
          <a id="goStart"  class="btn">üèÅ Salida</a>
          <a id="goFinish" class="btn">‚ö†Ô∏è Meta</a>
          <a id="goResult" class="btn">üßæ Resultados</a>
        </div>

        <div class="muted" style="margin-top:10px">
          Abre <b>SALIDA</b> en la salida y <b>META</b> en la llegada. Ambos con el mismo <b>c√≥digo</b>.
        </div>
      </section>
    </div>

    <!-- HERRAMIENTAS -->
    <section class="panel" style="margin-top:16px">
      <div class="h2">Herramientas</div>
      <div class="muted" style="margin-bottom:10px">
        <b>Reset eventos</b> elimina <u>todos</u> los eventos y sus participantes de tu base de datos. √ösalo solo si quieres limpiar por completo.
      </div>
      <button id="btnReset" class="btn danger">Reset eventos</button>
    </section>
  </div>

  <!-- MODAL: seleccionar evento para cargar lista -->
  <div id="pickMask" class="modalMask" role="dialog" aria-modal="true" aria-labelledby="pickTitle">
    <div class="modal">
      <h3 id="pickTitle">Selecciona un evento</h3>
      <div id="pickList"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
        <button id="pickCancel" class="btn">Cancelar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { ensureAuthInit, requireAuth, currentCtx } from './js/auth.js';

    await ensureAuthInit();
    await requireAuth('index.html');

    const who = document.getElementById('who');
    const { uid, email } = currentCtx();
    who.textContent = `Conectado: ${email}`;

    const evCode   = document.getElementById('evCode');
    const evList   = document.getElementById('evList');
    const joinCode = document.getElementById('joinCode');

    const btnSave     = document.getElementById('btnSave');
    const btnLoadList = document.getElementById('btnLoadList');
    const btnReset    = document.getElementById('btnReset');

    const goStart  = document.getElementById('goStart');
    const goFinish = document.getElementById('goFinish');
    const goResult = document.getElementById('goResult');

    // Modal
    const pickMask  = document.getElementById('pickMask');
    const pickList  = document.getElementById('pickList');
    const pickCancel= document.getElementById('pickCancel');

    // May√∫sculas ‚Äúsuaves‚Äù
    const toUC = (s)=> (s||'').normalize('NFC').toUpperCase();
    evCode.addEventListener('input', ()=>{ evCode.value = toUC(evCode.value); });
    joinCode.addEventListener('input', ()=>{ joinCode.value = toUC(joinCode.value); });
    evList.addEventListener('input', ()=>{
      // Convierte el bloque a may√∫sculas pero respeta tabs/espacios
      const pos = evList.selectionStart;
      evList.value = toUC(evList.value);
      evList.selectionStart = evList.selectionEnd = pos;
    });

    // Firebase
    const { initializeApp, getApps, getApp } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
    const {
      getFirestore, doc, collection, getDoc, setDoc, serverTimestamp, writeBatch,
      getDocs, query, orderBy, deleteDoc
    } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');

    const app = getApps().length ? getApp() : initializeApp({
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    });
    const db = getFirestore(app);

    // Helpers de path
    const eventRef = (code)=> doc(db,'users',uid,'events',toUC(code));
    const partsCol = (code)=> collection(eventRef(code),'participants');

    // Parsear textarea -> [{order,name,dorsal?}]
    function parseParticipants(raw){
      const out=[];
      (raw||'').split(/\r?\n/).forEach((line,i)=>{
        const s = line.trim();
        if(!s) return;
        // DORSAL [sep] NOMBRE | o solo NOMBRE
        const m = s.match(/^(\d{1,6})[\s,;:-]+(.+)$/);
        let dorsal=null, name=s;
        if(m){ dorsal=m[1]; name=m[2]; }
        out.push({ order:i+1, name:toUC(name.trim()), ...(dorsal?{dorsal:toUC(dorsal)}:{}) });
      });
      return out;
    }

    // Guardar evento (resetea participantes)
    btnSave.addEventListener('click', async ()=>{
      const code = toUC(evCode.value.trim());
      if(!code){ alert('Pon un C√ìDIGO de evento'); return; }
      const list = parseParticipants(evList.value);
      if(!list.length){ alert('A√±ade al menos un participante'); return; }

      try{
        await setDoc(eventRef(code), { code, updatedAt: serverTimestamp(), createdAt: serverTimestamp() }, { merge:true });

        // borrar participantes existentes
        const snap = await getDocs(partsCol(code));
        const batchDel = writeBatch(db);
        snap.forEach(d => batchDel.delete(d.ref));
        await batchDel.commit();

        // insertar nuevos
        const batch = writeBatch(db);
        list.forEach(p=>{
          const ref = doc(partsCol(code));
          batch.set(ref, p);
        });
        await batch.commit();

        alert('Evento guardado');
      }catch(e){
        alert('Error guardando: '+(e.message||e));
      }
    });

    // Selector de eventos (modal)
    btnLoadList.addEventListener('click', async ()=>{
      // Carga lista de eventos del usuario
      pickList.innerHTML = '<div class="smallMuted">Cargando‚Ä¶</div>';
      pickMask.style.display = 'flex';
      try{
        const evsSnap = await getDocs(query(collection(db,'users',uid,'events'), orderBy('updatedAt','desc')));
        if(evsSnap.empty){ pickList.innerHTML = '<div class="smallMuted">No tienes eventos a√∫n.</div>'; return; }
        pickList.innerHTML = '';
        evsSnap.forEach(docu=>{
          const d = docu.data()||{};
          const when = d.updatedAt?.toDate ? d.updatedAt.toDate() : (d.updatedAt? new Date(d.updatedAt.seconds*1000): null);
          const nice = when ? new Intl.DateTimeFormat('es-ES',{dateStyle:'medium', timeStyle:'short'}).format(when) : '‚Äî';
          const div = document.createElement('div');
          div.className = 'evItem';
          div.innerHTML = `<div><b>${d.code||docu.id}</b><div class="smallMuted">${nice}</div></div><div class="smallMuted">Seleccionar</div>`;
          div.addEventListener('click', ()=> pickLoad(docu.id));
          pickList.appendChild(div);
        });
      }catch(e){
        pickList.innerHTML = `<div class="smallMuted">Error: ${e.message||e}</div>`;
      }
    });
    pickCancel.addEventListener('click', ()=>{ pickMask.style.display='none'; });

    async function pickLoad(codeSel){
      try{
        const snap = await getDocs(query(partsCol(codeSel), orderBy('order','asc')));
        if(snap.empty){ alert('Ese evento no tiene participantes'); return; }
        const lines = [];
        snap.forEach(d=>{
          const p = d.data();
          const name = toUC(p.name||'');
          const dorsal = p.dorsal ? String(p.dorsal) : '';
          lines.push(dorsal ? `${dorsal}\t${name}` : name);
        });
        evList.value = lines.join('\n');
        pickMask.style.display='none';
        alert(`Lista cargada desde ${codeSel}. Cambia el C√ìDIGO y pulsa GUARDAR EVENTO para crear uno nuevo.`);
      }catch(e){ alert('No se pudo cargar la lista: '+(e.message||e)); }
    }

    // Ir a SALIDA / META / RESULTADOS usando joinCode
    const codeFromJoin = ()=> toUC(joinCode.value.trim());
    goStart.onclick  = ()=>{ const c=codeFromJoin(); if(!c) return alert('Pon un c√≥digo'); location.href=`camera.html?mode=start&code=${encodeURIComponent(c)}`; };
    goFinish.onclick = ()=>{ const c=codeFromJoin(); if(!c) return alert('Pon un c√≥digo'); location.href=`camera.html?mode=finish&code=${encodeURIComponent(c)}`; };
    goResult.onclick = ()=>{ const c=codeFromJoin(); if(!c) return alert('Pon un c√≥digo'); location.href=`result.html?code=${encodeURIComponent(c)}`; };

    // Reset de todos mis eventos
    btnReset.addEventListener('click', async ()=>{
      if(!confirm('Esto borrar√° TODOS tus eventos y participantes. ¬øSeguro?')) return;
      try{
        const evsSnap = await getDocs(collection(db,'users',uid,'events'));
        for(const evDoc of evsSnap.docs){
          const ps = await getDocs(collection(evDoc.ref,'participants'));
          const b1 = writeBatch(db); ps.forEach(x=>b1.delete(x.ref)); await b1.commit();
          await deleteDoc(evDoc.ref);
        }
        alert('Limpieza completada');
      }catch(e){ alert('Error al resetear: '+(e.message||e)); }
    });
  </script>
</body>
</html>
