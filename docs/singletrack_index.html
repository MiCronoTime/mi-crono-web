<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SINGLETRACK ‚Äî Inicio</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    :root{
      --bg:#121418; --panel:#1b1f27; --panel2:#232a34; --text:#e8ecf1; --muted:#b5bdc9;
      --border:#2b3240; --accent:#5ea1ff; --accent2:#7cc4ff; --danger:#ff7b8c;
    }
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(1200px 800px at 20% -10%, #151924 0%, transparent 60%),
                 radial-gradient(1200px 800px at 120% 10%, #1a2030 0%, transparent 55%),
                 var(--bg);
      color:var(--text)
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .title{font-size:32px;font-weight:900;letter-spacing:.06em;text-transform:uppercase}
    .userbar{margin-top:6px;background:rgba(0,0,0,.35);border:1px solid var(--border);border-radius:10px;padding:8px 12px;display:inline-block}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px}
    h2{margin:0 0 12px 0;text-transform:uppercase;letter-spacing:.04em;font-size:24px}
    label{display:block;margin:10px 0 6px 0;font-weight:800;text-transform:uppercase;letter-spacing:.03em}
    input,textarea{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);
      background:#0f1217;color:var(--text);font-size:15px
    }
    textarea{min-height:140px;resize:vertical}
    small.muted{color:var(--muted)}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 16px;
      border-radius:12px;border:1px solid var(--border);background:#0f1217;color:var(--text);
      font-weight:900;text-transform:uppercase;letter-spacing:.03em;cursor:pointer
    }
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#0b1220}
    .btn.primary:hover{background:var(--accent2);border-color:var(--accent2)}
    .btn.ghost{background:#0f1217;border-color:var(--border)}
    .btn.danger{background:#611b26;border-color:#8a2b3a}
    .rowbtns{display:flex;gap:10px;flex-wrap:wrap}
    .tools{margin-top:16px}
    .muted{color:var(--muted)}
    .ok{color:#7cffb6;font-weight:800}
    .err{color:#ff7b8c;font-weight:800}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">SINGLETRACK</div>
    </div>
    <div id="userBar" class="userbar" style="display:none">Conectado: ‚Äî</div>

    <div class="grid" style="margin-top:12px">
      <section class="panel">
        <h2>Crear evento</h2>

        <label>C√≥digo del evento</label>
        <input id="eventCode" placeholder="P.EJ. TEST1" oninput="this.value=this.value.toUpperCase()"/>

        <label style="margin-top:10px">Participantes (uno por l√≠nea, en orden de salida)</label>
        <textarea id="parts" placeholder="CORREDOR 1

CORREDOR 2
CORREDOR 3"></textarea>

        <small class="muted" style="display:block;margin-top:10px">
          Si el evento ya existe, se <b>RESETEA por completo</b> (borra participantes y tiempos) y se crean estos nuevos.
        </small>

        <div class="rowbtns" style="margin-top:14px">
          <button id="btnSave" class="btn primary">Guardar evento</button>
        </div>

        <div id="state" class="muted" style="margin-top:10px">‚Äî</div>
      </section>

      <section class="panel">
        <h2>Unirse a un evento</h2>

        <label>C√≥digo</label>
        <input id="joinCode" placeholder="TEST1" oninput="this.value=this.value.toUpperCase()"/>
          oninput="this.value=this.value.toUpperCase()" style="text-transform:uppercase;"

        <div class="rowbtns" style="margin-top:14px">
          <a id="goStart"  class="btn ghost">üèÅ&nbsp;Salida</a>
          <a id="goFinish" class="btn ghost">üî∫&nbsp;Meta</a>
          <a id="goResult" class="btn ghost">üóÇÔ∏è&nbsp;Resultados</a>
        </div>

        <small class="muted" style="display:block;margin-top:12px">
          Abre <b>SALIDA</b> en la salida y <b>META</b> en la llegada. Ambos con el mismo <b>c√≥digo</b>.
        </small>
      </section>
    </div>

    <section class="panel tools">
      <h2>Herramientas</h2>
      <p class="muted">
        <b>RESET EVENTOS</b> elimina <u>todos</u> los eventos y sus participantes de tu base de datos. √ösalo solo si quieres limpiar por completo.
      </p>
      <div class="rowbtns">
        <button id="btnReset" class="btn danger">Reset eventos</button>
      </div>
    </section>
  </div>

  <script type="module">
    import { ensureAuthInit, requireAuth, currentCtx, mountUserBar, logout } from './js/auth.js';
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js';
    import {
      getFirestore, doc, setDoc, collection, addDoc, getDocs, deleteDoc,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';

    (async function init(){
      // Login y barra de usuario
      await ensureAuthInit();
      await requireAuth('index.html');
      mountUserBar('userBar');

      // Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
        authDomain: "mi-crono-time-888b7.firebaseapp.com",
        projectId: "mi-crono-time-888b7",
        storageBucket: "mi-crono-time-888b7.appspot.com",
        messagingSenderId: "379025900327",
        appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
      };
      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const db  = getFirestore(app);

      const { uid } = currentCtx();
      const $=id=>document.getElementById(id);

      const codeEl   = $('eventCode');
      const partsEl  = $('parts');
      const joinCode = $('joinCode');
      const stateEl  = $('state');

      function CODE(){ return (codeEl.value||'').trim().toUpperCase(); }
      function JCODE(){ return (joinCode.value||'').trim().toUpperCase(); }
      function PARTS(){
        return (partsEl.value||'')
          .split(/\r?\n/).map(s=>s.trim()).filter(Boolean)
          .map(s=>s.toUpperCase());
      }

      // Guardar evento (resetea el existente)
      $('btnSave').onclick = async ()=>{
        stateEl.textContent = 'Guardando‚Ä¶';
        stateEl.className = 'muted';
        try{
          const code = CODE(); if(!code) throw new Error('Escribe un c√≥digo de evento');
          const eventRef = doc(db,'users',uid,'events',code);
          await setDoc(eventRef,{ code, createdAt: serverTimestamp() },{ merge:true });

          const list = PARTS();
          if(list.length){
            const partsCol = collection(eventRef,'participants');
            // borrado r√°pido de participantes existentes
            const prev = await getDocs(partsCol);
            for(const d of prev.docs) await deleteDoc(d.ref);
            // alta de nuevos
            for(let i=0;i<list.length;i++){
              await addDoc(partsCol,{
                name:list[i], order:i+1, startTS:null, stopTS:null, createdAt: serverTimestamp()
              });
            }
          }
          stateEl.textContent = 'Evento guardado';
          stateEl.className = 'ok';
        }catch(e){
          stateEl.textContent = 'Error: '+(e.message||e);
          stateEl.className = 'err';
          console.error(e);
        }
      };

      // Navegaci√≥n SALIDA / META / RESULTADOS
      $('goStart').onclick  = (e)=>{ e.preventDefault();
        const c=JCODE(); if(!c){ alert('Escribe el c√≥digo en "C√≥digo"'); return; }
        location.href = `camera.html?code=${encodeURIComponent(c)}&mode=start`;
      };
      $('goFinish').onclick = (e)=>{ e.preventDefault();
        const c=JCODE(); if(!c){ alert('Escribe el c√≥digo en "C√≥digo"'); return; }
        location.href = `camera.html?code=${encodeURIComponent(c)}&mode=finish`;
      };
      $('goResult').onclick = (e)=>{ e.preventDefault();
        const c=JCODE(); if(!c){ alert('Escribe el c√≥digo en "C√≥digo"'); return; }
        location.href = `result.html?code=${encodeURIComponent(c)}`;
      };

      // Reset eventos del usuario
      $('btnReset').onclick = async ()=>{
        if(!confirm('¬øSeguro que quieres BORRAR TODOS tus eventos y participantes?\nEsta acci√≥n no se puede deshacer.')) return;
        stateEl.textContent='Borrando‚Ä¶'; stateEl.className='muted';
        try{
          const evs = await getDocs(collection(db,'users',uid,'events'));
          for(const ev of evs.docs){
            const partsSnap = await getDocs(collection(ev.ref,'participants'));
            for(const p of partsSnap.docs) await deleteDoc(p.ref);
            const syncSnap = await getDocs(collection(ev.ref,'sync'));
            for(const s of syncSnap.docs) await deleteDoc(s.ref);
            await deleteDoc(ev.ref);
          }
          stateEl.textContent='Reset completado'; stateEl.className='ok';
        }catch(e){
          stateEl.textContent='Error al resetear: '+(e.message||e); stateEl.className='err';
          console.error(e);
        }
      };
    })();
  </script>
</body>
</html>
