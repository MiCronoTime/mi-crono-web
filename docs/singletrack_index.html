<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SINGLETRACK ‚Äî Inicio</title>
  <style>
    :root{
      --bg:#121418; --panel:#1b1f27; --panel-2:#232a34; --text:#e8ecf1; --muted:#b5bdc9;
      --border:#2b3240; --accent:#5ea1ff; --accent-2:#7cc4ff; --danger:#ff758d; --ok:#7cffb6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #151924 0%, transparent 60%),
                  radial-gradient(1200px 800px at 120% 10%, #1a2030 0%, transparent 55%),
                  var(--bg);
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{color:var(--accent-2)}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    header.top{display:flex;align-items:center;gap:12px;margin:6px 0 12px}
    header.top h1{margin:0;font-size:22px;letter-spacing:.05em;text-transform:uppercase;font-weight:900}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .title{margin:0 0 10px 0;font-weight:900;letter-spacing:.05em;text-transform:uppercase}
    label{display:block;margin:10px 0 6px 0;font-weight:800;letter-spacing:.03em;text-transform:uppercase}
    input,textarea{
      width:100%; background:#0f1217; color:var(--text); border:1px solid var(--border); border-radius:12px; padding:12px 14px;
      font-size:15px; outline:0; transition:border-color .15s; text-transform:uppercase;
    }
    input::placeholder,textarea::placeholder{ color:#8a93a3; text-transform:none }
    input:focus,textarea:focus{ border-color:var(--accent) }
    .row{display:grid;grid-template-columns:1fr; gap:10px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;min-height:44px;
      padding:11px 16px;border-radius:12px;border:1px solid var(--border);
      background:#0f1217;color:var(--text);cursor:pointer;font-weight:900;text-transform:uppercase;letter-spacing:.04em;
    }
    .btn:hover{background:#12161d}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#0b1220}
    .btn.primary:hover{background:var(--accent-2);border-color:var(--accent-2)}
    .btn.danger{background:#1a0f13;border-color:#3a1b25;color:#ffd0da}
    .muted{color:var(--muted)}
    .stack{display:grid;gap:10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .grid2{grid-template-columns:1fr} }
    .note{font-size:13px;color:var(--muted)}
    .ok{color:var(--ok);font-weight:800}
    .err{color:var(--danger);font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div style="font-size:20px">üïí</div>
      <h1>SINGLETRACK</h1>
      <div id="fbState" class="muted" style="margin-left:auto">Conectando‚Ä¶</div>
    </header>

    <!-- CREAR EVENTO -->
    <section class="card">
      <h2 class="title">Crear evento</h2>
      <div class="stack">
        <div>
          <label for="newCode">C√≥digo del evento</label>
          <input id="newCode" type="text" placeholder="P.EJ. TEST1" autocomplete="off" autocapitalize="off" spellcheck="false">
          <div class="note">El c√≥digo se usar√° en SALIDA y META.</div>
        </div>
        <div>
          <label for="newParts">Participantes (uno por l√≠nea)</label>
          <textarea id="newParts" rows="5" placeholder="ANA\nPEPE\nLOLA"></textarea>
          <div class="note">Se guardar√°n en MAY√öSCULAS y en el mismo orden.</div>
        </div>
        <div class="grid2">
          <button id="btnSaveEvent" class="btn primary">GUARDAR EVENTO</button>
          <button id="btnReset" class="btn danger" title="Borra TODOS los eventos">RESET EVENTOS</button>
        </div>
        <div id="createMsg" class="muted"></div>
      </div>
    </section>

    <!-- UNIRSE -->
    <section class="card">
      <h2 class="title">Unirse a un evento</h2>
      <div class="stack">
        <div>
          <label for="joinCode">C√≥digo</label>
          <input id="joinCode" type="text" placeholder="TEST1" autocomplete="one-time-code" autocapitalize="off" spellcheck="false">
        </div>
        <div class="grid2">
          <a id="btnStart" class="btn" href="#">üì± SALIDA</a>
          <a id="btnFinish" class="btn" href="#">üèÅ META</a>
        </div>
        <div class="note">Abre SALIDA en un m√≥vil y META en otro con el mismo c√≥digo.</div>
      </div>
    </section>

    <!-- RESULTADOS -->
    <section class="card">
      <h2 class="title">Resultado</h2>
      <div class="stack">
        <div class="row">
          <a id="btnResult" class="btn" href="#">VER RESULTADO</a>
        </div>
        <div class="note">La p√°gina de resultados se actualiza sola conforme van llegando.</div>
      </div>
    </section>
  </div>

  <!-- Firebase + l√≥gica -->
  <script type="module">
    // May√∫sculas + saneo
    function wireUpper(el){
      if(!el) return;
      el.addEventListener('input', ()=>{
        el.value = el.value.toUpperCase().replace(/[^A-Z0-9_-\\n ]/g,'');
      });
    }

    const newCode = document.getElementById('newCode');
    const joinCode= document.getElementById('joinCode');
    const newParts= document.getElementById('newParts');
    wireUpper(newCode); wireUpper(joinCode); wireUpper(newParts);

    const fbState = document.getElementById('fbState');
    const createMsg= document.getElementById('createMsg');

    const { initializeApp, getApp, getApps } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
    const { getAuth, signInAnonymously } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js');
    const {
      getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, deleteDoc, query, orderBy, writeBatch
    } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');

    const firebaseConfig = {
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    signInAnonymously(auth).catch(console.error);

    const db  = getFirestore(app);
    fbState.textContent = 'Conectado';

    // Guardar evento (sin sobreescribir participantes existentes)
    document.getElementById('btnSaveEvent').onclick = async ()=>{
      const code = (newCode.value||'').trim().toUpperCase();
      if(!code){ createMsg.innerHTML='<span class="err">Introduce un c√≥digo.</span>'; return; }

      createMsg.textContent = 'Guardando‚Ä¶';
      try{
        const evRef = doc(db,'events',code);
        const evSnap= await getDoc(evRef);
        const now   = new Date();

        // crea/actualiza doc del evento
        await setDoc(evRef, { code, type:'SINGLETRACK', updatedAt: now, createdAt: evSnap.exists()? evSnap.data().createdAt || now : now }, { merge:true });

        // a√±adir participantes nuevos (uno por l√≠nea)
        const text = (newParts.value||'').trim();
        if(text){
          const lines = text.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean).map(s=>s.toUpperCase());
          const partsCol = collection(evRef,'participants');

          // calcular siguiente orden
          let maxOrder = 0;
          const existing = await getDocs(query(partsCol, orderBy('order','asc')));
          existing.forEach(d=>{ maxOrder = Math.max(maxOrder, Number(d.data().order||0)); });

          const batch = writeBatch(db);
          let i=1;
          for(const name of lines){
            const docRef = doc(partsCol); // id auto
            batch.set(docRef, { name, order: maxOrder + i, startTS:null, stopTS:null });
            i++;
          }
          await batch.commit();
        }

        createMsg.innerHTML = '<span class="ok">Evento guardado.</span>';
      }catch(e){
        console.error(e);
        createMsg.innerHTML = '<span class="err">Error guardando.</span>';
      }
    };

    // Reset eventos (borra TODO /events)
    document.getElementById('btnReset').onclick = async ()=>{
      if(!confirm('¬øSeguro que quieres BORRAR TODOS los eventos? Esta acci√≥n no se puede deshacer.')) return;
      fbState.textContent = 'Borrando‚Ä¶';
      try{
        const evs = await getDocs(collection(db,'events'));
        for(const evDoc of evs.docs){
          const evRef = evDoc.ref;
          // borrar subcolecciones conocidas
          for(const sub of ['participants','sync']){
            const colRef = collection(evRef, sub);
            const subs = await getDocs(colRef);
            for(const d of subs.docs){ await deleteDoc(d.ref); }
          }
          await deleteDoc(evRef);
        }
        fbState.innerHTML = '<span class="ok">Reiniciado.</span>';
      }catch(e){
        console.error(e);
        fbState.innerHTML = '<span class="err">Error al resetear (permisos).</span>';
      }
    };

    // Navegaci√≥n SALIDA/META/RESULTADO
    const norm = (s)=> (s||'').trim().toUpperCase();
    document.getElementById('btnStart').onclick = (e)=>{
      e.preventDefault();
      const code = norm(joinCode.value);
      if(!code) return alert('Introduce el c√≥digo.');
      location.href = `camera.html?code=${encodeURIComponent(code)}&mode=start`;
    };
    document.getElementById('btnFinish').onclick = (e)=>{
      e.preventDefault();
      const code = norm(joinCode.value);
      if
::contentReference[oaicite:0]{index=0}
