<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SINGLETRACK ‚Äî Inicio</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    :root{
      --bg:#121418; --panel:#1b1f27; --panel-2:#232a34; --text:#e8ecf1;
      --muted:#b5bdc9; --border:#2b3240; --accent:#5ea1ff; --accent-2:#7cc4ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #151924 0%, transparent 60%),
                  radial-gradient(1200px 800px at 120% 10%, #1a2030 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{color:var(--accent-2)}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{display:flex;align-items:center;gap:10px}
    .title .emoji{font-size:28px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25);margin-bottom:12px}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    label{font-weight:800;text-transform:uppercase;letter-spacing:.03em}
    input, textarea{
      width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);
      background:#0f1217;color:var(--text);font-size:16px
    }
    input.upper, textarea.upper{ text-transform:uppercase; }
    textarea{min-height:120px;resize:vertical}
    .muted{color:var(--muted)}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 16px;border-radius:12px;border:1px solid var(--border);
      background:#0f1217;color:var(--text);cursor:pointer;font-weight:800;text-transform:uppercase;letter-spacing:.03em
    }
    .btn:hover{background:#12161d}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#0b1220}
    .btn.primary:hover{background:var(--accent-2);border-color:var(--accent-2)}
    .gridBtns{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .note{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div class="title">
        <span class="emoji">‚è±Ô∏è</span>
        <h1 style="margin:0;text-transform:uppercase;letter-spacing:.04em">SINGLETRACK</h1>
      </div>
      <div id="miniStatus" class="muted">No conectado</div>
    </header>

    <!-- Crear/gestionar evento (igual que antes) -->
    <section class="card">
      <h2 style="margin:0 0 8px 0;text-transform:uppercase;letter-spacing:.04em">Crear evento</h2>
      <div class="row">
        <label>C√≥digo del evento</label>
        <input id="eventCode" class="upper" placeholder="p.ej. TEST1" autocomplete="off"/>

        <label>Participantes (uno por l√≠nea)</label>
        <textarea id="participants" class="upper" placeholder="ANA
PEPE
LOLA"></textarea>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="btnSaveEvent" class="btn primary">Guardar evento</button>
          <button id="btnResetEvents" class="btn">Reset eventos</button>
          <span class="note">* Borra <b>tus</b> eventos (propiedad tuya).</span>
        </div>
      </div>
    </section>

    <!-- Abrir c√°mara / resultados -->
    <section class="card">
      <h2 style="margin:0 0 8px 0;text-transform:uppercase;letter-spacing:.04em">Abrir</h2>
      <div class="gridBtns">
        <a id="goStart"  class="btn" href="#">üì± SALIDA</a>
        <a id="goFinish" class="btn" href="#">üèÅ META</a>
      </div>
      <div style="margin-top:10px">
        <a id="goResult" class="btn" href="#">üìä Resultados</a>
      </div>
      <p class="muted" style="margin-top:8px">
        Consejo: copia el enlace de SALIDA/META y √°brelo en dos m√≥viles distintos.
        <br/><a href="index.html">‚á¶ Volver a INICIO (login/registro)</a>
      </p>
    </section>
  </div>

  <script type="module">
    import { initAuthUI, auth } from './js/auth.js';
    import {
      getFirestore, doc, setDoc, serverTimestamp,
      collection, getDocs, deleteDoc, query, where
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    // Solo usamos initAuthUI para actualizar estado (no muestra formularios aqu√≠)
    initAuthUI({
      onLogin: (user)=> document.getElementById('miniStatus').textContent = `Conectado: ${user.email || user.uid}`,
      onLogout: ()=> document.getElementById('miniStatus').textContent = 'No conectado'
    });

    const db = getFirestore();
    const codeInput = document.getElementById('eventCode');
    const participantsInput = document.getElementById('participants');
    const btnSave = document.getElementById('btnSaveEvent');
    const btnReset = document.getElementById('btnResetEvents');

    const goStart  = document.getElementById('goStart');
    const goFinish = document.getElementById('goFinish');
    const goResult = document.getElementById('goResult');

    function codeOrAlert(){
      const raw = (codeInput?.value || '').trim();
      if(!raw){ alert('Introduce un c√≥digo de evento.'); return null; }
      return raw.toUpperCase();
    }
    goStart.onclick = (e)=>{ e.preventDefault(); const c=codeOrAlert(); if(!c) return;
      location.href = `camera.html?code=${encodeURIComponent(c)}&mode=start`; };
    goFinish.onclick = (e)=>{ e.preventDefault(); const c=codeOrAlert(); if(!c) return;
      location.href = `camera.html?code=${encodeURIComponent(c)}&mode=finish`; };
    goResult.onclick = (e)=>{ e.preventDefault(); const c=codeOrAlert(); if(!c) return;
      location.href = `result.html?code=${encodeURIComponent(c)}`; };

    function requireAuth(){
      const u = auth.currentUser;
      if(!u){
        alert('Inicia sesi√≥n en el INICIO para gestionar tus eventos.');
        return null;
      }
      return u;
    }

    btnSave.onclick = async (e)=>{
      e.preventDefault();
      const u = requireAuth(); if(!u) return;
      const raw = (codeInput.value||'').trim(); if(!raw) return alert('Introduce un c√≥digo.');
      const code = raw.toUpperCase();

      const ref = doc(db,'events',code);
      await setDoc(ref, {
        code, ownerUid: u.uid,
        updatedAt: serverTimestamp(),
        createdAt: serverTimestamp()
      }, { merge:true });

      if (participantsInput && participantsInput.value.trim()){
        const names = participantsInput.value.split('\n').map(s=>s.trim()).filter(Boolean);
        for(let i=0;i<names.length;i++){
          const name = names[i].toUpperCase();
          const pRef = doc(collection(ref,'participants'));
          await setDoc(pRef, { name, order:i+1, startTS:null, stopTS:null });
        }
      }
      alert('Evento guardado.');
    };

    btnReset.onclick = async (e)=>{
      e.preventDefault();
      const u = requireAuth(); if(!u) return;
      if(!confirm('¬øSeguro que quieres borrar TODOS tus eventos?')) return;

      const q = query(collection(db,'events'), where('ownerUid','==',u.uid));
      const snap = await getDocs(q);
      const deletions = [];
      for(const d of snap.docs){ deletions.push(deleteDoc(d.ref)); }
      await Promise.allSettled(deletions);
      alert('Eventos borrados.');
    };
  </script>
</body>
</html>
