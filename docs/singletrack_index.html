<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SINGLETRACK — Inicio</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    :root{ --bg:#121418; --panel:#1b1f27; --panel2:#232a34; --text:#e8ecf1; --muted:#b5bdc9; --border:#2b3240; --accent:#5ea1ff; --accent2:#7cc4ff; --danger:#ff7b8c; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 800px at 20% -10%, #151924 0%, transparent 60%),radial-gradient(1200px 800px at 120% 10%, #1a2030 0%, transparent 55%),var(--bg);color:var(--text)}
    .wrap{max-width:1000px;margin:0 auto;padding:18px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:14px}
    .title{font-size:28px;font-weight:900;letter-spacing:.04em;text-transform:uppercase;margin:4px 0 12px 0;display:flex;align-items:center;gap:8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    label{display:block;margin:8px 0 6px 0;font-weight:800;text-transform:uppercase;letter-spacing:.03em}
    input, textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0f1217;color:var(--text)}
    textarea{min-height:120px;resize:vertical}
    small.muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:14px;border:1px solid var(--border);background:#0f1217;color:var(--text);cursor:pointer;font-weight:900;text-transform:uppercase;letter-spacing:.03em}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#0b1220}
    .btn.primary:hover{background:var(--accent2);border-color:var(--accent2)}
    .btn.danger{background:#3a1217;border-color:#83202b}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media(max-width:760px){ .row,.grid3{grid-template-columns:1fr} }
    .ok{color:#7cffb6;font-weight:800}
    .err{color:#ff7b8c;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="userBar" style="display:none"></div>

    <div class="panel">
      <div class="title">SINGLETRACK</div>
      <div class="row">
        <div>
          <label>Código del evento</label>
          <input id="eventCode" placeholder="p.ej. TEST1" oninput="this.value=this.value.toUpperCase()"/>
          <small class="muted">Se guardará como MAYÚSCULAS.</small>
        </div>
        <div>
          <label>Participantes (uno por línea)</label>
          <textarea id="parts" placeholder="ANA
PEPE
MARIO"></textarea>
          <small class="muted">Se convertirán a MAYÚSCULAS por orden de salida.</small>
        </div>
      </div>

      <div class="grid3" style="margin-top:12px">
        <button id="btnSave" class="btn primary">GUARDAR EVENTO</button>
        <button id="goStart" class="btn">SALIDA</button>
        <button id="goFinish" class="btn">META</button>
      </div>

      <div class="grid3" style="margin-top:10px">
        <button id="goResult" class="btn">RESULTADO</button>
        <button id="btnReset" class="btn danger">RESET EVENTOS</button>
        <button id="btnLogout" class="btn">Cerrar sesión</button>
      </div>

      <div style="margin-top:8px">
        <span>Estado: </span><span id="state" class="muted">—</span>
      </div>
    </div>
  </div>

  <script type="module">
    import { ensureAuthInit, requireAuth, currentCtx, mountUserBar, logout } from './js/auth.js';
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js';
    import {
      getFirestore, doc, setDoc, collection, addDoc, getDocs, deleteDoc,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';

    (async function init(){
      await ensureAuthInit();
      await requireAuth('index.html');
      mountUserBar('userBar');

      const firebaseConfig = {
        apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
        authDomain: "mi-crono-time-888b7.firebaseapp.com",
        projectId: "mi-crono-time-888b7",
        storageBucket: "mi-crono-time-888b7.appspot.com",
        messagingSenderId: "379025900327",
        appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
      };
      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const db  = getFirestore(app);

      const { uid } = currentCtx();
      const $=id=>document.getElementById(id);
      const state=$('state');
      const codeEl=$('eventCode');
      const partsEl=$('parts');

      function CODE(){ return (codeEl.value||'').trim().toUpperCase(); }
      function PARTS(){
        return (partsEl.value||'')
          .split(/\r?\n/).map(s=>s.trim()).filter(Boolean)
          .map(s=>s.toUpperCase());
      }

      $('btnSave').onclick = async ()=>{
        state.textContent='Guardando...';
        try{
          const code = CODE();
          if(!code) throw new Error('Escribe un código');
          const eventRef = doc(db,'users',uid,'events',code);
          await setDoc(eventRef, { code, createdAt: serverTimestamp() }, { merge:true });

          const existing = PARTS();
          if(existing.length){
            const partsCol = collection(eventRef,'participants');
            for(let i=0;i<existing.length;i++){
              await addDoc(partsCol, {
                name: existing[i], order: i+1, startTS: null, stopTS: null, createdAt: serverTimestamp()
              });
            }
          }
          state.textContent='Evento guardado'; state.className='ok';
        }catch(e){
          state.textContent='Error: '+(e.message||e); state.className='err';
          console.error(e);
        }
      };

      $('goStart').onclick = (e)=>{ e.preventDefault();
        const c=CODE(); if(!c){ alert('Escribe un código'); return; }
        location.href = `camera.html?code=${encodeURIComponent(c)}&mode=start`;
      };
      $('goFinish').onclick = (e)=>{ e.preventDefault();
        const c=CODE(); if(!c){ alert('Escribe un código'); return; }
        location.href = `camera.html?code=${encodeURIComponent(c)}&mode=finish`;
      };
      $('goResult').onclick = (e)=>{ e.preventDefault();
        const c=CODE(); if(!c){ alert('Escribe un código'); return; }
        location.href = `result.html?code=${encodeURIComponent(c)}`;
      };

      $('btnReset').onclick = async ()=>{
        if(!confirm('¿Seguro que quieres BORRAR TODOS tus eventos? Esta acción no se puede deshacer.')) return;
        state.textContent='Borrando...';
        try{
          // borra TODOS los docs bajo /users/{uid}/events/** (solo tus eventos)
          const eventsSnap = await getDocs(collection(db,'users',uid,'events'));
          for(const ev of eventsSnap.docs){
            // borra participantes
            const partsSnap = await getDocs(collection(ev.ref,'participants'));
            for(const p of partsSnap.docs){ await deleteDoc(p.ref); }
            // borra sync
            const syncSnap = await getDocs(collection(ev.ref,'sync'));
            for(const s of syncSnap.docs){ await deleteDoc(s.ref); }
            // borra evento
            await deleteDoc(ev.ref);
          }
          state.textContent='Reset completado'; state.className='ok';
        }catch(e){
          state.textContent='Error al resetear: '+(e.message||e); state.className='err';
          console.error(e);
        }
      };

      $('btnLogout').onclick = async ()=>{ await logout(); location.href='index.html'; };
    })();
  </script>
</body>
</html>
