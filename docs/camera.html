<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono — CÁMARA</title>
  <style>
    :root{
      --bg:#0f141c; --panel:#161c24; --panel2:#1b2330; --border:#2a3342;
      --text:#eaf0f8; --muted:#b5c0d1; --accent:#6eb0ff; --good:#6ff0a8; --bad:#ff7a8a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1000px;margin:0 auto;padding:12px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:6px 0 10px}
    .title{font-weight:900;letter-spacing:.06em;text-transform:uppercase}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--panel2);color:var(--muted);font-weight:700}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);text-decoration:none;font-weight:900;letter-spacing:.03em}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#08101b}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){ .grid{grid-template-columns:3fr 2fr} }

    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px}
    .videoBox{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--border);background:#000}
    video{width:100%;display:block;background:#000}
    .gate{
      position:absolute; top:0; bottom:0; width:8%; min-width:24px; pointer-events:none;
      background:linear-gradient(90deg, rgba(255,0,0,.25), rgba(255,0,0,.35));
      border-left:2px solid rgba(255,0,0,.6); border-right:2px solid rgba(255,0,0,.6);
      left:50%; transform:translateX(-50%);
    }

    .status{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .status .dot{width:10px;height:10px;border-radius:50%;background:#ffb703}
    .status.ok .dot{background:#4ade80}

    /* Lista LIVE — crono + delta pequeñito a la derecha (solo en SPLIT) */
    .liveList{display:flex;flex-direction:column;gap:8px; max-height:50vh; overflow:auto}
    .item{display:flex;align-items:center;gap:8px;background:var(--panel2);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .name{font-weight:900;text-transform:uppercase;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .time{margin-left:auto;font-weight:900;letter-spacing:.4px}
    .mini-delta{margin-left:8px;font-size:12px;font-weight:900;opacity:.9;display:none}
    .mini-delta.good{display:inline;color:var(--good)}
    .mini-delta.bad{display:inline;color:var(--bad)}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="status" id="status">
        <span class="dot"></span>
        <span id="statText">Conectando…</span>
      </div>
      <div class="pill" id="modePill">—</div>
      <a class="btn" href="result.html">⬜ Resultados</a>
    </div>

    <div class="grid">
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0 8px">
          <div><b>Evento:</b> <span id="evCode">—</span></div>
          <button id="btnCam" class="btn">ACTIVAR CÁMARA</button>
        </div>
        <div class="videoBox">
          <video id="video" playsinline muted></video>
          <div class="gate"></div>
        </div>
        <div class="muted" style="margin-top:6px">Coloca al corredor para que cruce entre las franjas rojas.</div>
      </section>

      <aside class="card">
        <div class="title" style="margin-bottom:8px">EN VIVO</div>
        <div id="liveList" class="liveList">
          <div class="muted">Cargando…</div>
        </div>
      </aside>
    </div>
  </div>

  <script type="module">
    // ===== Parámetros =====
    const qp = new URL(location.href).searchParams;
    const CODE = (qp.get('code')||'').toUpperCase();
    let MODE = (qp.get('mode')||'').toLowerCase();
    if(MODE==='split1') MODE='split'; // alias
    const $ = id => document.getElementById(id);

    $('evCode').textContent = CODE || '—';
    $('modePill').textContent = MODE==='start'?'SALIDA':(MODE==='finish'?'META':(MODE==='split'?'SPLIT':'—'));

    // ===== Cooldowns =====
    const COOLDOWN_START_MS  = 2000;
    const COOLDOWN_SPLIT_MS  = 900;
    const COOLDOWN_FINISH_MS = 900;
    let cooling = false;
    const setCooldown = (ms)=>{ cooling = true; setTimeout(()=> cooling=false, ms); };

    // ===== Firebase =====
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore, doc, collection, query, orderBy, where, getDocs, onSnapshot, updateDoc, getDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const evRef  = doc(db,'events',CODE);
    const partsC = collection(evRef,'participants');

    // ===== Utils =====
    const two = n => String(n).padStart(2,'0');
    const thr = n => String(n).padStart(3,'0');
    const tsMs = ts => ts ? (ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6)) : null;
    const msFmt = ms => { ms=Math.max(0,Math.floor(ms||0));
      const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), ms3=ms%1000;
      return `${two(m)}:${two(s)}.${thr(ms3)}`; };

    // ===== Estado UI =====
    const statusEl = $('status'); const statText = $('statText');
    function setOK(ok){ statusEl.classList.toggle('ok', !!ok); statText.textContent = ok ? 'Conectado' : 'Conectando…'; }

    // ===== Cámara =====
    const video = $('video');
    let stream=null;
    $('btnCam').onclick = async ()=>{
      try{
        if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; video.srcObject=null; $('btnCam').textContent='ACTIVAR CÁMARA'; return; }
        stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
        video.srcObject = stream; await video.play();
        $('btnCam').textContent='DESACTIVAR CÁMARA';
      }catch(e){ alert('No se pudo activar la cámara: ' + (e.message||e)); }
    };

    // ===== Detector de movimiento simple =====
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d',{ willReadFrequently:true });
    let lastFrame=null;
    const MOTION_PIXELS = 1200;
    function motionLoop(){
      if(!video.videoWidth){ requestAnimationFrame(motionLoop); return; }
      canvas.width=video.videoWidth; canvas.height=video.videoHeight;
      ctx.drawImage(video,0,0);
      const curr = ctx.getImageData(0,0,canvas.width,canvas.height).data;
      let changes=0;
      if(lastFrame){
        for(let i=0;i<curr.length;i+=4){
          const diff = Math.abs(curr[i]-lastFrame[i]) + Math.abs(curr[i+1]-lastFrame[i+1]) + Math.abs(curr[i+2]-lastFrame[i+2]);
          if(diff>90) changes++;
        }
      }
      lastFrame = new Uint8ClampedArray(curr);
      if(changes>MOTION_PIXELS) onMotionDetected();
      requestAnimationFrame(motionLoop);
    }
    requestAnimationFrame(motionLoop);

    // ===== Búsquedas =====
    async function nextToStart(){
      const q = query(partsC, where('startTS','==',null), orderBy('order','asc'));
      const s = await getDocs(q);
      return s.docs[0] || null;
    }
    async function nextToSplit(){
      const q = query(partsC, where('startTS','!=',null), orderBy('order','asc'));
      const s = await getDocs(q);
      return s.docs.find(d => !d.data().split1TS) || null;
    }
    async function nextToFinish(){
      const q = query(partsC, where('startTS','!=',null), orderBy('order','asc'));
      const s = await getDocs(q);
      return s.docs.find(d => !d.data().stopTS) || null;
    }

    // Mejor split actual (duración mínima split1 - start)
    async function bestSplit1DurMS(){
      const q = query(partsC, where('split1TS','!=',null));
      const s = await getDocs(q);
      let best = null;
      for(const d of s.docs){
        const x=d.data(); const a=tsMs(x.startTS), b=tsMs(x.split1TS);
        if(a!=null && b!=null){
          const dur=b-a;
          if(best==null || dur<best) best=dur;
        }
      }
      return best; // ms o null
    }

    // ===== Lógica detección =====
    async function onMotionDetected(){
      if(cooling || !CODE || !MODE) return;
      try{
        if(MODE==='start'){
          const n=await nextToStart();
          if(!n){ flash('Sin participantes por salir'); setCooldown(COOLDOWN_START_MS); return; }
          await updateDoc(n.ref,{ startTS: serverTimestamp() });
          flash(`SALIDA: ${n.data().name}`);
          setCooldown(COOLDOWN_START_MS);
        }else if(MODE==='split'){
          const n=await nextToSplit();
          if(!n){ flash('Nadie en pista para Split'); setCooldown(COOLDOWN_SPLIT_MS); return; }
          await updateDoc(n.ref,{ split1TS: serverTimestamp() });

          // Tras guardar, calcular delta vs mejor
          setTimeout(async ()=>{
            const snap=await getDoc(n.ref); const x=snap.data();
            const a=tsMs(x.startTS), b=tsMs(x.split1TS);
            if(a!=null && b!=null){
              const curr=b-a;
              const best=await bestSplit1DurMS();
              const diff = (best==null) ? 0 : (curr - Math.min(best,curr));
              showMiniDeltaFor(n.id, diff); // 4 s
            }
          }, 200);

          flash(`SPLIT: ${n.data().name}`);
          setCooldown(COOLDOWN_SPLIT_MS);
        }else if(MODE==='finish'){
          const n=await nextToFinish();
          if(!n){ flash('No hay corredor por finalizar'); setCooldown(COOLDOWN_FINISH_MS); return; }
          await updateDoc(n.ref,{ stopTS: serverTimestamp() });
          flash(`META: ${n.data().name}`);
          setCooldown(COOLDOWN_FINISH_MS);
        }
      }catch(e){
        console.error(e); flash('Error al actualizar');
      }
    }

    function flash(t){ statText.textContent=t; setOK(true); setTimeout(()=>{ setOK(true); statText.textContent='Conectado'; },1500); }

    // ===== LIVE list (tiempos y mini-delta) =====
    const liveList = $('liveList');
    function renderLive(rows){
      if(!rows.length){ liveList.innerHTML = `<div class="muted">Sin corredores</div>`; return; }
      liveList.innerHTML = rows.map(r=>{
        return `<div class="item">
          <div class="name">${(r.name||'').toUpperCase()}</div>
          <div class="time" data-id="${r.id}">00:00.000</div>
          <span class="mini-delta" id="md-${r.id}">+0.000</span>
        </div>`;
      }).join('');
    }

    // Suscripción de “en pista”
    let liveState = new Map(); // id -> {startMS, stopMS}
    function startLive(){
      const qLive = query(partsC, where('startTS','!=',null), orderBy('order','asc'));
      onSnapshot(qLive, snap=>{
        liveState.clear();
        const rows=[];
        snap.docs.forEach(d=>{
          const x=d.data();
          rows.push({ id:d.id, name:x.name||'' });
          liveState.set(d.id, { startMS:tsMs(x.startTS), stopMS:tsMs(x.stopTS), split1MS:tsMs(x.split1TS) });
        });
        renderLive(rows);
      });

      // pintar tiempos en vivo
      const loop=()=> {
        const now=Date.now();
        liveState.forEach((st,id)=>{
          const el = document.querySelector(`.time[data-id="${id}"]`);
          if(!el) return;
          if(!st.startMS){ el.textContent='00:00.000'; return; }
          const ms = st.stopMS ? (st.stopMS - st.startMS) : (now - st.startMS);
          el.textContent = msFmt(ms);
        });
        requestAnimationFrame(loop);
      };
      requestAnimationFrame(loop);
    }

    // Mostrar mini-delta 4 s junto al crono (solo en SPLIT)
    const deltaTimers = new Map();
    function showMiniDeltaFor(id, diffMS){
      if(MODE!=='split') return; // no mostrar en start/finish
      const el = document.getElementById(`md-${id}`); if(!el) return;
      // limpiar timer anterior
      if(deltaTimers.has(id)){ clearTimeout(deltaTimers.get(id)); deltaTimers.delete(id); }
      const sign = diffMS<=0 ? '' : '+';
      el.textContent = `${sign}${msFmt(Math.abs(diffMS))}`;
      el.className = 'mini-delta ' + (diffMS<=0 ? 'good' : 'bad');
      const to = setTimeout(()=>{ el.className='mini-delta'; }, 4000);
      deltaTimers.set(id,to);
    }

    // ===== Init =====
    setOK(true);
    startLive();

  </script>
</body>
</html>
