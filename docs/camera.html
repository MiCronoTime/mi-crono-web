<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono — CÁMARA</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    :root{
      --bg:#121418; --panel:#1b1f27; --panel-2:#232a34; --text:#e8ecf1;
      --muted:#b5bdc9; --border:#2b3240; --accent:#5ea1ff; --accent-2:#7cc4ff; --hud: rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #151924 0%, transparent 60%),
                  radial-gradient(1200px 800px at 120% 10%, #1a2030 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{color:var(--accent-2)}
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .tag{opacity:.9}
    .grid.one{display:grid;gap:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .controls .btn{flex:1 1 0; min-height:44px; justify-content:center; white-space:nowrap}
    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:11px 16px;border-radius:12px;border:1px solid var(--border);
      background:#0f1217;color:var(--text);cursor:pointer;user-select:none;transition:transform .05s, background .15s, border-color .15s, color .15s;
      text-transform:uppercase;font-weight:800;letter-spacing:.03em;font-size:14px;line-height:1;text-decoration:none;
    }
    .btn:hover{ background:#12161d } .btn:active{ transform:translateY(1px) }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#0b1220 }
    .btn.primary:hover{ background:var(--accent-2); border-color:var(--accent-2) }

    .stage{position:relative;margin-top:10px;border-radius:16px;overflow:hidden;height:60vh;background:#000;display:flex;align-items:center;justify-content:center;border:1px solid var(--border)}
    video{width:100%;height:100%;object-fit:cover;background:#000;display:block}
    canvas.overlay{position:absolute;inset:0;pointer-events:none}

    .hud{position:absolute;left:12px;right:12px;top:12px;background:var(--hud);color:#fff;border-radius:14px;padding:10px 14px;font-weight:700;backdrop-filter:blur(4px)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#2b3240;color:#e8ecf1}

    .sub{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:12px}
    label{display:block;margin-bottom:6px;font-weight:700}
    input[type=range]{width:100%}
    .list{margin-top:12px}
    .runner{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0f1217;margin-bottom:6px}
    .badge{font-weight:800;color:#cfe1ff;opacity:.9}
    .rname{font-weight:800;text-transform:uppercase}
    .rtime{font-weight:900;letter-spacing:.4px}
    .muted{color:var(--muted)} .ok{color:#7cffb6;font-weight:700} .err{color:#ff758d;font-weight:700}
  </style>
</head>
<body class="wrap">
  <header class="top">
    <h1 id="title" style="text-transform:uppercase;letter-spacing:.04em">MODO</h1>
    <p class="tag" id="tag">Conectando…</p>
  </header>

  <main class="grid one">
    <section class="card warn" id="noCodeBox" style="display:none">
      <b id="i-missCode">Falta el código de evento.</b> <span id="i-goHome">Vuelve a</span> <a href="index.html" id="i-home">Inicio</a> <span id="i-andJoin">y crea/únete a un evento.</span>
    </section>

    <section class="card">
      <div class="controls">
        <button id="btnEnableCam" class="btn primary"><span id="i-enable">ACTIVAR CÁMARA</span></button>
        <a id="btnResult" class="btn" href="#"><span id="i-result">VER RESULTADO</span></a>
      </div>
      <small class="muted" id="i-ios">iOS: Safari + HTTPS + permitir Cámara.</small>

      <div class="stage" id="stage">
        <video id="video" playsinline muted></video>
        <canvas id="overlay" class="overlay"></canvas>

        <div class="hud" id="hudTop">
          <span id="hudStatus">Listo</span>
          • <span id="hudNext" class="pill">Siguiente: —</span>
        </div>
      </div>

      <div class="sub">
        <label id="i-sensLbl">Sensibilidad detector (franja roja)</label>
        <input id="sens" type="range" min="1" max="100" value="25"/>
        <small class="muted" id="i-sensHint">Más a la derecha = más sensible.</small>
      </div>

      <div class="sub list">
        <h2 style="margin:0 0 8px 0;text-transform:uppercase;letter-spacing:.04em" id="i-running">En curso</h2>
        <div id="runningList">—</div>
      </div>
    </section>

    <section class="card">
      <h2 style="text-transform:uppercase;letter-spacing:.04em;margin:0 0 8px 0" id="i-status">Estado</h2>
      <div>Firebase: <span id="fbState">—</span></div>
      <div id="i-eventLbl">Evento:</div> <span id="evState">—</span>
      <div id="i-lastLbl">Última acción:</div> <span id="lastAction">—</span>
    </section>
  </main>

  <footer style="margin-top:10px"><a class="muted" href="index.html" id="i-back">⇦ Volver a Inicio</a></footer>

  <script type="module">
    // ===== i18n (solo textos) =====
    const L = {
      ca:{
        modeStart:'MODE SORTIDA', modeFinish:'MODE META',
        connecting:'Connectant…', missCode:'Falta el codi d\'esdeveniment.',
        goHome:'Torna a', home:'Inici', andJoin:'i crea/uneix-te a un esdeveniment.',
        enable:'ACTIVA LA CÀMERA', result:'VEURE RESULTATS',
        ios:'iOS: Safari + HTTPS + permetre Càmera.',
        sensLbl:'Sensibilitat del detector (franja vermella)',
        sensHint:'Més a la dreta = més sensible.',
        running:'En curs', status:'Estat', eventLbl:'Esdeveniment:', lastLbl:'Darrera acció:',
        ready:'A punt', next:'Següent: '
      },
      en:{
        modeStart:'START MODE', modeFinish:'FINISH MODE',
        connecting:'Connecting…', missCode:'Event code is missing.',
        goHome:'Go back to', home:'Home', andJoin:'and create/join an event.',
        enable:'ENABLE CAMERA', result:'SEE RESULTS',
        ios:'iOS: Safari + HTTPS + allow Camera.',
        sensLbl:'Detector sensitivity (red band)',
        sensHint:'Right = more sensitive.',
        running:'In progress', status:'Status', eventLbl:'Event:', lastLbl:'Last action:',
        ready:'Ready', next:'Next: '
      },
      es:{
        modeStart:'MODO SALIDA', modeFinish:'MODO META',
        connecting:'Conectando…', missCode:'Falta el código de evento.',
        goHome:'Vuelve a', home:'Inicio', andJoin:'y crea/únete a un evento.',
        enable:'ACTIVAR CÁMARA', result:'VER RESULTADOS',
        ios:'iOS: Safari + HTTPS + permitir Cámara.',
        sensLbl:'Sensibilidad detector (franja roja)',
        sensHint:'Más a la derecha = más sensible.',
        running:'En curso', status:'Estado', eventLbl:'Evento:', lastLbl:'Última acción:',
        ready:'Listo', next:'Siguiente: '
      }
    };
    const lang = localStorage.getItem('lang') || 'ca';
    function tApply(){
      const T=L[lang];
      const getParam=(k)=> new URL(location.href).searchParams.get(k);
      const mode=(getParam('mode')||'start');
      document.getElementById('title').textContent = (mode==='start'?T.modeStart:T.modeFinish);
      document.getElementById('tag').textContent = T.connecting;
      document.getElementById('i-missCode').textContent = T.missCode;
      document.getElementById('i-goHome').textContent = T.goHome;
      document.getElementById('i-home').textContent = T.home;
      document.getElementById('i-andJoin').textContent = T.andJoin;
      document.getElementById('i-enable').textContent = T.enable;
      document.getElementById('i-result').textContent = T.result;
      document.getElementById('i-ios').textContent = T.ios;
      document.getElementById('i-sensLbl').textContent = T.sensLbl;
      document.getElementById('i-sensHint').textContent = T.sensHint;
      document.getElementById('i-running').textContent = T.running;
      document.getElementById('i-status').textContent = T.status;
      document.getElementById('i-eventLbl').firstChild && (document.getElementById('i-eventLbl').firstChild.textContent = T.eventLbl+' ');
      document.getElementById('i-eventLbl').textContent = T.eventLbl;
      document.getElementById('i-lastLbl').textContent = T.lastLbl;
      document.getElementById('i-back').textContent = (lang==='en'?'⇦ Back to Home':(lang==='ca'?'⇦ Tornar a Inici':'⇦ Volver a Inicio'));
      document.getElementById('hudStatus').textContent = T.ready;
      // Hud "Siguiente/Next/Següent" se compone dinámicamente más abajo
    }
    tApply();

    // ---------- Utils ----------
    const $=(id)=>document.getElementById(id);
    const two=(n)=>String(n).padStart(2,'0');
    const three=(n)=>String(n).padStart(3,'0');
    const fmt=(ms)=>{ ms=Math.max(0,Math.floor(ms||0));
      const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), ms3=ms%1000;
      return `${two(m)}:${two(s)}.${three(ms3)}`; };
    const getParam=(k)=> new URL(location.href).searchParams.get(k);
    const code=(getParam('code')||'').toUpperCase();
    const mode=(getParam('mode')||'start'); // start|finish

    const tag=$('tag'), fbState=$('fbState'), evState=$('evState'), lastAction=$('lastAction');
    const btnEnable=$('btnEnableCam'), btnResult=$('btnResult');
    const stage=$('stage'), video=$('video'), overlay=$('overlay'), sens=$('sens');
    const octx=overlay.getContext('2d',{willReadFrequently:true});

    tag.textContent=`${L[lang].connecting}`;
    if(!code){ $('noCodeBox').style.display=''; evState.textContent=(lang==='en'?'NO CODE':(lang==='ca'?'SENSE CODI':'SIN CÓDIGO')); evState.className='err'; }
    else { evState.textContent=code; evState.className='ok'; }
    btnResult.onclick=(e)=>{ e.preventDefault(); location.href=`result.html?code=${encodeURIComponent(code)}`; };

    // ---------- Reloj sincronizado ----------
    let serverOffsetMS = 0; // ahora = Date.now() + serverOffsetMS
    const tsToMillis=(ts)=> ts ? (ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6)) : null;

    // ---------- Firebase ----------
    try{
      const { initializeApp, getApp, getApps } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
      const {
        getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot,
        serverTimestamp, collection, query, orderBy, getDocs, addDoc, where
      } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');

      const firebaseConfig = {
        apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
        authDomain: "mi-crono-time-888b7.firebaseapp.com",
        projectId: "mi-crono-time-888b7",
        storageBucket: "mi-crono-time-888b7.appspot.com",
        messagingSenderId: "379025900327",
        appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
      };
      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const db  = getFirestore(app);
      window.__firebaseReady=true; fbState.textContent='OK'; fbState.className='ok';

      // refs
      const eventRef = doc(db,'events',code);
      const partsCol = collection(eventRef,'participants');
      const syncCol  = collection(eventRef,'sync');

      // Crea evento si no existe
      const s=await getDoc(eventRef);
      if(!s.exists()) await setDoc(eventRef,{code,createdAt:serverTimestamp()},{merge:true});

      // Offset con servidor (1 ping)
      try{
        const pingRef = await addDoc(syncCol,{ serverNow: serverTimestamp() });
        const pingSnap = await getDoc(pingRef);
        const serverNowMs = tsToMillis(pingSnap.data().serverNow);
        serverOffsetMS = (serverNowMs ?? Date.now()) - Date.now();
      }catch(_){ serverOffsetMS=0; }

      // Estado participantes
      let participants=[];
      async function reload(){ const snap=await getDocs(query(partsCol, orderBy('order','asc')));
        participants = snap.docs.map(d=>({ id:d.id, ref:d.ref, ...d.data() })); }
      const nextToStart = ()=> participants.find(p=>!p.startTS);
      const runningSorted = ()=> participants.filter(p=>p.startTS && !p.stopTS)
        .sort((a,b)=> tsToMillis(a.startTS) - tsToMillis(b.startTS) );

      // Acciones
      async function startNext(){ await reload(); const p=nextToStart(); if(!p) return null;
        await updateDoc(p.ref,{ startTS:serverTimestamp(), stopTS:null }); return p; }
      async function stopEarliest(){ await reload(); const run=runningSorted(); const p=run[0]; if(!p) return null;
        await updateDoc(p.ref,{ stopTS:serverTimestamp() }); return p; }

      // Suscripción -> cronos en vivo
      let currentLive=[];
      onSnapshot(partsCol, async ()=>{
        await reload();
        const run = runningSorted().map(p=>({
          order: p.order||0,
          name: (p.name||'').toUpperCase(),
          startMS: tsToMillis(p.startTS)
        }));
        currentLive = run;

        const nxt = nextToStart();
        document.getElementById('hudNext').textContent = L[lang].next + (nxt ? (nxt.name||'—').toUpperCase() : '—');

        const hasStart = participants.some(p=>p.startTS);
        const hasStop  = participants.some(p=>p.stopTS);
        tag.textContent = `${(lang==='en'?'Event':(lang==='ca'?'Esdeveniment':'Evento'))} ${code} • ${hasStart?(lang==='en'?'Start OK':(lang==='ca'?'Inici OK':'Inicio OK')):(lang==='en'?'No start':(lang==='ca'?'Sense inici':'Sin inicio'))} ${hasStop?'• '+(lang==='en'?'Some finish':(lang==='ca'?'Algun fi':'Algún fin')):''}`;

        renderList(run);
      });

      // ===== Cámara + detección =====
      const T = L[lang];
      btnEnable.onclick = async ()=>{
        try{
          if(!navigator.mediaDevices?.getUserMedia){ alert(lang==='en'?'Browser without camera':(lang==='ca'?'Navegador sense càmera':'Navegador sin cámara')); return; }
          const tries=[{video:{facingMode:{ideal:'environment'}},audio:false},{video:{facingMode:'environment'},audio:false},{video:true,audio:false}];
          let stream=null,lastErr=null;
          for(const c of tries){ try{ stream=await navigator.mediaDevices.getUserMedia(c); if(stream) break; } catch(e){ lastErr=e; } }
          if(!stream){ alert((lang==='en'?'Cannot open camera: ':(lang==='ca'?'No s\'ha pogut obrir la càmera: ':'No se pudo abrir la cámara: '))+(lastErr?.name?lastErr.name+': ':'')+(lastErr?.message||'')); return; }
          video.setAttribute('playsinline','true'); video.muted=true; video.srcObject=stream;
          await new Promise(res=>{ if(video.readyState>=2) res(); else video.onloadedmetadata=()=>res(); }); await video.play();
          btnEnable.textContent= T.enable;
          btnEnable.disabled=true;
          requestAnimationFrame(loop);
        }catch(e){ alert((lang==='en'?'Camera error: ':(lang==='ca'?'Error càmera: ':'Error cámara: '))+(e?.message||e)); }
      };

      // === Detector por diferencia, con refractario por modo ===
      const COOLDOWN_START_MS  = 3000;
      const COOLDOWN_FINISH_MS = 1500;
      let prev=null, armed=true, cooldownTimer=null;

      const armAfter = (ms)=>{
        clearTimeout(cooldownTimer);
        cooldownTimer = setTimeout(()=>{ armed=true; }, ms);
      };

      const trigger = async ()=>{
        if(!armed) return;
        armed=false;
        armAfter(mode==='start' ? COOLDOWN_START_MS : COOLDOWN_FINISH_MS);

        if(mode==='start'){
          const p=await startNext();
          if(p){ lastAction.textContent=(lang==='en'?'Start: ':(lang==='ca'?'Inici: ':'Inicio: '))+(p.name||p.id); }
        }else{
          const p=await stopEarliest();
          if(p){ lastAction.textContent=(lang==='en'?'Finish: ':(lang==='ca'?'Fi: ':'Fin: '))+(p.name||p.id); }
        }
      };

      function loop(){
        const w=overlay.width=stage.clientWidth, h=overlay.height=stage.clientHeight;

        // Franjas rojas
        const roiWidth=Math.round(w*0.08), cx=Math.round(w*0.5), x1=cx-Math.round(roiWidth/2), x2=cx+Math.round(roiWidth/2);
        octx.clearRect(0,0,w,h);
        octx.fillStyle='rgba(255,0,0,.35)'; octx.fillRect(x1,0,2,h); octx.fillRect(x2-2,0,2,h);
        octx.fillStyle='rgba(255,0,0,.18)'; octx.fillRect(x1,0,roiWidth,h);

        // Cronos superpuestos
        drawOverlayTimes(w,h,currentLive);

        // Detector
        const vw=video.videoWidth, vh=video.videoHeight;
        if(vw && vh){
          const scaleX = vw / stage.clientWidth;
          const sx=Math.max(0, Math.min(vw-1, Math.round(x1*scaleX)));
          const sw=Math.max(1, Math.min(vw-sx, Math.round(roiWidth*scaleX)));
          const tmp=document.createElement('canvas'); tmp.width=vw; tmp.height=vh;
          const tctx=tmp.getContext('2d',{willReadFrequently:true}); tctx.drawImage(video,0,0,vw,vh);
          const frame=tctx.getImageData(sx,0,sw,vh);

          if(prev && prev.width===sw && prev.height===vh){
            const sensV=Number(sens.value);
            const thr=20+Math.round((100-sensV)*1.2);
            const pct=0.04+(100-sensV)*0.0006;
            let diff=0,total=0;
            for(let i=0;i<frame.data.length;i+=16){
              const d = Math.abs(frame.data[i]-prev.data[i]) + Math.abs(frame.data[i+1]-prev.data[i+1]) + Math.abs(frame.data[i+2]-prev.data[i+2]);
              if(d>thr) diff++; total++;
            }
            if((diff/Math.max(1,total))>pct) trigger();
          }
          prev=frame;
        }
        requestAnimationFrame(loop);
      }

      function drawOverlayTimes(w,h,rows){
        if(!rows.length) return;
        const nowSync = Date.now() + serverOffsetMS;
        const sorted = rows.slice().sort((a,b)=> (a.startMS||0)-(b.startMS||0)).reverse();

        const baseSize = Math.max(18, Math.floor(h*0.026));
        const gap = Math.max(5, Math.floor(h*0.011));
        const leftPad = Math.floor(w*0.06);
        const rightPad= Math.floor(w*0.06);
        const topPad = Math.floor(h*0.14);

        const maxRows = Math.min(sorted.length, Math.floor((h-topPad)/(baseSize+gap)));

        octx.font = `900 ${baseSize}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
        octx.textBaseline = 'top';
        octx.fillStyle = '#ffffff';
        octx.strokeStyle = 'rgba(0,0,0,.55)';
        octx.lineWidth = Math.max(2, Math.floor(baseSize*0.14));

        let y = topPad;
        for(let i=0;i<maxRows;i++){
          const r = sorted[i];
          const elapsed = nowSync - (r.startMS||nowSync);
          const tText = fmt(elapsed);
          const nText = r.name || '—';

          octx.textAlign='left';
          octx.strokeText(tText, leftPad, y);
          octx.fillText  (tText, leftPad, y);

          octx.textAlign='right';
          octx.strokeText(nText, w - rightPad, y);
          octx.fillText  (nText, w - rightPad, y);

          y += baseSize + gap;
        }
      }

      function renderList(run){
        const nowSync = Date.now() + serverOffsetMS;
        const list = $('runningList');
        if(!run.length){ list.innerHTML='—'; return; }
        list.innerHTML = run.slice().sort((a,b)=> (a.startMS||0)-(b.startMS||0)).reverse()
          .map(p=>`
            <div class="runner" data-start="${p.startMS || nowSync}">
              <div class="badge">#${p.order}</div>
              <div class="rname">${p.name}</div>
              <div class="rtime">${fmt(nowSync-(p.startMS||nowSync))}</div>
            </div>
          `).join('');
      }

      // Ticker “En curso”
      (function liveListTicker(){
        function tick(){
          const nowSync = Date.now() + serverOffsetMS;
          document.querySelectorAll('#runningList .runner').forEach(el=>{
            const start = Number(el.dataset.start || 0);
            const tEl = el.querySelector('.rtime');
            if (start && tEl) tEl.textContent = fmt(nowSync - start);
          });
          requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      })();

    }catch(e){
      window.__firebaseReady=false; fbState.textContent='ERROR'; fbState.className='err';
      alert('Firebase error: '+(e.message||e));
    }
  </script>
</body>
</html>
