<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono — Cámara (Smoke)</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .ok{color:#0a7a0a;font-weight:600}
    .err{color:#b00020;font-weight:600}
    .debug{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#f6f6f6;border-radius:8px;padding:8px}
  </style>
</head>
<body class="wrap">
  <header class="top">
    <h1 id="title">Modo (Smoke)</h1>
    <p class="tag" id="tag">Conectando…</p>
  </header>

  <main class="grid one">
    <section class="card warn" id="noCodeBox" style="display:none">
      <b>Falta el código de evento.</b> Vuelve a <a href="index.html">Inicio</a> y entra por “Unirse”.
    </section>

    <section class="card">
      <div class="row">
        <button id="btnStart" class="btn primary">Escribir INICIO</button>
        <button id="btnStop" class="btn">Escribir FIN</button>
        <a id="btnResult" class="btn" href="#">Ver resultado</a>
      </div>
    </section>

    <section class="card">
      <h2>Estado</h2>
      <div>Firebase: <span id="fbState">—</span></div>
      <div>Evento: <span id="evState">—</span></div>
      <div>Última acción: <span id="lastAction">—</span></div>
    </section>

    <section class="card">
      <h2>Depuración</h2>
      <div class="debug" id="lastError">—</div>
    </section>
  </main>

  <footer><a class="linklike" href="join.html">⇦ Cambiar código</a></footer>

  <!-- ÚNICO script -->
  <script type="module">
    // Estado por defecto
    window.__firebaseReady = false;
    window.__firebaseError = null;

    // Parámetros
    const getParam = (k)=> new URL(location.href).searchParams.get(k);
    const code=(getParam('code')||'').toUpperCase();

    // UI
    const fbStateEl=document.getElementById('fbState');
    const evStateEl=document.getElementById('evState');
    const tag=document.getElementById('tag');
    const lastErrorEl=document.getElementById('lastError');
    const lastAction=document.getElementById('lastAction');
    const btnStart=document.getElementById('btnStart');
    const btnStop=document.getElementById('btnStop');
    const btnResult=document.getElementById('btnResult');

    function paintFirebase(){
      fbStateEl.textContent = window.__firebaseReady ? "OK" : "ERROR";
      fbStateEl.className   = window.__firebaseReady ? "ok" : "err";
      if(!window.__firebaseReady){
        const msg  = window.__firebaseError && (window.__firebaseError.message || String(window.__firebaseError)) || 'sin detalle';
        lastErrorEl.textContent = `Init Firebase: ${msg}`;
      } else {
        lastErrorEl.textContent = '—';
      }
    }

    // Código de evento
    if(!code){ document.getElementById('noCodeBox').style.display=''; evStateEl.textContent='SIN CÓDIGO'; evStateEl.className='err'; }
    else { evStateEl.textContent=code; evStateEl.className='ok'; tag.textContent=`Evento ${code}`; }

    // Init Firebase (CDN)
    try{
      const { initializeApp, getApp, getApps } = await import("https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js");
      const { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } =
        await import("https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js");

      const firebaseConfig = {
        apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
        authDomain: "mi-crono-time-888b7.firebaseapp.com",
        projectId: "mi-crono-time-888b7",
        storageBucket: "mi-crono-time-888b7.appspot.com",
        messagingSenderId: "379025900327",
        appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
      };

      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const db  = getFirestore(app);

      window.__firebaseReady = true; paintFirebase();

      if(code){
        const eventRef = doc(db, "events", code);

        // Crea si no existe
        try{ const s=await getDoc(eventRef);
             if(!s.exists()) await setDoc(eventRef, { code, createdAt: serverTimestamp(), startTS:null, stopTS:null }, { merge:true });
           }catch(e){ lastErrorEl.textContent='Error creando doc: '+(e.message||e); }

        // Suscripción
        onSnapshot(eventRef, (snap)=>{
          const d = snap.data() || {};
          const hasStart=!!d.startTS||!!d.startClientMS, hasStop=!!d.stopTS||!!d.stopClientMS;
          tag.textContent=`Evento ${code} • ${hasStart?'Inicio OK':'Sin inicio'} • ${hasStop?'Fin OK':'Sin fin'}`;
        });

        // Botones
        btnStart.onclick = async ()=>{
          try{ await setDoc(eventRef,{startTS:serverTimestamp(),startClientMS:Date.now(),stopTS:null,stopClientMS:null},{merge:true});
               lastAction.textContent='Inicio escrito'; alert('Inicio escrito'); }
          catch(e){ lastErrorEl.textContent='Error Start: '+(e.message||e); }
        };
        btnStop.onclick = async ()=>{
          try{ await setDoc(eventRef,{stopTS:serverTimestamp(),stopClientMS:Date.now()},{merge:true});
               lastAction.textContent='Fin escrito'; alert('Fin escrito'); }
          catch(e){ lastErrorEl.textContent='Error Stop: '+(e.message||e); }
        };
        btnResult.onclick = (e)=>{ e.preventDefault(); location.href=`result.html?code=${encodeURIComponent(code)}`; };
      }
    }catch(e){
      window.__firebaseError=e; window.__firebaseReady=false; paintFirebase();
    }

    paintFirebase();
  </script>
</body>
</html>
