<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono — CÁMARA</title>
  <style>
    :root{
      --bg:#10141b; --panel:#161c24; --panel2:#1b2330;
      --text:#eaf0f8; --muted:#b5c0d1; --border:#2a3342;
      --accent:#6eb0ff; --accent-2:#8ec5ff; --ok:#7cffb6; --err:#ff7a8a;
      --danger:#ff6b82;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1300px 800px at 20% -10%, #131a27 0%, transparent 60%),
                  radial-gradient(1200px 900px at 120% 10%, #192134 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:6px 0 14px}
    .left{display:flex;align-items:center;gap:10px}
    .title{font-weight:900;letter-spacing:.06em;text-transform:uppercase}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:var(--panel2);border:1px solid var(--border);font-weight:800}
    .muted{color:var(--muted)}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .col{flex:1 1 340px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 16px;border-radius:12px;border:1px solid var(--border);
      background:#0f141c;color:var(--text);cursor:pointer;text-decoration:none;
      text-transform:uppercase;font-weight:900;letter-spacing:.03em;min-height:44px;
      transition:background .15s,border-color .15s,transform .05s;
    }
    .btn:hover{background:#141a24}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#091320}
    .btn.primary:hover{background:var(--accent-2);border-color:var(--accent-2)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#210a12}

    /* Cámara */
    .camWrap{position:relative;border-radius:14px;overflow:hidden;border:1px solid var(--border);background:#000}
    video{display:block;width:100%;height:auto;background:#000}
    .overlay{
      position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;
    }
    /* Franjas rojas verticales (zona de detección) */
    .gate{
      position:absolute;top:0;bottom:0;width:10%;
      border-left:3px solid rgba(255,0,0,.85);border-right:3px solid rgba(255,0,0,.85);
      left:45%;
    }
    .flash{
      position:absolute;inset:0;background:rgba(255,255,255,.18);opacity:0;transition:opacity .2s;
    }
    .flash.on{opacity:1}
    .status{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .status .s{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--panel2);font-weight:800}
    .status .ok{color:var(--ok)} .status .err{color:var(--err)}
    .list h3{margin:0 0 8px 0;text-transform:uppercase;letter-spacing:.04em}
    .item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--panel2);margin-bottom:8px}
    .name{font-weight:900;text-transform:uppercase;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:55%}
    .time{font-weight:900;letter-spacing:.3px}
    .hint{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="left">
        <h1 class="title">CÁMARA</h1>
        <span class="pill" id="modePill">—</span>
      </div>
      <div class="row">
        <button id="btnCam" class="btn">ACTIVAR CÁMARA</button>
        <a id="btnRes" class="btn" href="#">VER RESULTADOS</a>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="card">
          <div class="status">
            <span class="s">Evento: <b id="evCode">—</b></span>
            <span class="s">Estado: <b id="conn">Conectando…</b></span>
            <span class="s">Última acción: <b id="last">—</b></span>
          </div>

          <div class="camWrap">
            <video id="video" playsinline muted></video>
            <div class="overlay">
              <div class="gate" aria-hidden="true"></div>
              <div class="flash" id="flash" aria-hidden="true"></div>
            </div>
          </div>

          <p class="hint" style="margin-top:8px">
            Coloca al corredor para que cruce entre las franjas rojas. El cronómetro se
            <b id="modeExplain">iniciará</b> automáticamente.
          </p>
        </div>
      </div>

      <div class="col">
        <div class="card list">
          <h3>En curso</h3>
          <div id="inProgress"></div>
        </div>

        <div class="card list" style="margin-top:12px">
          <h3>Finalizados</h3>
          <div id="finished"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ================= Utils =================
    const $ = (id)=>document.getElementById(id);
    const two = n => String(n).padStart(2,'0');
    const three = n => String(n).padStart(3,'0');
    function fmt(ms){ ms = Math.max(0, Math.floor(ms||0));
      const m = Math.floor(ms/60000), s = Math.floor((ms%60000)/1000), ms3 = ms%1000;
      return `${two(m)}:${two(s)}.${three(ms3)}`;
    }
    const qp = new URL(location.href).searchParams;
    const CODE = (qp.get('code')||'').toUpperCase();
    const MODE = (qp.get('mode')||'start'); // 'start' | 'finish'
    $('evCode').textContent = CODE || '—';
    $('modePill').textContent = MODE === 'start' ? 'MODO SALIDA' : 'MODO META';
    $('modeExplain').textContent = MODE === 'start' ? 'iniciará' : 'detendrá';

    // Cooldowns (mantener como teníamos)
    const COOLDOWN_START_MS  = 2000; // SALIDA: 2 s
    const COOLDOWN_FINISH_MS = 900;  // META: 0.9 s

    // ============== Firebase (CDN, módulos ES) ==============
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore, doc, collection, query, orderBy, onSnapshot, getDocs, updateDoc,
      serverTimestamp, writeBatch, where, getDoc
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ============== Navegación ==============
    $('btnRes').href = `result.html?code=${encodeURIComponent(CODE)}`;

    // ============== Render helpers ==============
    function tsMs(ts){ return ts ? (ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6)) : null; }

    function renderLists(rows){
      // Filtramos
      const inProg = rows.filter(r => r.startMS!=null && r.stopMS==null)
                         .sort((a,b)=> a.order - b.order);
      const done   = rows.filter(r => r.startMS!=null && r.stopMS!=null)
                         .sort((a,b)=> a.stopMS - b.stopMS);

      // EN CURSO (con tiempo en vivo — AQUÍ el cambio clave data-live-start)
      const inHTML = inProg.map(r=>{
        const start = r.startMS;
        return `
          <div class="item" data-id="${r.id}">
            <div class="name">${r.name}</div>
            <div class="time" data-live-start="${start}">${fmt(Date.now() - start)}</div>
          </div>`;
      }).join('') || `<div class="muted">—</div>`;
      $('inProgress').innerHTML = inHTML;

      // FINALIZADOS (sin live, congelado)
      const finHTML = done.map((r)=>{
        const dur = r.stopMS - r.startMS;
        return `
          <div class="item" data-id="${r.id}">
            <div class="name">${r.name}</div>
            <div class="time">${fmt(dur)}</div>
          </div>`;
      }).join('') || `<div class="muted">—</div>`;
      $('finished').innerHTML = finHTML;
    }

    // ====== Live Ticker para "EN CURSO" (no tocamos nada más) ======
    let _rafId;
    function _tick(){
      const now = Date.now();
      document.querySelectorAll('[data-live-start]').forEach(el=>{
        const start = Number(el.dataset.liveStart || 0);
        if (start > 0) el.textContent = fmt(now - start);
      });
      _rafId = requestAnimationFrame(_tick);
    }
    cancelAnimationFrame(_rafId);
    _rafId = requestAnimationFrame(_tick);

    // ============== Suscripción a participantes ==============
    let unsub = null;
    async function subscribe(){
      if(!CODE){ $('conn').textContent = 'Sin código'; return; }
      const evRef = doc(db,'events',CODE);
      const partsCol = collection(evRef,'participants');
      const q = query(partsCol, orderBy('order','asc'));
      unsub = onSnapshot(q, (snap)=>{
        $('conn').textContent = 'Conectado';
        const rows = snap.docs.map(d=>{
          const x=d.data();
          return {
            id:d.id,
            name:(x.name||'').toUpperCase(),
            order:x.order||0,
            startMS: tsMs(x.startTS),
            stopMS:  tsMs(x.stopTS)
          };
        });
        renderLists(rows);
      }, (err)=>{
        $('conn').textContent = 'ERROR';
        console.error(err);
      });
    }

    // ============== Lógica de cámara y detección ==============
    const video = $('video');
    const flash = $('flash');
    let stream = null;
    let lastTrigger = 0;

    async function startCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:'environment' }, audio:false
        });
        video.srcObject = stream;
        await video.play();
      }catch(e){
        alert('No se pudo abrir la cámara. Revisa permisos en Safari/Chrome.');
        console.error(e);
      }
    }
    $('btnCam').onclick = ()=> startCamera();

    // Detección simple por diferencia de frames en franja central (gate)
    const cnv = document.createElement('canvas');
    const ctx = cnv.getContext('2d', { willReadFrequently:true });
    let prev = null;

    function flashOnce(){
      flash.classList.add('on');
      setTimeout(()=>flash.classList.remove('on'), 120);
    }

    async function tickDetect(){
      if (video.readyState >= 2){
        const w = video.videoWidth, h = video.videoHeight;
        if (w && h){
          cnv.width = w; cnv.height = h;
          ctx.drawImage(video,0,0,w,h);
          const img = ctx.getImageData(0,0,w,h).data;

          // zona de gate (45%..55%) igual que visual
          const x1 = Math.floor(w*0.45), x2 = Math.floor(w*0.55);
          const y1 = 0, y2 = h;

          let diff = 0, total = 0;
          if (prev && prev.length === img.length){
            for (let y=y1; y<y2; y+=3){
              for (let x=x1; x<x2; x+=3){
                const i = (y*w + x)*4;
                const d = Math.abs(img[i]-prev[i]) + Math.abs(img[i+1]-prev[i+1]) + Math.abs(img[i+2]-prev[i+2]);
                diff += d; total++;
              }
            }
          }
          prev = new Uint8ClampedArray(img);

          const motion = total ? (diff/total) : 0;
          const now = Date.now();

          // Umbral heurístico; si hay movimiento y pasó cooldown, dispara
          if (motion > 10){
            const cd = (MODE==='start') ? COOLDOWN_START_MS : COOLDOWN_FINISH_MS;
            if (now - lastTrigger > cd){
              lastTrigger = now;
              flashOnce();
              if (MODE==='start') await markStart();
              else await markFinish();
            }
          }
        }
      }
      requestAnimationFrame(tickDetect);
    }
    requestAnimationFrame(tickDetect);

    // ============== Acciones Firestore ==============
    // Buscar siguiente participante pendiente de salida (startTS==null)
    async function markStart(){
      try{
        const evRef = doc(db,'events',CODE);
        const partsCol = collection(evRef,'participants');

        // siguiente sin start
        const pendingSnap = await getDocs(query(partsCol, where('startTS','==',null), orderBy('order','asc')));
        if (pendingSnap.empty){ $('last').textContent='No hay más participantes'; return; }

        const first = pendingSnap.docs[0];
        await updateDoc(first.ref, { startTS: serverTimestamp() });
        $('last').textContent = `Inicio: ${first.data().name||first.id}`;
      }catch(e){
        console.error(e);
        $('last').textContent = 'ERROR inicio';
      }
    }

    // Parar el primero que esté en curso (startTS!=null && stopTS==null) por orden de salida
    async function markFinish(){
      try{
        const evRef = doc(db,'events',CODE);
        const partsCol = collection(evRef,'participants');

        // primero en curso
        const runningSnap = await getDocs(query(partsCol,
          where('startTS','!=',null), where('stopTS','==',null), orderBy('order','asc')));

        if (runningSnap.empty){ $('last').textContent='Nadie en curso'; return; }

        const first = runningSnap.docs[0];
        await updateDoc(first.ref, { stopTS: serverTimestamp() });
        $('last').textContent = `Fin: ${first.data().name||first.id}`;
      }catch(e){
        console.error(e);
        $('last').textContent = 'ERROR fin';
      }
    }

    // ============== Iniciar ==============
    subscribe();
  </script>
</body>
</html>
