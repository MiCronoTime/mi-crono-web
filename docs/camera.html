<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono Web — Modo</title>
  <style>
    :root{
      --bg:#10141b; --panel:#161c24; --panel2:#1b2330; --text:#eaf0f8;
      --muted:#b5c0d1; --border:#2a3342; --accent:#6eb0ff; --accent2:#8ec5ff;
      --ok:#7cffb6; --err:#ff7a8a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0f141c;color:var(--text)}
    .wrap{max-width:1000px;margin:0 auto;padding:14px}
    h1,h2{margin:0 0 10px 0}
    .title{font-weight:900;letter-spacing:.06em;text-transform:uppercase;text-align:center;margin-top:6px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 16px;border-radius:12px;border:1px solid var(--border);
      background:#0f141c;color:var(--text);cursor:pointer;text-decoration:none;
      text-transform:uppercase;font-weight:900;letter-spacing:.03em;min-height:44px;
    }
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#0b1725}
    .btn.dark{background:#121823}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin:12px 0}
    .tag{display:inline-block;background:var(--panel2);border:1px solid var(--border);border-radius:999px;padding:6px 10px;margin-right:6px}
    .video-wrap{position:relative;background:black;border-radius:12px;border:1px solid #000;overflow:hidden}
    video{display:block;width:100%;height:auto;background:#000}
    canvas.overlay{position:absolute;inset:0;pointer-events:none}
    .slider{width:100%}
    .liveTimers{position:absolute;right:10px;top:10px;font-weight:900;text-shadow:0 2px 0 rgba(0,0,0,.6);text-align:right}
    .liveTimers .rowT{font-size:36px;line-height:1.1}
    .liveTimers .name{display:inline-block;margin-left:10px}
    @media (max-width:430px){ .liveTimers .rowT{font-size:26px} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">MODO <span id="modeTitle">—</span></h1>
    <div class="muted" style="text-align:center">Evento <b id="evCode">—</b> • <span id="conn">Conectando…</span></div>

    <!-- Controles -->
    <div class="card">
      <div class="row">
        <button id="btnCam" class="btn primary">Activar cámara</button>
        <a id="btnRes" class="btn dark" href="#">Ver resultado</a>
      </div>
      <div class="muted" style="margin-top:8px">iOS: Safari + HTTPS + permitir Cámara.</div>

      <!-- Cámara -->
      <div class="video-wrap" style="margin-top:12px" id="vw">
        <video id="video" playsinline muted></video>
        <canvas id="overlay" class="overlay"></canvas>
        <!-- Cronos en vivo por participante (derecha) -->
        <div class="liveTimers" id="liveTimers"></div>
      </div>

      <div class="muted" style="margin-top:8px">
        <span class="tag"><b>Listo</b></span>
        <span class="tag">Siguiente: <b id="nextName">—</b></span>
      </div>
    </div>

    <!-- Sensibilidad -->
    <div class="card">
      <div style="font-weight:800">Sensibilidad detector (franja roja)</div>
      <input type="range" id="sens" class="slider" min="1" max="100" value="60"/>
      <div class="muted" style="margin-top:6px">Más a la derecha = más sensible.</div>
    </div>

    <!-- EN CURSO (se ocultará por JS) -->
    <section class="card" id="inCourseCard">
      <h2>EN CURSO</h2>
      <div id="inCourseList" class="muted">—</div>
    </section>

    <!-- Estado -->
    <section class="card">
      <h2>ESTADO</h2>
      <div>Firebase: <b id="fb">—</b></div>
      <div>Evento: <b id="ev">—</b></div>
      <div>Última acción: <b id="last">—</b></div>
      <div class="muted" style="margin-top:8px"><a href="index.html" style="color:var(--accent)">⇦ Volver a inicio</a></div>
    </section>
  </div>

  <!-- Firebase (CDN) + lógica -->
  <script type="module">
    // ===== URL =====
    const qp = new URL(location.href).searchParams;
    const CODE = (qp.get('code')||'').toUpperCase();
    const MODE = (qp.get('mode')||'start'); // 'start' | 'finish'
    document.getElementById('evCode').textContent = CODE || '—';
    document.getElementById('modeTitle').textContent = MODE==='start' ? 'SALIDA' : 'META';
    document.getElementById('btnRes').href = `result.html?code=${encodeURIComponent(CODE)}`;

    // ===== Constantes =====
    const COOLDOWN_START_MS  = 2000; // SALIDA: 2 s
    const COOLDOWN_FINISH_MS = 900;  // META: 0.9 s

    // ===== Firebase =====
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy,
      onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
      authDomain: "mi-crono-time-888b7.firebaseapp.com",
      projectId: "mi-crono-time-888b7",
      storageBucket: "mi-crono-time-888b7.appspot.com",
      messagingSenderId: "379025900327",
      appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== Estado UI =====
    const $ = id => document.getElementById(id);
    const last = t => ($('last').textContent = t);
    $('fb').textContent = 'OK';
    $('ev').textContent = CODE || '—';

    // ===== Data de participantes (suscripción) =====
    let participants = []; // {id,name,order,startTS,stopTS}
    let running = [];      // ids con start y sin stop (orden de salida)
    const evRef  = doc(db,'events',CODE);
    const partsQ = query(collection(evRef,'participants'), orderBy('order','asc'));

    onSnapshot(partsQ, snap=>{
      participants = snap.docs.map(d=> ({id:d.id, ...d.data()}));
      running = participants.filter(p=>p.startTS && !p.stopTS).sort((a,b)=>a.order-b.order).map(p=>p.id);
      drawLive();
      updateNextBadge();
      $('conn').textContent = 'Conectado';
    }, err => {
      $('conn').textContent = 'ERROR';
      last('Error: ' + err.message);
    });

    function updateNextBadge(){
      const next = participants.find(p=>!p.startTS);
      $('nextName').textContent = next ? (next.name||'—') : '—';
    }

    // ===== Cámara y detección simple de “corte” en franja roja =====
    const video = $('video'); const overlay=$('overlay'); const ctx=overlay.getContext('2d');
    let stream=null; let lastTrigger=0;

    async function startCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
        video.srcObject = stream; await video.play();
        resizeCanvas(); requestAnimationFrame(loop);
        $('btnCam').textContent = 'Cámara activada';
      }catch(e){
        alert('No se pudo abrir la cámara: ' + (e.message||e));
      }
    }
    function resizeCanvas(){
      const r = video.getBoundingClientRect();
      overlay.width = r.width * devicePixelRatio;
      overlay.height= r.height* devicePixelRatio;
    }
    window.addEventListener('resize', resizeCanvas);

    function loop(){
      drawOverlay();
      detectBand();
      requestAnimationFrame(loop);
    }

    function drawOverlay(){
      const w=overlay.width, h=overlay.height;
      ctx.clearRect(0,0,w,h);
      // dos líneas rojas
      const x1 = w*0.49, x2 = w*0.51;
      ctx.strokeStyle='rgba(255,0,0,.75)'; ctx.lineWidth=6;
      ctx.beginPath(); ctx.moveTo(x1,0); ctx.lineTo(x1,h); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(x2,0); ctx.lineTo(x2,h); ctx.stroke();
    }

    function detectBand(){
      // Detector mínimo: usa “cooldown” y slider de sensibilidad como umbral de movimiento de vídeo (simple)
      if(!video.videoWidth) return;
      const now = performance.now();
      const cooldown = (MODE==='start') ? COOLDOWN_START_MS : COOLDOWN_FINISH_MS;
      if (now - lastTrigger < cooldown) return; // antirrebotes

      // aproximación: cada N frames estimamos cambio por luminancia en la zona central (barra roja)
      // si el cambio supera el umbral del slider => disparo
      // (simple/ligero para no gastar batería)
      if (!detectBand._prev) detectBand._prev = 0;
      if (!detectBand._acc) detectBand._acc = 0;
      detectBand._acc++;
      if (detectBand._acc % 6) return; // bajar frecuencia

      const w=overlay.width, h=overlay.height;
      const cx1=Math.floor(w*0.485), cx2=Math.floor(w*0.515), cw=cx2-cx1, ch=h;
      const tmp = document.createElement('canvas'); tmp.width=cw; tmp.height=ch;
      const tctx=tmp.getContext('2d');
      tctx.drawImage(video, (video.videoWidth - w/devicePixelRatio)/2, 0, w/devicePixelRatio, video.videoHeight, 0,0,cw,ch);
      const img = tctx.getImageData(0,0,cw,ch).data;
      let sum=0; for(let i=0;i<img.length;i+=4){ // media de luminancia
        sum += (0.299*img[i] + 0.587*img[i+1] + 0.114*img[i+2]);
      }
      const avg = sum / (img.length/4);
      const delta = Math.abs(avg - detectBand._prev);
      detectBand._prev = avg;

      const sens = Number(document.getElementById('sens').value); // 1..100
      const threshold = 12 + (100 - sens)*0.9; // más sensibilidad => umbral más bajo

      if (delta > threshold){
        triggerAction();
        lastTrigger = now;
      }
    }

    async function triggerAction(){
      try{
        if (MODE==='start'){
          // toma el siguiente sin salida
          const next = participants.find(p=>!p.startTS);
          if(!next) return;
          await updateDoc(doc(db,'events',CODE,'participants',next.id), { startTS: serverTimestamp() });
          last(`Inicio: ${next.name}`);
        }else{
          // meta: para el primero en curso (orden de salida)
          const firstRunning = participants.filter(p=>p.startTS && !p.stopTS).sort((a,b)=>a.order-b.order)[0];
          if(!firstRunning) return;
          await updateDoc(doc(db,'events',CODE,'participants',firstRunning.id), { stopTS: serverTimestamp() });
          last(`Fin: ${firstRunning.name}`);
        }
      }catch(e){
        last('Error acción: ' + (e.message||e));
      }
    }

    // ===== Cronos en vivo a la derecha =====
    function fmt(ms){ms=Math.max(0,Math.floor(ms||0));const m=Math.floor(ms/60000),s=Math.floor((ms%60000)/1000),ms3=ms%1000;return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(ms3).padStart(3,'0')}`;}
    function tsMs(ts){return ts? (ts.seconds*1000+Math.floor((ts.nanoseconds||0)/1e6)) : null;}

    function drawLive(){
      const live = participants
        .filter(p=>p.startTS && !p.stopTS)
        .sort((a,b)=>a.order-b.order);

      const html = live.map(p=>{
        const mNow = Date.now();
        const start = tsMs(p.startTS);
        const ms = mNow - start;
        return `<div class="rowT">${fmt(ms)} <span class="name">— ${ (p.name||'').toUpperCase() }</span></div>`;
      }).join('');
      $('liveTimers').innerHTML = html || '';
    }
    setInterval(drawLive, 90);

    // ===== Botones =====
    $('btnCam').onclick = startCamera;
  </script>

  <!-- BLOQUE NUEVO: ocultar la tarjeta “EN CURSO” -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.card h2').forEach(h => {
        if ((h.textContent || '').trim().toUpperCase() === 'EN CURSO') {
          const card = h.closest('.card');
          if (card) card.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
