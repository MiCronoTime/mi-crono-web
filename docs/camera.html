<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mi Crono — CÁMARA</title>
<style>
  :root{
    --bg:#10141b; --panel:#161c24; --panel2:#1b2330;
    --text:#eaf0f8; --muted:#b5c0d1; --border:#2a3342; --accent:#6eb0ff;
    --ok:#79ffa8; --bad:#ff7b8c;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0f141c;color:#eaf0f8}
  .bar{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#0e131b;border-bottom:1px solid #2a3342}
  .bar .title{font-weight:900;letter-spacing:.06em;text-transform:uppercase}
  .bar .right{display:flex;gap:10px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid #2a3342;background:#111827;color:#eaf0f8;text-decoration:none;cursor:pointer;text-transform:uppercase;font-weight:900}
  .btn.primary{background:var(--accent);color:#0a1525;border-color:var(--accent)}
  .wrap{padding:12px}
  .camera{position:relative;background:#000;border:1px solid #2a3342;border-radius:12px;overflow:hidden;aspect-ratio:9/16;max-height:70vh}
  video{width:100%;height:100%;object-fit:cover}
  .stripes{position:absolute;inset:0;pointer-events:none}
  .stripe{position:absolute;top:0;bottom:0;width:4px;background:#ff3948;opacity:.9}
  .stripe.left{left:35%}.stripe.right{right:35%}
  .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:20px;background:rgba(0,0,0,.0);pointer-events:none}
  .status{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #2a3342;background:#161c24}
  .list{margin-top:12px;display:flex;flex-direction:column;gap:8px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px;background:#161c24;border:1px solid #2a3342;border-radius:10px;padding:10px}
  .name{font-weight:900;text-transform:uppercase;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:52%}
  .time{font-weight:900;letter-spacing:.4px}
  .delta{min-width:72px;text-align:right;font-weight:900}
  .delta.good{color:var(--ok)} .delta.bad{color:var(--bad)}
  .delta.hidden{visibility:hidden}
</style>
</head>
<body>
  <div class="bar">
    <div class="title">CÁMARA</div>
    <div class="right">
      <a href="index.html" class="btn">INICIO</a>
      <button id="btnCam" class="btn">ACTIVAR CÁMARA</button>
      <a id="btnRes" class="btn" href="#">VER RESULTADO</a>
    </div>
  </div>

  <div class="wrap">
    <div class="status">
      <div class="pill">Evento: <b id="ev">—</b></div>
      <div class="pill">Modo: <b id="mode">—</b></div>
      <div class="pill" id="conn">Conectando…</div>
    </div>

    <div class="camera" id="camBox">
      <video id="video" autoplay playsinline muted></video>
      <div class="stripes">
        <div class="stripe left"></div>
        <div class="stripe right"></div>
      </div>
      <div class="overlay" id="ovl"></div>
    </div>

    <div class="list" id="liveList">
      <!-- filas de participantes activos -->
    </div>
  </div>

<script type="module">
  const $=(id)=>document.getElementById(id);
  const qs=new URL(location.href).searchParams;
  const code=(qs.get('code')||'').toUpperCase();
  const mode=(qs.get('mode')||'start').toLowerCase(); // start | split | finish

  $('ev').textContent=code||'—';
  $('mode').textContent=mode==='start'?'SALIDA':(mode==='split'?'SPLIT':'META');
  $('btnRes').href = `result.html?code=${encodeURIComponent(code)}`;

  // Cooldowns y UI
  const COOLDOWN_START_MS  = 2000;
  const COOLDOWN_SPLIT_MS  = 900;
  const COOLDOWN_FINISH_MS = 900;
  const DIFF_VISIBLE_MS    = 4000;

  // Firebase
  import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import {
    getFirestore, doc, collection, query, where, orderBy, getDocs, getDoc,
    onSnapshot, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCt52Q6LEJ0fl0iKUIE6OKXlbp42fzOgBU",
    authDomain: "mi-crono-time-888b7.firebaseapp.com",
    projectId: "mi-crono-time-888b7",
    storageBucket: "mi-crono-time-888b7.appspot.com",
    messagingSenderId: "379025900327",
    appId: "1:379025900327:web:6f10f46ee086ca61f8df02"
  };
  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // Cámara (simplificado: se muestra preview; la detección real la tienes ya – aquí solo
  // disparamos al pulsar en la zona entre franjas o por movimiento si ya lo tenías).
  let stream=null, lastTrigger=0;

  async function startCamera(){
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
      $('video').srcObject = stream;
    }catch(e){
      alert('No se pudo abrir la cámara: ' + (e.message||e));
    }
  }
  $('btnCam').onclick=()=>startCamera();

  // Utilidades
  const two=(n)=>String(n).padStart(2,'0');
  const three=(n)=>String(n).padStart(3,'0');
  const fmt=(ms)=>{ ms=Math.max(0,Math.floor(ms||0));
    const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), ms3=ms%1000;
    return `${two(m)}:${two(s)}.${three(ms3)}`; };
  const tsMs=(ts)=> ts ? (ts.seconds*1000 + Math.floor((ts.nanoseconds||0)/1e6)) : null;

  // UI lista en vivo
  const liveMap = new Map(); // pid -> {row, deltaEl}
  function ensureRow(p){
    if(liveMap.has(p.id)) return liveMap.get(p.id);
    const row=document.createElement('div'); row.className='row';
    const name=document.createElement('div'); name.className='name'; name.textContent=p.name;
    const time=document.createElement('div'); time.className='time'; time.id=`t_${p.id}`; time.textContent='00:00.000';
    const delta=document.createElement('div'); delta.className='delta hidden'; delta.id=`d_${p.id}`; delta.textContent='';
    row.appendChild(name); row.appendChild(time); row.appendChild(delta);
    $('liveList').appendChild(row);
    const ent={row, timeEl:time, deltaEl:delta};
    liveMap.set(p.id, ent);
    return ent;
  }

  // Suscripción a participantes del evento para ver cronos en vivo (tanto en start/split/finish)
  let unsub=null;
  async function subscribe(){
    if(!code) return;
    const evRef = doc(db,'events',code);
    const partsCol = collection(evRef,'participants');
    const q = query(partsCol, orderBy('order','asc'));
    unsub = onSnapshot(q, (snap)=>{
      $('conn').textContent = 'Conectado';
      const parts = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      // Active = startTS != null && stopTS == null
      const active = parts.filter(x=>x.startTS && !x.stopTS);
      $('liveList').innerHTML='';
      liveMap.clear();
      active.forEach(p=>{
        const ent = ensureRow(p);
        // pintar tiempo en vivo en cliente (desde startTS a now, salvo si stopTS)
        const startMS = tsMs(p.startTS);
        const stopMS  = p.stopTS ? tsMs(p.stopTS) : null;
        const tick = ()=>{
          const now = stopMS ?? Date.now();
          const ms = (startMS!=null) ? (now - startMS) : 0;
          ent.timeEl.textContent = fmt(ms);
          if(!stopMS) requestAnimationFrame(tick);
        };
        tick();
      });
    }, err=>{
      $('conn').textContent = 'ERROR';
      console.error(err);
    });
  }
  subscribe();

  // Mejor tiempo de split del evento (mínimo splitDur = splitTS - startTS)
  async function fetchBestSplitMs(){
    const evRef = doc(db,'events',code);
    const partsCol = collection(evRef,'participants');
    const snap = await getDocs(partsCol);
    let best=null;
    snap.forEach(d=>{
      const x=d.data();
      if(x.startTS && x.splitTS){
        const s=tsMs(x.startTS), sp=tsMs(x.splitTS);
        const dur = sp - s;
        if(dur>=0) best = (best==null ? dur : Math.min(best, dur));
      }
    });
    return best; // ms o null
  }

  // Selecciona el participante objetivo según el modo
  async function pickTarget(){
    const evRef = doc(db,'events',code);
    const partsCol = collection(evRef,'participants');
    const snap = await getDocs(query(partsCol, orderBy('order','asc')));
    const arr = snap.docs.map(d=>({ id:d.id, ref:d.ref, ...d.data() }));
    if(mode==='start'){
      // primero sin startTS
      return arr.find(p=>!p.startTS) || null;
    }else if(mode==='split'){
      // primero con startTS y sin splitTS y sin stopTS
      return arr.find(p=>p.startTS && !p.splitTS && !p.stopTS) || null;
    }else{
      // finish: primero con startTS y sin stopTS
      return arr.find(p=>p.startTS && !p.stopTS) || null;
    }
  }

  function inCooldown(){
    const now=Date.now();
    const cd = mode==='start'?COOLDOWN_START_MS: (mode==='split'?COOLDOWN_SPLIT_MS:COOLDOWN_FINISH_MS);
    if(now - lastTrigger < cd) return true;
    lastTrigger = now;
    return false;
  }

  async function triggerAction(){
    if(!code) return;
    if(inCooldown()) return;

    const target = await pickTarget();
    if(!target){ flash('Sin participante objetivo', '#ff9'); return; }

    const now = serverTimestamp();
    const ref = target.ref;

    try{
      if(mode==='start' && !target.startTS){
        await updateDoc(ref, { startTS: now });
        flash('SALIDA ✓', '#9f9');
      }else if(mode==='split' && target.startTS && !target.splitTS && !target.stopTS){
        await updateDoc(ref, { splitTS: now });
        flash('SPLIT ✓', '#9f9');
        showSplitDiff(target.id); // calcula y muestra diferencia durante 4s
      }else if(mode==='finish' && target.startTS && !target.stopTS){
        await updateDoc(ref, { stopTS: now });
        flash('META ✓', '#9f9');
      }else{
        flash('No aplica', '#faa');
      }
    }catch(e){
      console.error(e);
      flash('Error', '#faa');
    }
  }

  // Mostrar overlay breve
  function flash(text, color){
    const el=$('ovl');
    el.textContent=text;
    el.style.color=color||'#fff';
    el.style.background='rgba(0,0,0,.25)';
    setTimeout(()=>{ el.textContent=''; el.style.background='rgba(0,0,0,0)'; }, 600);
  }

  // Diferencial split (verde mejor, rojo peor) durante 4s al lado del crono del participante
  async function showSplitDiff(participantId){
    const evRef = doc(db,'events',code);
    const pSnap = await getDoc(doc(evRef,'participants',participantId));
    if(!pSnap.exists()) return;
    const p = pSnap.data();
    if(!p.startTS || !p.splitTS) return;

    const s=tsMs(p.startTS), sp=tsMs(p.splitTS);
    const my = sp - s;

    const best = await fetchBestSplitMs(); // incluye ya el actual (ok)
    if(best==null){ return; } // primer split: no mostramos delta
    const diff = my - best;

    const ent = liveMap.get(participantId);
    if(!ent) return;
    ent.deltaEl.classList.remove('hidden','good','bad');
    ent.deltaEl.textContent = (diff<=0 ? (diff===0? '+00:00.000' : ('-' + fmt(Math.abs(diff)))) : ('+' + fmt(diff)));
    ent.deltaEl.classList.add(diff<=0 ? 'good' : 'bad');

    setTimeout(()=>{
      ent.deltaEl.classList.add('hidden');
      ent.deltaEl.textContent='';
      ent.deltaEl.classList.remove('good','bad');
    }, DIFF_VISIBLE_MS);
  }

  // Click en la zona entre franjas => trigger
  $('camBox').addEventListener('click', (e)=>{
    const box = $('camBox').getBoundingClientRect();
    const x = (e.clientX - box.left) / box.width;
    if(x>=0.35 && x<=0.65){ triggerAction(); }
  });
</script>
</body>
</html>
