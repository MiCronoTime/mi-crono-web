<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono Web — Cámara</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    video, canvas { width:100%; border-radius:16px; }
    video { min-height: 240px; max-height: 55vh; background:#000; }
    .overlay { position:absolute; top:12px; left:12px; padding:6px 10px; background:#0008; color:#fff; border-radius:8px; }
    .stage { position:relative; }
    .hint { margin-top:8px; font-size: 13px; color:#64748b; }
    .debug { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; }
  </style>
</head>
<body class="wrap">
  <header class="top">
    <h1 id="title">Modo</h1>
    <p class="tag" id="tag">Conectando…</p>
  </header>

  <main class="grid one">
    <section class="card">
      <button id="btnEnableCam" class="btn primary block">Activar cámara</button>
      <div class="hint">Si no ves imagen, ábrelo en Safari con HTTPS y pulsa el botón.</div>

      <div class="stage" style="margin-top:10px;">
        <video id="video" playsinline muted></video>
        <canvas id="canvas" hidden></canvas>
        <div id="overlay" class="overlay" style="display:none;">MOVIMIENTO DETECTADO</div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnForce" class="btn primary">Forzar acción</button>
        <a id="btnResult" class="btn" href="#">Ver resultado</a>
      </div>
      <small class="muted">Coloca el móvil estable apuntando al corredor.</small>
    </section>

    <!-- Panel de Depuración -->
    <section class="card">
      <h2>Depuración</h2>
      <div class="debug" id="debugDoc">Doc: (sin datos)</div>
      <div class="debug" id="lastError">Error: (sin errores)</div>
    </section>
  </main>

  <!-- Utilidades comunes -->
  <script src="js/app.js"></script>
  <!-- Firebase como MÓDULO (OBLIGATORIO) -->
  <script type="module" src="js/firebase.js"></script>

  <!-- Lógica de cámara + Firestore -->
  <script>
    // Helpers de app.js
    const getParam = window.getParam;
    const tsToMillis = window.tsToMillis;

    // Helpers expuestos por firebase.js (cargado como módulo)
    const getEventDocRef  = window.getEventDocRef;
    const getDoc          = window.getDoc;
    const setDoc          = window.setDoc;
    const updateDoc       = window.updateDoc;
    const onSnapshot      = window.onSnapshot;
    const serverTimestamp = window.serverTimestamp;

    // Elementos UI
    const title       = document.getElementById('title');
    const tag         = document.getElementById('tag');
    const btnEnable   = document.getElementById('btnEnableCam');
    const btnForce    = document.getElementById('btnForce');
    const btnResult   = document.getElementById('btnResult');
    const overlay     = document.getElementById('overlay');
    const video       = document.getElementById('video');
    const canvas      = document.getElementById('canvas');
    const ctx         = canvas.getContext('2d', {willReadFrequently:true});
    const debugDocEl  = document.getElementById('debugDoc');
    const lastErrorEl = document.getElementById('lastError');

    // Parámetros de URL
    const code = (getParam('code')||'').toUpperCase();
    const mode = (getParam('mode')||'start'); // start | finish
    title.textContent = `Modo ${mode==='start'?'SALIDA':'META'}`;
    tag.textContent   = `Evento ${code || '—'}`;
    btnResult.href    = `result.html?code=${encodeURIComponent(code)}`;

    // Ref al doc de evento
    const eventRef = getEventDocRef(code);

    // Crea doc si no existe
    (async () => {
      if (!code) { alert('Código de evento vacío.'); return; }
      try {
        const snap = await getDoc(eventRef);
        if(!snap.exists()){
          await setDoc(eventRef, { code, createdAt: serverTimestamp(), startTS: null, stopTS: null }, { merge: true });
        }
      } catch (e) {
        lastErrorEl.textContent = 'Error creando doc: ' + (e && (e.code || e.message || e));
      }
    })();

    // Escucha cambios (estado y depuración)
    onSnapshot(eventRef, (s) => {
      const d = s.data() || {};
      const hasStart = !!d.startTS || !!d.startClientMS;
      const hasStop  = !!d.stopTS  || !!d.stopClientMS;
      tag.textContent = `Evento ${code} • ${hasStart?'Inicio OK':'Sin inicio'} • ${hasStop?'Fin OK':'Sin fin'}`;
      debugDocEl.textContent = 'Doc: ' + JSON.stringify(d, null, 2);
    }, (err) => {
      lastErrorEl.textContent = 'Error snapshot: ' + (err && (err.code || err.message || err));
    });

    // Cámara (iOS-friendly)
    async function startCamera(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert('Este navegador no soporta cámara. Abre la web en Safari (iOS) con HTTPS.');
        return;
      }
      const constraintsList = [
        { video: { facingMode: { ideal: 'environment' }}, audio:false },
        { video: { facingMode: 'environment' }, audio:false },
        { video: true, audio:false }
      ];
      let stream = null, lastErr = null;
      for (const c of constraintsList) {
        try {
          stream = await navigator.mediaDevices.getUserMedia(c);
          if (stream) break;
        } catch (e) { lastErr = e; }
      }
      if(!stream){
        alert('No se pudo abrir la cámara. Revisa Ajustes > Safari > Cámara (Permitir) y usa HTTPS.\nDetalle: ' + (lastErr && (lastErr.name + ': ' + lastErr.message)));
        return;
      }
      try {
        video.setAttribute('playsinline','true');
        video.muted = true;
        video.srcObject = stream;
        await new Promise((res)=>{ if (video.readyState >= 2) return res(); video.onloadedmetadata = () => res(); });
        await video.play();
        btnEnable.style.display = 'none';
      } catch(e){
        alert('La vista previa no pudo iniciarse. Recarga en Safari.\n' + e);
      }
    }
    btnEnable.onclick = startCamera;

    // Detección simple de movimiento
    let prev = null, coolDown = false;
    function detectMovement(){
      if(video.readyState < 2) return;
      const w = video.videoWidth, h = video.videoHeight;
      if(!w || !h) return;
      canvas.width = w; canvas.height = h;
      ctx.drawImage(video, 0, 0, w, h);
      const frame = ctx.getImageData(0,0,w,h);

      let moved = false;
      if(prev){
        const step = 4*8; let diffCount = 0, sample = 0;
        for(let i=0; i<frame.data.length; i+=step){
          const d = Math.abs(frame.data[i]-prev.data[i]) +
                    Math.abs(frame.data[i+1]-prev.data[i+1]) +
                    Math.abs(frame.data[i+2]-prev.data[i+2]);
          if(d>60) diffCount++; sample++;
        }
        const ratio = diffCount / Math.max(1,sample);
        moved = ratio > 0.12;
      }
      prev = frame;

      if(moved && !coolDown){
        overlay.style.display = 'block';
        triggerAction();
        coolDown = true;
        setTimeout(()=>{ overlay.style.display='none'; coolDown=false; }, 1200);
      }
    }
    setInterval(detectMovement, 140);

    // Forzar acción / marcar tiempo
    async function triggerAction(){
      if(!code){ alert('Código de evento vacío.'); return; }
      try{
        const now = Date.now(); // marca cliente por si serverTimestamp tarda
        if(mode==='start'){
          await setDoc(eventRef, {
            startTS: serverTimestamp(),
            startClientMS: now,
            stopTS: null,
            stopClientMS: null
          }, { merge: true });
          alert('Inicio marcado (enviado a Firestore).');
        }else{
          await setDoc(eventRef, {
            stopTS: serverTimestamp(),
            stopClientMS: now
          }, { merge: true });
          alert('Fin marcado (enviado a Firestore).');
        }
        lastErrorEl.textContent = '';
      }catch(e){
        console.error(e);
        lastErrorEl.textContent = 'Error Firestore: ' + (e && (e.code || e.message || e));
        alert('No se pudo escribir en Firestore. Revisa firebaseConfig y Reglas.\n' + (e && (e.code || e.message || e)));
      }
    }
    btnForce.onclick = triggerAction;
  </script>
</body>
</html>
