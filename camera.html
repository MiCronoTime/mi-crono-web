<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mi Crono Web ‚Äî C√°mara (Incrustado)</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    video, canvas { width:100%; border-radius:16px; }
    video { min-height: 240px; max-height: 55vh; background:#000; }
    .overlay { position:absolute; top:12px; left:12px; padding:6px 10px; background:#0008; color:#fff; border-radius:8px; }
    .stage { position:relative; }
    .hint { margin-top:8px; font-size: 13px; color:#64748b; }
    .debug { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; }
    .warn { background:#fffbe6; border:1px solid #fde68a; padding:10px; border-radius:12px; }
    .ok { color:#065f46; }
    .err { color:#b91c1c; }
  </style>

  <!-- üîµ Firebase incrustado (M√ìDULO) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // Config REAL que me diste
    const firebaseConfig = {
      apiKey: "AIzaSyB41JQSLE33w8yLQCNBypNVIh5QRs6suKk",
      authDomain: "mi-crono-web.firebaseapp.com",
      projectId: "mi-crono-web",
      storageBucket: "mi-crono-web.firebasestorage.app",
      messagingSenderId: "803218040641",
      appId: "1:803218040641:web:684f0c7c5622bd12ce63c0",
      measurementId: "G-Z2Q6WQX450"
    };

    // Inicializa y exp√≥n helpers en window para el script de abajo
    try {
      const app = initializeApp(firebaseConfig);
      const db  = getFirestore(app);
      window.getEventDocRef  = (code) => doc(db, "events", (code||"").toUpperCase());
      window.getDoc          = getDoc;
      window.setDoc          = setDoc;
      window.updateDoc       = updateDoc;
      window.onSnapshot      = onSnapshot;
      window.serverTimestamp = serverTimestamp;
      window.__firebaseReady = true;
    } catch (e) {
      window.__firebaseReady = false;
      window.__firebaseError = e;
    }
  </script>
</head>
<body class="wrap">
  <header class="top">
    <h1 id="title">Modo</h1>
    <p class="tag" id="tag">Conectando‚Ä¶</p>
  </header>

  <main class="grid one">
    <section class="card warn" id="noCodeBox" style="display:none">
      <b>Falta el c√≥digo de evento.</b> Vuelve a <a href="index.html">Inicio</a> y entra por ‚ÄúUsar este c√≥digo‚Äù o ‚ÄúUnirse‚Äù.
    </section>

    <section class="card">
      <div class="row">
        <button id="btnEnableCam" class="btn primary">Activar c√°mara</button>
        <button id="btnForce" class="btn">Forzar acci√≥n</button>
        <a id="btnResult" class="btn" href="#">Ver resultado</a>
      </div>
      <div class="hint">iOS: √°brelo en Safari con HTTPS y pulsa ‚ÄúActivar c√°mara‚Äù.</div>

      <div class="stage" style="margin-top:10px;">
        <video id="video" playsinline muted></video>
        <canvas id="canvas" hidden></canvas>
        <div id="overlay" class="overlay" style="display:none;">MOVIMIENTO DETECTADO</div>
      </div>
      <small class="muted">Si no hay imagen es normal hasta dar permisos.</small>
    </section>

    <section class="card">
      <h2>Estado</h2>
      <div>Firebase: <span id="fbState">‚Äî</span></div>
      <div>Evento: <span id="evState">‚Äî</span></div>
      <div>√öltima acci√≥n: <span id="lastAction">‚Äî</span></div>
    </section>

    <section class="card">
      <h2>Depuraci√≥n</h2>
      <div class="debug" id="debugDoc">Doc: (sin datos)</div>
      <div class="debug" id="lastError">Error: (sin errores)</div>
      <div class="row" style="margin-top:8px">
        <button id="testWriteStart" class="btn">Test escribir INICIO</button>
        <button id="testWriteStop" class="btn">Test escribir FIN</button>
        <button id="testRead" class="btn">Test leer DOC</button>
      </div>
    </section>
  </main>

  <!-- L√≥gica (sin app.js) -->
  <script>
    // Utilidades internas
    const getParam = (k)=> new URL(location.href).searchParams.get(k);
    const two = (n)=> String(n).padStart(2,'0');
    const formatDuration = (ms)=>{ const t=Math.max(0, Math.floor(ms||0));
      const m=Math.floor(t/60000), s=Math.floor((t%60000)/1000), cs=Math.floor((t%1000)/10);
      return `${two(m)}:${two(s)}.${two(cs)}`; };
    const tsToMillis = (ts)=> ts ? (typeof ts==='number'?ts:(ts.seconds*1000+Math.floor((ts.nanoseconds||0)/1e6))) : null;

    // UI
    const title = document.getElementById('title');
    const tag = document.getElementById('tag');
    const btnEnable = document.getElementById('btnEnableCam');
    const btnForce = document.getElementById('btnForce');
    const btnResult = document.getElementById('btnResult');
    const debugDocEl = document.getElementById('debugDoc');
    const lastErrorEl = document.getElementById('lastError');
    const fbStateEl = document.getElementById('fbState');
    const evStateEl = document.getElementById('evState');
    const lastAction = document.getElementById('lastAction');

    const video  = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx    = canvas.getContext('2d', { willReadFrequently:true });

    // Par√°metros
    const code = (getParam('code')||'').toUpperCase();
    const mode = (getParam('mode')||'start'); // start | finish
    title.textContent = `Modo ${mode==='start'?'SALIDA':'META'}`;
    tag.textContent   = `Evento ${code || '‚Äî'}`;
    if(!code){
      document.getElementById('noCodeBox').style.display = '';
      evStateEl.textContent = "SIN C√ìDIGO"; evStateEl.className="err";
    } else { evStateEl.textContent = code; evStateEl.className="ok"; }

    // Estado Firebase
    fbStateEl.textContent = window.__firebaseReady ? "OK" : "ERROR";
    fbStateEl.className   = window.__firebaseReady ? "ok" : "err";
    if (!window.__firebaseReady) {
      lastErrorEl.textContent = 'Init Firebase: ' + (window.__firebaseError && (window.__firebaseError.message||window.__firebaseError));
    }

    // Navegar a resultado
    btnResult.addEventListener('click', (e)=> {
      e.preventDefault();
      window.location.href = `result.html?code=${encodeURIComponent(code)}`;
    });

    if (!window.__firebaseReady || !code) {
      // No seguimos si Firebase no est√° listo o no hay c√≥digo
    } else {
      const getEventDocRef  = window.getEventDocRef;
      const getDoc          = window.getDoc;
      const setDoc          = window.setDoc;
      const onSnapshot      = window.onSnapshot;
      const serverTimestamp = window.serverTimestamp;

      const eventRef = getEventDocRef(code);

      (async () => {
        try {
          const snap = await getDoc(eventRef);
          if(!snap.exists()){
            await setDoc(eventRef, { code, createdAt: serverTimestamp(), startTS: null, stopTS: null }, { merge: true });
            lastAction.textContent = "Doc creado";
          } else {
            lastAction.textContent = "Doc existente";
          }
        } catch (e) {
          lastErrorEl.textContent = 'Error creando/leyendo doc: ' + (e && (e.code || e.message || e));
        }
      })();

      onSnapshot(eventRef, (s)=>{
        const d = s.data() || {};
        const hasStart = !!d.startTS || !!d.startClientMS;
        const hasStop  = !!d.stopTS  || !!d.stopClientMS;
        tag.textContent = `Evento ${code || '‚Äî'} ‚Ä¢ ${hasStart?'Inicio OK':'Sin inicio'} ‚Ä¢ ${hasStop?'Fin OK':'Sin fin'}`;
        debugDocEl.textContent = 'Doc: ' + JSON.stringify(d, null, 2);
      }, (err)=>{
        lastErrorEl.textContent = 'Error snapshot: ' + (err && (err.code || err.message || err));
      });

      document.getElementById('testWriteStart').onclick = async () => {
        try {
          await setDoc(eventRef, { startTS: serverTimestamp(), startClientMS: Date.now(), stopTS: null, stopClientMS: null }, { merge: true });
          lastAction.textContent = "Test INICIO escrito"; alert("Test INICIO escrito");
        } catch (e) { lastErrorEl.textContent = 'Error testWriteStart: ' + (e && (e.code || e.message || e)); alert(lastErrorEl.textContent); }
      };
      document.getElementById('testWriteStop').onclick = async () => {
        try {
          await setDoc(eventRef, { stopTS: serverTimestamp(), stopClientMS: Date.now() }, { merge: true });
          lastAction.textContent = "Test FIN escrito"; alert("Test FIN escrito");
        } catch (e) { lastErrorEl.textContent = 'Error testWriteStop: ' + (e && (e.code || e.message || e)); alert(lastErrorEl.textContent); }
      };
      document.getElementById('testRead').onclick = async () => {
        try { const snap = await getDoc(eventRef); alert("Le√≠do:\n" + JSON.stringify(snap.data(), null, 2)); }
        catch (e) { lastErrorEl.textContent = 'Error testRead: ' + (e && (e.code || e.message || e)); alert(lastErrorEl.textContent); }
      };

      // C√°mara iOS-friendly
      btnEnable.onclick = async ()=>{
        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
          alert('Este navegador no soporta c√°mara. Usa Safari (iOS) con HTTPS.'); return;
        }
        const list = [
          { video: { facingMode: { ideal: 'environment' }}, audio:false },
          { video: { facingMode: 'environment' }, audio:false },
          { video: true, audio:false }
        ];
        let stream=null, lastErr=null;
        for (const c of list){ try{ stream=await navigator.mediaDevices.getUserMedia(c); if(stream) break; }catch(e){ lastErr=e; } }
        if(!stream){ alert('No se pudo abrir la c√°mara.\n' + (lastErr && (lastErr.name+': '+lastErr.message))); return; }
        try{
          video.setAttribute('playsinline','true'); video.muted = true; video.srcObject = stream;
          await new Promise(res=>{ if(video.readyState>=2) res(); else video.onloadedmetadata = ()=>res(); });
          await video.play(); btnEnable.textContent='C√°mara activada'; btnEnable.disabled=true; lastAction.textContent='C√°mara OK';
        }catch(e){ alert('Vista previa no pudo iniciarse.\n'+e); }
      };

      // Forzar acci√≥n
      async function triggerAction(){
        try{
          const now = Date.now();
          if(mode==='start'){
            await setDoc(eventRef, { startTS: serverTimestamp(), startClientMS: now, stopTS: null, stopClientMS: null }, { merge: true });
            lastAction.textContent = "Inicio marcado"; alert('Inicio marcado');
          }else{
            await setDoc(eventRef, { stopTS: serverTimestamp(), stopClientMS: now }, { merge: true });
            lastAction.textContent = "Fin marcado"; alert('Fin marcado');
          }
          lastErrorEl.textContent = '';
        }catch(e){
          lastErrorEl.textContent = 'Error Firestore: ' + (e && (e.code || e.message || e));
          alert('No se pudo escribir en Firestore.\n' + (e && (e.code || e.message || e)));
        }
      }
      btnForce.onclick = triggerAction;

      // Detecci√≥n b√°sica
      let prev=null, coolDown=false;
      setInterval(()=>{
        if(video.readyState<2) return;
        const w=video.videoWidth, h=video.videoHeight; if(!w||!h) return;
        canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d',{willReadFrequently:true});
        ctx.drawImage(video,0,0,w,h); const frame=ctx.getImageData(0,0,w,h);
        let moved=false;
        if(prev){
          const step=32; let diff=0, sample=0;
          for(let i=0;i<frame.data.length;i+=step){
            const d=Math.abs(frame.data[i]-prev.data[i])+Math.abs(frame.data[i+1]-prev.data[i+1])+Math.abs(frame.data[i+2]-prev.data[i+2]);
            if(d>60) diff++; sample++;
          }
          moved = (diff/Math.max(1,sample))>0.12;
        }
        prev=frame;
        if(moved && !coolDown){
          document.getElementById('overlay').style.display='block'; triggerAction();
          coolDown=true; setTimeout(()=>{ document.getElementById('overlay').style.display='none'; coolDown=false; }, 1200);
        }
      },140);
    }

    // Errores JS a pantalla
    window.addEventListener('error', (e)=>{ const el=document.getElementById('lastError'); el.textContent='JS error: ' + (e && (e.message||e.filename)); });
  </script>
</body>
</html>
